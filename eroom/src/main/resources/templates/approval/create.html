<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{include/layout}">
<head>
<style>
.custom-table td, .custom-table th {
	padding: 0.5rem !important;
	min-width: 75px;
}
.treeview-label-strong {
  font-weight: bold;
  text-decoration: underline;
  color: #007bff;
}
.treeview-row {
  pointer-events: none;
}
.treeview-text a {
  text-decoration: none !important;
    display: block;
    width: 100%;
    height: 100%;
    padding: 5px 10px;
}

.treeview-text summary::marker,
.treeview-text a::before,
.treeview-text a::after {
  display: none !important;
  content: none !important;
}
      .treeview-text {
    cursor: pointer; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë¥¼ í´ë¦­ ê°€ëŠ¥ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
  }
  
  .treeview-text:hover {
    background-color: #f0f4ff; /* í˜¸ë²„ ì‹œ ì‚´ì§ ìƒ‰ìƒ ë³€í™” */
  }
</style>
<meta charset="UTF-8">
<title>ê²°ì¬ì„œ ì‘ì„±</title>
</head>
<body>
	<main class="main" id="top" layout:fragment="content">
		<div class="container bg-white rounded shadow-sm p-4 mt-4" style="max-width: 1000px;">
			<!-- <h2 class="mb-2 mx-auto">ê²°ì¬ì„œ ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h2> -->
			<div class="d-flex justify-content-start mb-2">
				<span th:if="${mode == 'create'}" class="fw-bold fs-7" id="approvalPageTitle">ê²°ì¬ì„œ ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
				<span th:if="${mode == 'edit'}" th:text="|${approval.approval_format.approvalFormatTitle} ê²°ì¬ì„œ ì‘ì„±|" class="fw-bold fs-7" id="approvalPageTitle">ê²°ì¬ì„œ ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
			</div>
		<div class="card shadow-sm p-3 rounded-2xl mb-4">
			<!-- ê²°ì¬ form -->
			<form id="approvalWriter">
				<div class="row">
					<div class="col-5">
						<div class="mb-1">
							<label class="form-label" for="basic-form-date">ì‹ ì²­ì¼</label>
							<div id="basic-form-date" class="form-control" th:text="${now}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-department_name">ë¶€ì„œ</label>
							<div id="basic-form-department_name" class="form-control" th:text="${departmentName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-team_name">íŒ€ëª…</label>
							<div id="basic-form-team_name" class="form-control" th:text="${teamName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_position">ì§ê¸‰</label>
							<div id="basic-form-employee_position" class="form-control" th:text="${employee.employeePosition}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_name">ì‹ ì²­ì</label>
							<div id="basic-form-employee_name" class="form-control" th:text="${employee.employeeName}"></div>
						</div>
					</div>
					<div class="col-7">
						
						<label for="temp">ã€€</label>
						<div id="temp" class="gap-2 mb-3 ms-right-2 d-flex justify-content-end flex-column align-items-end">
							<!-- <span style="vertical-align: middle;">ê²°ì¬ì :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">ê²°ì¬ ë¼ì¸</div>
								<div id="approvelLineTemp1" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step >= 1].size() > 0 ? 'display: none;' : 'display: block;'}">
								    ì„ íƒëœ ê²°ì¬ìê°€ ì—†ìŠµë‹ˆë‹¤.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine1">
									<!-- ê²°ì¬ì ë¶ˆëŸ¬ì˜¤ê¸° -->
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step >= 1}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="approver" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="${approveMember.approval_line_step}">
									</span>
									<!-- <span class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span>ì˜¤ì§„ì„</span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="approver" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" value="4">
										<input type="hidden" name="approverSteps" value="1">
									</span> -->
								</div>
							</div>
							<!-- <span style="vertical-align: middle;">í•©ì˜ì :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">í•©ì˜ ë¼ì¸</div>
								<div id="approvelLineTemp2" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step == 0].size() > 0 ? 'display: none;' : 'display: block;'}">
								    ì„ íƒëœ í•©ì˜ìê°€ ì—†ìŠµë‹ˆë‹¤.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine2">
									<!-- í•©ì˜ì ë¶ˆëŸ¬ì˜¤ê¸° --><!-- 
									<div th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == 0}" class="position-relative d-inline">
										<span class="badge border text-dark d-flex justify-content-end align-items-center"
										      style="background-color: rgb(248, 249, 250);">
										    <span th:text="${approveMember.employee.employeeName}"></span>
										    <button type="button" class="btn-close" th:attr="data-idx=${stat.count}"
										            aria-label="Remove" style="scale: 0.8;" data-prefix="agreer">
										    </button>
										    <input type="hidden" name="agreerIds" th:value="${approveMember.employee.employeeNo}">
										    <input type="hidden" name="agreerSteps" th:value="0">
										</span>
									</div>	 -->	
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == 0}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="agreer" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="0">
									</span>					
								</div>
							</div>
							<!-- <span style="vertical-align: middle;">ì°¸ì¡°ì :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">ì°¸ì¡° ë¼ì¸</div>
								<div id="approvelLineTemp3" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step == -1].size() > 0 ? 'display: none;' : 'display: block;'}">
								    ì„ íƒëœ ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine3">
									<!-- í•©ì˜ì ë¶ˆëŸ¬ì˜¤ê¸° -->
									<!-- <div th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == -1}" class="position-relative d-inline">
										<span class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
											<span th:text="${approveMember.employee.employeeName}"></span>
											<button type="button" class="btn-close" th:attr="data-idx=${stat.count}"
												aria-label="Remove" style="scale: 0.8;" data-prefix="referer">
											</button>
											<input type="hidden" name="refererIds" th:value="${approveMember.employee.employeeNo}"> <input type="hidden" name="refererSteps" th:value="-1">
										</span>
									</div> -->		
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == -1}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="referer" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="-1">
									</span>										
								</div>
							</div>
						</div>
						
						<!-- ì¶”ê°€ ë²„íŠ¼ -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end" id="approveLineModalDiv">
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine1" data-target-prefix="approver">ê²°ì¬ì ì„ íƒ</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine2" data-target-prefix="agreer">í•©ì˜ì ì„ íƒ</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine3" data-target-prefix="referer">ì°¸ì¡°ì ì„ íƒ</button>
						</div>

					</div>


				</div>

				<!-- ê²°ì¬ ë‚´ìš©1(ì •ë³´) -->
				<div class="mb-3">
					<label class="form-label" for="basic-form-title">ì œëª©</label>
					<input th:if="${mode == 'create'}" class="form-control" id="basic-form-title" type="text" placeholder="ì œëª©">
					<input th:if="${mode == 'edit'}" th:value="${approval.approval_title}" class="form-control" id="basic-form-title" type="text" placeholder="ì œëª©">
					
					<label class="form-label" for="basic-select-format">ì–‘ì‹ ì„ íƒ</label>
					<!-- createì˜ ê²½ìš° + editì˜ ê²½ìš° select -->
					<select class="form-select" id="basic-select-format" aria-label="Default select example">
					  <option th:if="${mode == 'create'}" value="0" selected disabled>ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</option>
					  <option th:each="formList : ${approvalFormatList}"
					          th:value="${formList.approval_format_no}"
					          th:text="${formList.approval_format_title}"
					          th:selected="${mode == 'edit' and formList.approval_format_no == approval.approval_format.approvalFormatNo}">
					  </option>
					</select>

				</div>
				
				<!-- ê²°ì¬ ë‚´ìš©2(ë³¸ë¬¸) -->
				<div class="mb-3">
					<label class="form-label" for="basic-form-textarea">ê²°ì¬ ì‘ì„±</label>
					<div th:if="${mode == 'create'}" class="form-control" id="basic-form-edit"></div>
					<div th:if="${mode == 'edit'}" th:utext="${approval.approval_format.approvalFormatContent}" class="form-control" id="basic-form-edit"></div>
				</div>
				<!-- ê²°ì¬ ë‚´ìš©3(ê¸°ì¡´ ì²¨ë¶€íŒŒì¼) -->
				<div class="mb-3" th:if="${mode == 'edit'}">
					<label for="lastFiles" class="form-label">ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼</label>
					<div class="form-control" id="lastFiles">
						<ul style="margin-bottom: 0;" class="ps-3">
							<li th:each="approvalAttachFile : ${driveList}">
								<a th:href="@{'/drive/download/approval/' + ${approvalAttachFile.driveAttachNo}}" th:text="${approvalAttachFile.driveOriName}" class="text-primary text-decoration-underline" onmouseover="this.style.textDecoration='none'" onmouseout="this.style.textDecoration='underline'">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
								</a>
								<input type="hidden" name="approvalAttachFileIds" th:value="${approvalAttachFile.driveAttachNo}">
								<!-- ì‚­ì œ ë±ƒì§€ ë„£ì„ ê³³ -->
							    <span class="badge bg-danger ms-1" style="cursor: pointer;" onclick="removeFile(this)">
							      X
							    </span>
								<!-- ì‚­ì œ ë±ƒì§€ ë„£ì„ ê³³ -->
							</li>
							<li th:if="${#lists.isEmpty(driveList)}" class="text-muted">ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
						</ul>
					</div>
				</div>
				<!-- ê²°ì¬ ë‚´ìš©3(íŒŒì¼ ì—…ë¡œë“œ) -->
				<div class="mb-3">
					<label class="form-label">íŒŒì¼ ì—…ë¡œë“œ</label> <input id="approvalAttachFiles" class="form-control" type="file" multiple>
				</div>
				<div class="d-flex justify-content-end">
					<button type="button" class="btn btn-light" onclick="history.back()">ì·¨ì†Œ</button>
					<button id="approvalSubmitBtn" class="btn btn-primary ms-2" type="button">ë“±ë¡</button>
				</div>
			</form>
			
			
		</div>
		</div>
		
		<!-- ê²°ì¬ì ìƒì„± ëª¨ë‹¬ -->
      
      
      <!-- íŠ¸ë¦¬êµ¬ì¡°ì‹œì‘ -->
<div class="modal fade" id="selectApproveLineModal" tabindex="-1" aria-hidden="true" aria-labelledby="selectApproveLineModalLabel" data-bs-focus="false">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 550px; height: 400px;">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="treeModalLabel">ì¡°ì§ë„ ì„ íƒ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>

      <div class="modal-body px-4" style="height: 400px; overflow-y: auto;">
<div class="row" style="height: 100%;">
<div class="col-6">
<ul class="treeview" id="treeviewTree">
  <li class="treeview-list-item">
    <p class="treeview-text">
      <input type="checkbox" class="form-check-input me-2 root-checkbox" data-name="ì´ë£¸ ì»´í¼ë‹ˆ" data-type="company" data-no="root" onchange="handleCheck(this)">
      <a href="javascript:void(0);"  data-bs-target="#tree-company" >
        <span class="fa-solid fa-folder treeview-icon text-info-light"></span>
        <span id="eroomCompanySpan" class="treeview-label-text fw-bold treeview-label-strong">ì´ë£¸ ì»´í¼ë‹ˆ</span>
      </a>
    </p>
    <ul class="collapse show treeview-list" id="tree-company">
      <li class="treeview-list-item" th:each="dept : ${departmentList}">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2 dept-checkbox" data-type="department" th:attr="data-name=${dept.codeName}, data-no=${dept.separatorCode}" onchange="handleCheck(this)">
          <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#dept-'+${dept.separatorCode}">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text" th:text="${dept.codeName}">ë¶€ì„œëª…</span>
          </a>
        </p>
        <ul class="collapse treeview-list" th:id="'dept-'+${dept.separatorCode}">
          <li class="treeview-list-item" th:each="team : ${teamMap[dept.codeName]}">
            <p class="treeview-text ms-3">
              <input type="checkbox" class="form-check-input me-2 team-checkbox" data-type="team" th:attr="data-name=${team.codeName}, data-no=${team.separatorCode}" onchange="handleCheck(this)">
              <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#team-'+${team.separatorCode}">
                <span class="fa-solid fa-file-lines treeview-icon"></span>
                <span class="treeview-label-text" th:text="${team.codeName}">íŒ€ëª…</span>
              </a>
            </p>
            <ul class="collapse treeview-list" th:id="'team-'+${team.separatorCode}">
              <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap[team.separatorCode]}">
                <p class="treeview-text ms-4">
                  <input type="checkbox" class="form-check-input me-2 emp-checkbox" data-type="employee" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
                  <span class="fa-solid fa-user treeview-icon"></span>
                  <span class="treeview-label-text" th:text="${emp.employee_name}">ì‚¬ì›ëª…</span>
                </p>
              </li>
            </ul>
          </li>
          	<!-- ë¶€ì„œëŠ” ìˆì§€ë§Œ íŒ€ ì—†ëŠ” ì‚¬ëŒ -->
			<li class="treeview-list-item" 
			    th:each="emp : ${teamEmployeeMap[dept.separatorCode + '_notAssigned']}">
			  <p class="treeview-text ms-3"> <!-- â† ms-4 ì—ì„œ ms-3ìœ¼ë¡œ ë§ì¶°ì¤Œ -->
			    <input type="checkbox" class="form-check-input me-2 emp-checkbox" data-type="employee"
			           th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}"
			           onchange="handleCheck(this)">
			    <span class="fa-solid fa-user treeview-icon"></span>
			    <span class="treeview-label-text" th:text="${emp.employee_name}">ì‚¬ì›ëª…</span>
			  </p>
			</li>
        </ul>
      </li>
      <!-- <li class="treeview-list-item">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2" data-name="ë¬´ì†Œì†" data-no="noTeam" onchange="handleCheck(this)">
          <a href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#noTeam">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text">ë¬´ì†Œì†</span>
          </a>
        </p>
        <ul class="collapse treeview-list" id="noTeam">
          <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap['noTeam']}">
            <p class="treeview-text ms-4">
              <input type="checkbox" class="form-check-input me-2 emp-checkbox" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
              <span class="fa-solid fa-user treeview-icon"></span>
              <span class="treeview-label-text" th:text="${emp.employee_name}">ì‚¬ì›ëª…</span>
            </p>
          </li>
        </ul>
      </li> -->
    </ul>
  </li>
</ul>
</div>

<div class="col-6 d-flex flex-column">
  <!-- [1] ìƒë‹¨ ê³ ì • ì˜ì—­ -->
  <div id="selectedResult"
       class="border bg-white rounded p-2 mb-2 small"
       style="position: sticky; top: 0; z-index: 2; background-color: white; ">
    <strong>ì„ íƒí•œ í•­ëª©:</strong>
    <div style="overflow-y: auto; max-height: 270px;" id="selectedTags" class="mt-1 flex-wrap gap-2"></div>
  </div>

  <!-- [2] ì¤‘ê°„: ë¹ˆ ì˜ì—­ (ìŠ¤í¬ë¡¤ ì—¬ìœ ) -->
  <div class="flex-grow-1"></div>

  <!-- [3] í•˜ë‹¨ ê³ ì • ì˜ì—­ -->
  <div class="text-end"
       style="position: sticky; bottom: 0; z-index: 2; background-color: white;">
    <button id="clearBtn" class="btn btn-light btn-sm" type="button">ë¹„ìš°ê¸°</button>
  </div>
</div>


</div>
      </div>

      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </div>
  </div>
</div>
<!-- íŠ¸ë¦¬êµ¬ì¡°ë -->
      
      
      
      <!-- í•©ì˜ì ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="selectApproveLine2Modal" tabindex="-1"
  aria-labelledby="selectApproveLine2ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>í•©ì˜ì ì¶”ê°€</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="ë‹«ê¸°"></button>
      </div>
      <form id="createApprovalLineForm2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ì†Œì†</label>
            <select class="form-select" id="agreer-departmentSelect">
              <option disabled selected>-- ì†Œì† ì„ íƒ --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ì°¸ì—¬ì ì„ íƒ</label>
            <div class="d-flex">
              <select id="agreer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- ì°¸ì—¬ì ì„ íƒ --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" data-action="addParticipant">ì¶”ê°€</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">ì„ íƒëœ ì°¸ì—¬ì</label>
            <div id="agreer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
      
      <!-- ì°¸ì¡°ì ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="selectApproveLine3Modal" tabindex="-1"
  aria-labelledby="selectApproveLine3ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ì°¸ì¡°ì ì¶”ê°€</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="ë‹«ê¸°"></button>
      </div>
      <form id="createApprovalLineForm3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ì†Œì†</label>
            <select class="form-select" id="referer-departmentSelect" >
              <option disabled selected>-- ì†Œì† ì„ íƒ --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ì°¸ì—¬ì ì„ íƒ</label>
            <div class="d-flex">
              <select id="referer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- ì°¸ì—¬ì ì„ íƒ --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" data-action="addParticipant">ì¶”ê°€</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">ì„ íƒëœ ì°¸ì—¬ì</label>
            <div id="referer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
		
		
		
		
	<!-- ê²°ì¬ì„œ ì–‘ì‹ ì„ íƒì‹œ + í•´ë‹¹ í˜ì´ì§€ ì§„ì…ì‹œ, fetchë¡œ ê²°ì¬ì„œ ì–‘ì‹ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° -->
	<script th:inline="javascript">
	  function loadApprovalFormat() {
	    const select = document.getElementById("basic-select-format");
	    const selectedValue = select.value;
	    const edit_approval_no = /*[[${approval?.approval_no}]]*/ null;
		
	    fetch("/approval/format", {
	      method: 'POST',
	      headers: {
	        'Content-Type': 'application/json',
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	        'header': document.querySelector('meta[name="_csrf_header"]').content
	      },
	      body: JSON.stringify({
	        approval_format_no: selectedValue,
	        edit_approval_no: edit_approval_no
	      })
	    })
	    .then(response => response.json())
	    .then(data => {
	      if (data.res_code == "200") {
	        document.getElementById("basic-form-edit").innerHTML = data.approvalFormatContent;
	        document.getElementById("approvalPageTitle").innerText = data.approvalFormatTitle + ' ê²°ì¬ì„œ ì‘ì„±';
	
	        const mode = data.mode;
	        const approvalContent = data.approvalContent;
	
/* 	        if (mode === 'edit' && approvalContent) {
	          setTimeout(() => {
	            for (const key in approvalContent) {
	              const inputField = document.querySelector(`#basic-form-edit [name="${key}"]`);
	              if (inputField) {
	                inputField.value = approvalContent[key];
	              }
	            }
	            
	          }, 0); */
	          if (mode === 'edit' && approvalContent) {
	        	  setTimeout(() => {
	        	    for (const key in approvalContent) {
	        	      const inputFields = document.querySelectorAll(`#basic-form-edit [name="${key}"]`);

	        	      inputFields.forEach((inputField) => {
	        	        if (inputField.type === "radio" || inputField.type === "checkbox") {
	        	          
	        	          // ì²´í¬ë°•ìŠ¤ì¸ ê²½ìš° ë°°ì—´ë¡œ ì „ë‹¬ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬í•´ì•¼ í•¨
	        	          if (Array.isArray(approvalContent[key])) {
	        	            if (approvalContent[key].includes(inputField.value)) {
	        	              inputField.checked = true;
	        	            }
	        	          } else {
	        	            // ì¼ë°˜ ë¼ë””ì˜¤ ë²„íŠ¼ì²˜ëŸ¼ ë‹¨ì¼ ê°’ì¸ ê²½ìš°
	        	            if (inputField.value === approvalContent[key]) {
	        	              inputField.checked = true;
	        	            }
	        	          }

	        	        } else {
	        	          // ì¼ë°˜ inputì¼ ê²½ìš°
	        	          inputField.value = approvalContent[key];
	        	        }
	        	      });
	        	    }
	        	  }, 0);
	        	}
	        
	        

			const selectedFormValue = document.getElementById("basic-select-format").value;
			if(selectedFormValue == '5') {
				const dateInput = document.querySelector('[name="issuedDate"]');
				if(dateInput){
				const today = new Date().toISOString().split('T')[0];
				dateInput.value = today;
				}
			}
	        
	        
	        
	      } else {
	        // alert("ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	      }
	    });
	    

	    
	  }
	
	  // í˜ì´ì§€ ë¡œë“œì‹œ + ì–‘ì‹ ì„ íƒì‹œ ê°ê° ì‹¤í–‰
	  document.addEventListener('DOMContentLoaded', loadApprovalFormat);
	  document.getElementById("basic-select-format").addEventListener("change", loadApprovalFormat);
	</script>


	
	<!-- ê²°ì¬ì ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ -->
<!-- íŠ¸ë¦¬êµ¬ì¡° JS -->
<script>
// 1ì°¨ ë¡œì§
/* let targetDiv = null;
let targetPrefix = null;
document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
	  
    targetDiv = this.dataset.targetDiv; // data-target-div ê°’ ì¶”ì¶œ
    targetPrefix = this.dataset.targetPrefix; // data-target-prefix ê°’ ì¶”ì¶œ
    resetTree(); // ëª¨ë‹¬ ì§„ì…ì‹œ ì´ˆê¸°í™”
	
    // ê²°ì¬ì, í•©ì˜ì, ì°¸ì¡°ì ê°ê°ì˜ ID ê°€ì ¸ì˜¤ê¸°
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));
      
      
    // ëª¨ë‹¬ ì§„ì… ì‹œ íšŒì‚¬/ë¶€ì„œ/íŒ€ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€ ì²˜ë¦¬
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      
      // ê²°ì¬ì, í•©ì˜ì, ì°¸ì¡°ì ê²¹ì¹˜ë©´ visible hidden
      const id = checkbox.getAttribute('data-no');
      	// ì¡°ê±´ 1: ê²°ì¬ì ëª¨ë‹¬ì¸ë° í•©ì˜ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // ì¡°ê±´ 2: í•©ì˜ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
        else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // ì¡°ê±´ 3: ì°¸ì¡°ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ í•©ì˜ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
        else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // ì¡°ê±´ 4: ê²°ì¬ìë‚˜ í•©ì˜ìì¸ ê²½ìš° íšŒì‚¬/ë¶€ì„œ/íŒ€ì€ ìˆ¨ê¹€ ì²˜ë¦¬
        else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
          checkbox.style.visibility = 'hidden';
        } 
        else {
          checkbox.style.visibility = 'visible';
        }
    });
    
  });
}); */

// 2ì°¨ ë¡œì§(ê²°ì¬ì,í•©ì˜ì ì„ íƒì‹œ ì°¸ì¡°ìì—ì„œ ì²´í¬ë°•ìŠ¤ ì•ˆë³´ì´ê²Œ)
/* let targetDiv = null;
let targetPrefix = null;

document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
    
    targetDiv = this.dataset.targetDiv; // data-target-div ê°’ ì¶”ì¶œ
    targetPrefix = this.dataset.targetPrefix; // data-target-prefix ê°’ ì¶”ì¶œ
    resetTree(); // ëª¨ë‹¬ ì§„ì…ì‹œ ì´ˆê¸°í™”

    // ê²°ì¬ì, í•©ì˜ì, ì°¸ì¡°ì ê°ê°ì˜ ID ê°€ì ¸ì˜¤ê¸°
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

    // console.log("[ë””ë²„ê·¸] ëª¨ë‹¬ ì—´ë¦´ ë•Œ ì •ë³´ ë¡œë”©");
    // console.log("ê²°ì¬ì ëª©ë¡: ", Array.from(approverIds));
    // console.log("í•©ì˜ì ëª©ë¡: ", Array.from(agreerIds));
    // console.log("ì°¸ì¡°ì ëª©ë¡: ", Array.from(refererIds));

    // ëª¨ë‹¬ ì§„ì… ì‹œ íšŒì‚¬/ë¶€ì„œ/íŒ€ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€ ì²˜ë¦¬
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      const id = checkbox.getAttribute('data-no');

      // console.log(`[ë””ë²„ê·¸] ì²´í¬ë°•ìŠ¤ íƒìƒ‰ ì¤‘: ${id} (${type})`);

      // ì¡°ê±´ 1: ê²°ì¬ì ëª¨ë‹¬ì¸ë° í•©ì˜ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[ìˆ¨ê¹€ ì²˜ë¦¬] ê²°ì¬ì ëª¨ë‹¬ - ì´ë¯¸ í•©ì˜ì ë˜ëŠ” ì°¸ì¡°ìì— ìˆìŒ: ${id}`);
      } 
      // ì¡°ê±´ 2: í•©ì˜ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[ìˆ¨ê¹€ ì²˜ë¦¬] í•©ì˜ì ëª¨ë‹¬ - ì´ë¯¸ ê²°ì¬ì ë˜ëŠ” ì°¸ì¡°ìì— ìˆìŒ: ${id}`);
      } 
      // ì¡°ê±´ 3: ì°¸ì¡°ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ í•©ì˜ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[ìˆ¨ê¹€ ì²˜ë¦¬] ì°¸ì¡°ì ëª¨ë‹¬ - ì´ë¯¸ ê²°ì¬ì ë˜ëŠ” í•©ì˜ìì— ìˆìŒ: ${id}`);
      } 
      // ì¡°ê±´ 4: ê²°ì¬ìë‚˜ í•©ì˜ìì¸ ê²½ìš° íšŒì‚¬/ë¶€ì„œ/íŒ€ì€ ìˆ¨ê¹€ ì²˜ë¦¬
      else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
          checkbox.style.visibility = 'hidden';
       // console.log(`[ìˆ¨ê¹€ ì²˜ë¦¬] íšŒì‚¬/ë¶€ì„œ/íŒ€ - ê²°ì¬ì ë˜ëŠ” í•©ì˜ìëŠ” ì§ì›ë§Œ ì„ íƒ ê°€ëŠ¥: ${id}`);
      } 
      else {
          checkbox.style.visibility = 'visible';
       // console.log(`[ë³´ì„ ì²˜ë¦¬] ì„ íƒ ê°€ëŠ¥: ${id}`);
      }
    });

    // ìƒìœ„ ì¡°ì§ì´ ì°¸ì¡°ìë¡œ ë“¤ì–´ê°”ìœ¼ë©´ í•˜ìœ„ ì§ì› ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
    // console.log("==== ì°¸ì¡°ì íŠ¸ë¦¬ ë””ë²„ê·¸ ì‹œì‘ ====");
    refererIds.forEach(refId => {
    	// console.log(`ìƒìœ„ ì¡°ì§ ID: ${refId}`);
      
      const parentNode = document.querySelector(`input[data-no="${refId}"]`);
   // console.log("ì°¾ì€ ìƒìœ„ ì¡°ì§ ë…¸ë“œ:", parentNode);

      if (parentNode) {
        const childNodes = parentNode.closest('li').querySelectorAll('input[data-type="employee"]');
     // console.log("ì°¾ì€ í•˜ìœ„ ì§ì›ë“¤:");
        childNodes.forEach(child => console.log("->", child.getAttribute('data-no')));

        childNodes.forEach(child => {
          child.style.display = 'none';
       // console.log(`ìˆ¨ê¹€ ì²˜ë¦¬ëœ ì§ì›: ${child.getAttribute('data-no')}`);
        });
      }
    });
 // console.log("==== ì°¸ì¡°ì íŠ¸ë¦¬ ë””ë²„ê·¸ ì¢…ë£Œ ====");
  });
}); */
// 3ì°¨ ë¡œì§(ê²°ì¬,í•©ì˜ ì„ íƒëœ ê²½ìš° ì°¸ì¡°ì—ì„œ ìƒìœ„ ë¶€ì„œ ìˆ¨ê¸°ê¸°)
/* let targetDiv = null;
let targetPrefix = null;

document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
    targetDiv = this.dataset.targetDiv;
    targetPrefix = this.dataset.targetPrefix;
    resetTree(); // ëª¨ë‹¬ ì§„ì…ì‹œ ì´ˆê¸°í™”
    
    // 1. ê²°ì¬ì, í•©ì˜ì, ì°¸ì¡°ì ê°ê°ì˜ ID ê°€ì ¸ì˜¤ê¸°
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

    console.log("í˜„ì¬ ì„ íƒëœ ê²°ì¬ì ëª©ë¡:", approverIds);
    console.log("í˜„ì¬ ì„ íƒëœ í•©ì˜ì ëª©ë¡:", agreerIds);
    console.log("í˜„ì¬ ì„ íƒëœ ì°¸ì¡°ì ëª©ë¡:", refererIds);

    // 2. íŠ¸ë¦¬ì˜ ëª¨ë“  ì²´í¬ë°•ìŠ¤ íƒìƒ‰
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      const id = checkbox.getAttribute('data-no');

      // ì¡°ê±´ 1: ê²°ì¬ì ëª¨ë‹¬ì¸ë° í•©ì˜ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // ì¡°ê±´ 2: í•©ì˜ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ ì°¸ì¡°ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // ì¡°ê±´ 3: ì°¸ì¡°ì ëª¨ë‹¬ì¸ë° ê²°ì¬ìë‚˜ í•©ì˜ìì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš°
      else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // ì¡°ê±´ 4: ê²°ì¬ìë‚˜ í•©ì˜ìì¸ ê²½ìš° íšŒì‚¬/ë¶€ì„œ/íŒ€ì€ ìˆ¨ê¹€ ì²˜ë¦¬
      else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
        checkbox.style.visibility = 'hidden';
      } 
      else {
        checkbox.style.visibility = 'visible';
      }
    });

    // 3. ìƒìœ„ ì¡°ì§ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
    console.log("ìƒìœ„ ì¡°ì§ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°");

    // ì„ íƒëœ í•©ì˜ìì™€ ê²°ì¬ìì— ëŒ€í•´ ìƒìœ„ ì¡°ì§ ìˆ¨ê¸°ê¸°
    [...agreerIds, ...approverIds].forEach(id => {
      console.log(`ì„ íƒëœ ì§ì› ID íƒìƒ‰: ${id}`);
      const employeeCheckbox = document.querySelector(`input[data-no="${id}"]`);
      if (employeeCheckbox) {
        let parentLi = employeeCheckbox.closest('li.treeview-list-item');
        while (parentLi) {
          const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="department"], :scope > .treeview-text input[data-type="team"]');
          
          if (parentCheckbox) {
            console.log(`ìˆ¨ê¹€ ì²˜ë¦¬ëœ ìƒìœ„ ì¡°ì§: ${parentCheckbox.getAttribute('data-no')}`);
            parentCheckbox.style.visibility = 'hidden';
          }
          
          // ìµœìƒìœ„ "ì´ë£¸ ì»´í¼ë‹ˆ" ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
          const companyCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="company"]');
          if (companyCheckbox) {
            console.log("ìµœìƒìœ„ ì´ë£¸ ì»´í¼ë‹ˆ ìˆ¨ê¹€ ì²˜ë¦¬");
            companyCheckbox.style.visibility = 'hidden';
          }
          
          parentLi = parentLi.parentElement.closest('li.treeview-list-item');
        }
      }
    });

  });
}); */
// 4ì°¨ ë¡œì§(ê²°ì¬,í•©ì˜ ì„ íƒëœ ê²½ìš° ì°¸ì¡°ì—ì„œ ìƒìœ„ ë¶€ì„œ ìˆ¨ê¸°ê¸° + ìƒìœ„ ë¶€ì„œ ì°¸ì¡° ë„£ìœ¼ë©´ ê²°ì¬,í•©ì˜ì— ì§ì›ë“¤ ì²´í¬ë°•ìŠ¤ ì•ˆë³´ì´ê²Œ)
let targetDiv = null;
let targetPrefix = null;
document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
	  button.addEventListener('click', function() {
		// console.clear(); // ì½˜ì†” ì •ë¦¬
	    // console.log("ëª¨ë‹¬ ì—´ë¦¼ - Target Prefix:", targetPrefix);
	    targetDiv = this.dataset.targetDiv;
	    targetPrefix = this.dataset.targetPrefix;
	    resetTree();

	    // ê²°ì¬ì, í•©ì˜ì, ì°¸ì¡°ì ê°ê°ì˜ ID ê°€ì ¸ì˜¤ê¸°
	    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
	    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
	    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

	 	// console.log("Approver IDs:", [...approverIds]);
	    // console.log("Agreer IDs:", [...agreerIds]);
	    // console.log("Referer IDs:", [...refererIds]);

	    // ëª¨ë‹¬ ì§„ì… ì‹œ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€ ì²˜ë¦¬
	    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
	    checkboxes.forEach(checkbox => {
	      const id = checkbox.getAttribute('data-no');
	      const type = checkbox.getAttribute('data-type');

	   // console.log(`ğŸ” ì²´í¬ë°•ìŠ¤ íƒìƒ‰ ì¤‘... ID: ${id}, Type: ${type}`);
	      
	      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
	    	// console.log(`[HIDE] ê²°ì¬ì ëª¨ë‹¬ - ìˆ¨ê¹€ ì²˜ë¦¬ëœ ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
	    	// console.log(`[HIDE] í•©ì˜ì ëª¨ë‹¬ - ìˆ¨ê¹€ ì²˜ë¦¬ëœ ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
	    	// console.log(`[HIDE] ì°¸ì¡°ì ëª¨ë‹¬ - ìˆ¨ê¹€ ì²˜ë¦¬ëœ ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
	    	// console.log(`[HIDE] íšŒì‚¬/ë¶€ì„œ/íŒ€ ìˆ¨ê¹€ ì²˜ë¦¬ëœ ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else {
	    	// console.log(`[SHOW] ë³´ì´ëŠ” ID: ${id}`);
	        checkbox.style.visibility = 'visible';
	      }
	    });

	 // ì°¸ì¡°ìë¡œ ì„ íƒëœ ìƒìœ„ ì¡°ì§ì˜ í•˜ìœ„ ì§ì› ìˆ¨ê¸°ê¸°
	    if (targetPrefix !== 'referer') {
	      refererIds.forEach(id => {
	        const parentCheckbox = document.querySelector(`input[data-no="${id}"]`);
	     // console.log("ì°¸ì¡°ìë¡œ ì„ íƒëœ ì¡°ì§ íƒìƒ‰ ID:", id);

	        if (parentCheckbox) {
	        	// console.log("ì°¸ì¡°ìë¡œ ì„ íƒëœ ì¡°ì§ ë°œê²¬:", id);
	          const parentNode = parentCheckbox.closest('li.treeview-list-item');

	          if (parentNode) {
	            // ëª¨ë“  í•˜ìœ„ treeview-list-itemì˜ employee íƒ€ì… ì²´í¬ë°•ìŠ¤ íƒìƒ‰ (ê¹Šì´ íƒìƒ‰ìœ¼ë¡œ ìˆ˜ì •)
	            const childCheckboxes = parentNode.querySelectorAll('input[data-type="employee"]'); // ë” ê¹Šì´ íƒìƒ‰
	            // const childCheckboxes = parentNode.querySelectorAll('li.treeview-list-item input[data-type="employee"]');
	         // console.log("í•˜ìœ„ ì§ì› íƒìƒ‰ ì™„ë£Œ:", childCheckboxes);

	            if (childCheckboxes.length > 0) {
	            	// console.log(`í•˜ìœ„ ì§ì› ${childCheckboxes.length}ëª… ë°œê²¬`);
	            } else {
	            	// console.log("í•˜ìœ„ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.");
	            }

	            childCheckboxes.forEach(child => {
	            	// console.log(`[HIDE] ì°¸ì¡°ì ìƒìœ„ ì„ íƒì— ë”°ë¥¸ í•˜ìœ„ ìˆ¨ê¹€: ${child.getAttribute('data-no')}`);
	              child.style.visibility = 'hidden';

	              // í˜¹ì‹œ visibilityê°€ ì•ˆ ë¨¹ìœ¼ë©´ displayë¡œ ì „í™˜
	              if (child.style.visibility !== 'hidden') {
	                child.style.display = 'none';
	              }
	            });
	          }
	        }
	      });
	    } else{
	    	// elseë¬¸ì´ ì œì¼ ë‚˜ì¤‘ì— ì¶”ê°€í•œ ê³³!!! ì˜¤ë¥˜ ìƒê¸°ë©´ ì—¬ê¸°ë¶€í„° ì˜ì‹¬í•˜ê¸°!!!!
	    	const checkBoxTemp = document.querySelector('input[data-no="root"]');
	    	if(checkBoxTemp){
	    		checkBoxTemp.style.visibility = 'hidden';
	    	}
	    }
	    [...agreerIds, ...approverIds].forEach(id => {
	    	// console.log(`ì„ íƒëœ ì§ì› ID íƒìƒ‰: ${id}`);
	        const employeeCheckbox = document.querySelector(`input[data-no="${id}"]`);
	        if (employeeCheckbox) {
	          let parentLi = employeeCheckbox.closest('li.treeview-list-item');
	          while (parentLi) {
	            const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="department"], :scope > .treeview-text input[data-type="team"]');
	            
	            if (parentCheckbox) {
	            	// console.log(`ìˆ¨ê¹€ ì²˜ë¦¬ëœ ìƒìœ„ ì¡°ì§: ${parentCheckbox.getAttribute('data-no')}`);
	              parentCheckbox.style.visibility = 'hidden';
	            }
	            
	            // ìµœìƒìœ„ "ì´ë£¸ ì»´í¼ë‹ˆ" ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
	            const companyCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="company"]');
	            if (companyCheckbox) {
	            	// console.log("ìµœìƒìœ„ ì´ë£¸ ì»´í¼ë‹ˆ ìˆ¨ê¹€ ì²˜ë¦¬");
	              companyCheckbox.style.visibility = 'hidden';
	            }
	            
	            parentLi = parentLi.parentElement.closest('li.treeview-list-item');
	          }
	        }
	      });




	  });
	});








function handleCheck(checkbox) {
  const name = checkbox.getAttribute('data-name');
  const code = checkbox.getAttribute('data-no');
  const type = checkbox.getAttribute('data-type');
  const li = checkbox.closest('li.treeview-list-item');

  // ê²°ì¬ì, í•©ì˜ìì¸ ê²½ìš° íŒ€/ë¶€ì„œ/íšŒì‚¬ ì„ íƒ ë¶ˆê°€
  if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
    alert('ê²°ì¬ìì™€ í•©ì˜ìëŠ” ì‚¬ì›ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    checkbox.checked = false;
    return;
  }

  // ìµœëŒ€ 5ëª… ì œí•œ ì²´í¬
  const selectedCount = document.querySelectorAll('#selectedTags div').length;
  if (selectedCount >= 5 && checkbox.checked && (targetPrefix === 'approver' || targetPrefix === 'agreer')) {
    checkbox.checked = false;
    return;
  }
  
  
  if (checkbox.checked) {
    addTag(name, code);
    handleHighlight(li);
  } else {
    removeTag(code);
  }

  updateChildren(checkbox, checkbox.checked);
  updateParents(checkbox);
}

function updateChildren(checkbox, isChecked) {
	  const li = checkbox.closest('li.treeview-list-item');
	  if (!li) return;

	  const descendants = li.querySelectorAll('input[type="checkbox"]');
	  descendants.forEach(child => {
	    if (child !== checkbox) {
	      child.checked = isChecked;

	      // í•˜ìœ„ íƒœê·¸ ì œê±° (ìƒìœ„ í´ë¦­ ì‹œ ê¸°ì¡´ í•˜ìœ„ íƒœê·¸ ë‚¨ëŠ” ë¬¸ì œ í•´ê²°)
	      const code = child.getAttribute('data-no');
	      removeTag(code);
	    }
	  });
	}


function updateParents(checkbox) {
	  let li = checkbox.closest('li.treeview-list-item');

	  while (li) {
	    const parentLi = li.parentElement.closest('li.treeview-list-item');
	    if (!parentLi) break;

	    const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[type="checkbox"]');
	    const childCheckboxes = Array.from(parentLi.querySelectorAll(':scope > ul > li.treeview-list-item > .treeview-text input[type="checkbox"]'));

	    const allChecked = childCheckboxes.length > 0 && childCheckboxes.every(cb => cb.checked);
	    const someChecked = childCheckboxes.some(cb => cb.checked);

	    if (parentCheckbox) {
	      if (allChecked && (targetPrefix === 'referer')) {
			// í•˜ìœ„ ì²´í¬ëœ ë…¸ë“œë“¤ ì¤‘ 'employee'ë§Œ í•„í„°ë§
			const employeeNodes = childCheckboxes.filter(cb => cb.getAttribute('data-type') === 'employee');
			
			// íŒ€ì› ìˆ˜ê°€ 5ëª… ì´í•˜ì´ë©´ ìƒìœ„ ì²´í¬ë¥¼ ë§‰ëŠ”ë‹¤.
			/* if (employeeNodes.length <= 5 && ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee')) {
			  parentCheckbox.checked = false;
			  return;
			} */
			
			// íŒ€ì› ìˆ˜ê°€ 5ëª… ì´ˆê³¼ì¼ ë•Œë§Œ ìƒìœ„ ì²´í¬
			parentCheckbox.checked = true;

	        // ìƒìœ„ë§Œ tag
	        const pname = parentCheckbox.getAttribute('data-name');
	        const pcode = parentCheckbox.getAttribute('data-no');
	        addTag(pname, pcode);

	        // í•˜ìœ„ tag ì œê±°
	        childCheckboxes.forEach(cb => removeTag(cb.getAttribute('data-no')));

	      } else if (someChecked) {
	        parentCheckbox.checked = false;

	        // ìƒìœ„ tag ì œê±°
	        const pcode = parentCheckbox.getAttribute('data-no');
	        removeTag(pcode);

	        // í•˜ìœ„ ì¤‘ ì²´í¬ëœ ê²ƒë§Œ tag ì¶”ê°€
	        childCheckboxes.forEach(cb => {
	          const cname = cb.getAttribute('data-name');
	          const ccode = cb.getAttribute('data-no');
	          if (cb.checked) addTag(cname, ccode);
	          else removeTag(ccode);
	        });

	      } else {
	        parentCheckbox.checked = false;

	        // ì „ë¶€ ì œê±°
	        const pcode = parentCheckbox.getAttribute('data-no');
	        removeTag(pcode);
	      }
	    }

	    li = parentLi;
	  }
	}



/* function addTag(label, code) {
  const tagWrap = document.getElementById("selectedTags");
  if (document.getElementById(`tag-${code}`)) return;

  const tag = document.createElement("span");
  tag.className = "badge bg-primary text-white d-flex align-items-center";
  tag.id = `tag-${code}`;
  tag.name = `tag-${label}`;
  tag.innerHTML = `${label} <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="removeTag('${code}', true)"></button>`;
  tagWrap.appendChild(tag);
}

	function removeTag(code, skipCheckbox = false) {
	  const tag = document.getElementById(`tag-${code}`);
	  if (tag) tag.remove();

	  if (!skipCheckbox) return;

	  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
	  if (checkbox && checkbox.checked) {
	    checkbox.checked = false;
	    handleCheck(checkbox); // ì—°ì‡„ ë™ê¸°í™”
	  }
	} */
	
	function addTag(label, code) {
		  const tagWrap = document.getElementById("selectedTags");
		  if (document.getElementById(`tag-${code}`)) return;

		  // Card ìƒì„±
		  const card = document.createElement("div");
		  card.className = "card mb-2"; // ì—¬ê¸°ì„œ flexëŠ” ì œê±°ë¨
		  card.id = `tag-${code}`;
		  card.name = `tag-${label}`;
		  card.style.borderRadius = "5px";
		  card.style.padding = "8px";
		  card.style.backgroundColor = "#f8f9fa";
		  card.style.display = "block"; // í•œ ì¤„ì”© í‘œì‹œ

		  // ì´ë¦„ ë¼ë²¨
		  const labelElement = document.createElement("span");
		  labelElement.textContent = label;
		  card.appendChild(labelElement);

		  // ì‚­ì œ ë²„íŠ¼
		  const button = document.createElement("button");
		  button.type = "button";
		  button.className = "btn-close";
		  button.style.float = "right"; // ì˜¤ë¥¸ìª½ ì •ë ¬
		  button.setAttribute("aria-label", "Remove");
		  button.addEventListener("click", () => {
		    card.remove();
		    removeTag(code, true);  // íƒœê·¸ ì‚­ì œ ì‹œ ì²´í¬ë°•ìŠ¤ë„ í•´ì œ
		  });

		  card.appendChild(button);

		  // Cardë¥¼ ì„ íƒëœ íƒœê·¸ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
		  tagWrap.appendChild(card);
		}

	
	function removeTag(code, skipCheckbox = false) {
		  const tag = document.getElementById(`tag-${code}`);
		  if (tag) tag.remove();

		  if (!skipCheckbox) return;

		  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
		  if (checkbox && checkbox.checked) {
		    checkbox.checked = false;
		    handleCheck(checkbox); // ì—°ì‡„ ë™ê¸°í™”
		  }
		}




function confirmSelection() {
  const selected = document.querySelectorAll("#selectedTags .card");
  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë±ƒì§€ ë° íˆë“  ì¸í’‹ ì´ˆê¸°í™”
  const targetContainer = document.getElementById(targetDiv);
  targetContainer.innerHTML = "";
  const element1 = document.getElementById("approvelLineTemp1");
  const element2 = document.getElementById("approvelLineTemp2");
  const element3 = document.getElementById("approvelLineTemp3");
	if (selected.length !== 0) {
	  if (targetPrefix === 'approver' && element1) {
	    element1.style.display = 'none';
	  } else if (targetPrefix === 'agreer' && element2) {
	    element2.style.display = 'none';
	  } else if (targetPrefix === 'referer' && element3) {
	    element3.style.display = 'none';
	  }
	} else{
	  if (targetPrefix === 'approver' && element1) {
	    element1.style.display = 'block';
	  } else if (targetPrefix === 'agreer' && element2) {
	    element2.style.display = 'block';
	  } else if (targetPrefix === 'referer' && element3) {
	    element3.style.display = 'block';
	  }
	}
  
  const resultCodeAndNum = Array.from(selected).map(el => el.id.replace('tag-', ''));
  const resultName = Array.from(selected).map(el => el.name.replace('tag-', ''));
  const result = Array.from(selected).map((el, index) => ({
	    code: el.id.replace('tag-', ''),
	    name: el.name.replace('tag-', ''),
	    step: index + 1 // ìˆœì„œë¥¼ ì¶”ê°€
  }));
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ë¶€ì„œ, íŒ€ì€ separatorCode ê·¸ë¦¬ê³  ì‚¬ì›ì€ employeeNoê°€ resultì— ë‹´ê¹ë‹ˆë‹¤~
  // JSONìœ¼ë¡œ ë³´ë‚´ê³  Controllerì—ì„œëŠ” @ResponseBody + ë§¤ê°œë³€ìˆ˜ì—ëŠ” @RequestBody List<String> ì‚¬ìš©í•´ì„œ ë°›ì•„ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤. 
  console.log("í™•ì •ëœ ì„ íƒ ë°”êµ¬ë‹ˆ:", result);
//ë°˜ë³µë¬¸ì„ í†µí•´ ë±ƒì§€ ë° íˆë“  ì¸í’‹ ìƒì„±
	result.forEach(({ code, name, step }) => {
	  // ë±ƒì§€ ìƒì„±
	  const badge = document.createElement("span");
	  badge.className = 'badge border text-dark d-flex justify-content-end align-items-center';
	  badge.style.backgroundColor = "#f8f9fa";
	
	  // í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
	  const nameSpan = document.createElement("span");
	  nameSpan.textContent = name;
	
	  // ë‹«ê¸° ë²„íŠ¼ ìƒì„±
	  const button = document.createElement("button");
	  button.type = "button";
	  button.className = "btn-close";
	  button.setAttribute("aria-label", "Remove");
	  button.setAttribute("data-prefix", targetPrefix);
	  button.style.scale = "0.8";
	
	  // ë‹«ê¸° ì´ë²¤íŠ¸ ì„¤ì •
	  button.addEventListener("click", () => {
	    badge.remove();
	    // ê´€ë ¨ëœ hidden inputë„ í•¨ê»˜ ì œê±°
	    badge.querySelectorAll("input").forEach(input => input.remove());
	  });
	
	  // Hidden input - ID
	  const hiddenId = document.createElement("input");
	  hiddenId.type = "hidden";
	  hiddenId.name = targetPrefix + "Ids";
	  hiddenId.value = code;
	
	  // Hidden input - Step
	  const hiddenStep = document.createElement("input");
	  hiddenStep.type = "hidden";
	  hiddenStep.name = targetPrefix + "Steps";
	  hiddenStep.value = step;
	
	  // ìš”ì†Œ ì¶”ê°€
	  badge.appendChild(nameSpan);    // ì´ë¦„
	  badge.appendChild(button);      // ë‹«ê¸° ë²„íŠ¼
	  badge.appendChild(hiddenId);    // ìˆ¨ê²¨ì§„ ID
	  badge.appendChild(hiddenStep);  // ìˆ¨ê²¨ì§„ Step
	
	  // ìµœì¢… ì¶”ê°€
	  targetContainer.appendChild(badge);
	});
	console.log(result);
  // ë¶€ì„œ, íŒ€ì€ separatorCode ê·¸ë¦¬ê³  ì‚¬ì›ì€ employeeNoê°€ resultì— ë‹´ê¹ë‹ˆë‹¤~
  // JSONìœ¼ë¡œ ë³´ë‚´ê³  Controllerì—ì„œëŠ” @ResponseBody + ë§¤ê°œë³€ìˆ˜ì—ëŠ” @RequestBody List<String> ì‚¬ìš©í•´ì„œ ë°›ì•„ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤. 
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  // ì—¬ê¸°ì„œ result ë°ì´í„° ê°€ì§€ê³  ì“°ì‹œë©´ ë©ë‹ˆë‹¤
  bootstrap.Modal.getInstance(document.getElementById('selectApproveLineModal')).hide();
  targetDiv = null;
  targetPrefix = null;
}

document.addEventListener('DOMContentLoaded', function () {
	  const tree = document.querySelector('#treeviewTree');

	  tree.addEventListener('click', function (e) {
	    // ìµœìƒìœ„ `li`ì¸ì§€ í™•ì¸
	    const clickedLi = e.target.closest('li.treeview-list-item');
	    if (!clickedLi) return;

	    // í´ë¦­ëœ ëŒ€ìƒì´ 'ì´ë£¸ ì»´í¼ë‹ˆ'ì¸ì§€ í™•ì¸
	    const isRootCompany = clickedLi.querySelector('#eroomCompanySpan');
	    if (isRootCompany) {
	      e.stopPropagation(); // ğŸš« ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
	      return;
	    }

	    // í´ë¦­ëœ ìš”ì†Œê°€ ì²´í¬ë°•ìŠ¤ì¸ì§€ í™•ì¸
	    if (e.target.type === 'checkbox') {
	      handleCheck(e.target);
	      e.stopPropagation(); // ğŸš« ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
	      return;
	    }

	    // í´ë¦­ëœ ìš”ì†Œê°€ 'ì‚¬ì›ëª…' ë˜ëŠ” 'treeview-text'ì¼ ê²½ìš°ë§Œ ì²´í¬ë°•ìŠ¤ í† ê¸€
	    if (e.target.classList.contains('treeview-label-text') || e.target.classList.contains('treeview-text')) {
	      const checkbox = clickedLi.querySelector('input[type="checkbox"].emp-checkbox');

	      // ìˆ¨ê²¨ì§„ ì²´í¬ë°•ìŠ¤ì¼ ê²½ìš° í¬ì¸í„° ì´ë²¤íŠ¸ ì°¨ë‹¨
	      if (checkbox && checkbox.offsetParent === null) {
	        e.stopPropagation();
	        return;
	      }

	      if (checkbox) {
	        checkbox.checked = !checkbox.checked; // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½
	        handleCheck(checkbox); // ìƒí•˜ìœ„ ë™ê¸°í™” ì²˜ë¦¬
	      }
	    }

	    // í´ë¦­ëœ ìš”ì†Œì— ëŒ€í•´ ê°•ì¡° í‘œì‹œ ì²˜ë¦¬ (handleHighlight ì¬ì‚¬ìš©)
	    handleHighlight(clickedLi);
	  });
	});




	// ë±ƒì§€ x ëˆŒëŸ¬ì„œ ì‚­ì œì‹œ ì²˜ë¦¬ ë°©ë²•
	function removeBadgeAndCheck(targetPrefix) {
	  const lineMap = {
	    'approver': document.getElementById("approvelLineTemp1"),
	    'agreer': document.getElementById("approvelLineTemp2"),
	    'referer': document.getElementById("approvelLineTemp3")
	  };
	
	  const targetDiv = document.getElementById(`approveLine${targetPrefix === 'approver' ? 1 : targetPrefix === 'agreer' ? 2 : 3}`);
	  // ë‚¨ì€ ë±ƒì§€ ê°œìˆ˜ í™•ì¸
	  const remainingBadges = targetDiv.querySelectorAll('.badge').length;
		console.log(remainingBadges);
	  // ë§Œì•½ 0ê°œë¼ë©´ ì„ì‹œ í‘œì‹œë¥¼ ë‹¤ì‹œ ë³´ì—¬ì¤Œ
	  if (remainingBadges === 0) {
	    lineMap[targetPrefix].style.display = 'block';
	  }
	}
	
	// ë±ƒì§€ x ëˆŒëŸ¬ì„œ ì‚­ì œì‹œ ì²˜ë¦¬í•˜ëŠ” ì´ë²¤íŠ¸
	document.addEventListener('click', (event) => {
	  if (event.target.classList.contains('btn-close')) {
	    const badge = event.target.closest('.badge');
	    const targetPrefix = event.target.getAttribute('data-prefix');
	    
	    if (badge) {
	      badge.remove();  // âœ… í™”ë©´ì—ì„œ ë±ƒì§€ ì‚­ì œ
	    }

	    if (targetPrefix) {
	      removeBadgeAndCheck(targetPrefix);  // âœ… ë‚¨ì€ ê°œìˆ˜ í™•ì¸
	    }
	  }
	});
	
	
</script>

<!-- ë¹„ìš°ê¸° ë²„íŠ¼ -->
<script>
	document.getElementById('clearBtn').addEventListener('click', resetTree);
	
	function resetTree() {
		  // 1. ì„ íƒëœ íƒœê·¸ ë¹„ìš°ê¸°
		  document.getElementById('selectedTags').innerHTML = '';

		  // 2. ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
		  const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
		  checkboxes.forEach(cb => {
		    cb.checked = false;
		  });

		  // 3. ê°•ì¡° ìŠ¤íƒ€ì¼ ì œê±° (ì´ë£¸ ì»´í¼ë‹ˆ ì œì™¸)
		  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => {
		    // ì´ë£¸ ì»´í¼ë‹ˆ ì œì™¸
		    if (!el.closest('a')?.querySelector('#eroomCompanySpan')) {
		      el.classList.remove('text-info-light');
		    }
		  });

		  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => {
		    if (el.id !== 'eroomCompanySpan') {
		      el.classList.remove('treeview-label-strong');
		    }
		  });

		  // 4. íŠ¸ë¦¬ ì ‘ê¸° (ì´ë£¸ ì»´í¼ë‹ˆ ì œì™¸)
		  document.querySelectorAll('.treeview-list.collapse').forEach(ul => {
		    if (ul.id !== 'tree-company') {
		      ul.classList.remove('show');
		    } else {
		      ul.classList.add('show');
		    }
		  });
		}


</script>

<!-- ìƒ‰ìƒ ê°•ì¡° -->
<script>
function handleHighlight(li) {
	  if (!li) return; // â—ì˜ˆì™¸ ì²˜ë¦¬

	  // ê¸°ì¡´ ê°•ì¡° ì œê±°
	  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => el.classList.remove('text-info-light'));
	  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => el.classList.remove('treeview-label-strong'));

	  // í˜„ì¬ ê°•ì¡°
	  const icon = li.querySelector('.treeview-icon');
	  const label = li.querySelector('.treeview-label-text');
	  if (icon) icon.classList.add('text-info-light');
	  if (label) label.classList.add('treeview-label-strong');

	  // ìƒìœ„ ê°•ì¡°
	  let currentUl = li.parentElement;
	  while (currentUl && currentUl.classList.contains('treeview-list')) {
	    const parentLi = currentUl.closest('li.treeview-list-item');
	    if (!parentLi) break;

	    const parentIcon = parentLi.querySelector('.treeview-icon');
	    const parentLabel = parentLi.querySelector('.treeview-label-text');
	    if (parentIcon) parentIcon.classList.add('text-info-light');
	    if (parentLabel) parentLabel.classList.add('treeview-label-strong');

	    currentUl = parentLi.parentElement;
	  }
	}

</script>
	<script th:inline="javascript">
		document.getElementById('approvalSubmitBtn').addEventListener('click', function (event) {
		  event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
		
		  // [1] ì œëª© & ì–‘ì‹ ìœ íš¨ì„± ê²€ì‚¬
		  const approvalTitle = document.getElementById("basic-form-title")?.value?.trim();
		  const formatSelect = document.getElementById("basic-select-format");
		  const approvalFormatNo = formatSelect?.value;
		  let isValid = true;
		  const approvalAttachFiles = document.getElementById("approvalAttachFiles");
		
		  if (!approvalTitle) {
		    document.getElementById("basic-form-title").style.border = "1px solid red";
		    isValid = false;
		  } else {
		    document.getElementById("basic-form-title").style.border = "";
		  }
		
		  if (!approvalFormatNo || formatSelect.value == 0) {
		    formatSelect.style.border = "1px solid red";
		    isValid = false;
		  } else {
		    formatSelect.style.border = "";
		  }
		
		  if (!isValid) {
		    alert("ì œëª©ê³¼ ì–‘ì‹ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		    return;
		  }
		
		  // [2] ì–‘ì‹ ì…ë ¥ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ ë° ë°ì´í„° ìˆ˜ì§‘
		  const inputElements = document.querySelectorAll("#basic-form-edit [name]");
		  const approvalContent = {};
		  let hasEmpty = false;
		
		  // ì²´í¬ë°•ìŠ¤ ë°ì´í„° ì„ì‹œ ì €ì¥
		  const checkboxGroups = {};
		  
		  inputElements.forEach(el => {
		    const name = el.name?.trim();
		    const value = el.value?.trim();
		
		    if (!name) return;

		    if (el.type === "radio") {
		      // [ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬ ì—¬ë¶€ í™•ì¸]
		      if (el.checked) {
		        approvalContent[name] = el.value;
		      }
		    } else if (el.type === "checkbox") {
		      // [ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬ ë¡œì§]
		      if (!checkboxGroups[name]) {
		        checkboxGroups[name] = [];
		      }
		      if (el.checked) {
		        checkboxGroups[name].push(value);
		      }
		    } else {
		      // [ì¼ë°˜ input ì²˜ë¦¬]
		      if (!value) {
		        hasEmpty = true;
		        el.classList.add("is-invalid");
		        el.style.border = "1px solid red";
		      } else {
		        el.classList.remove("is-invalid");
		        el.style.border = "";
		        approvalContent[name] = value;
		      }
		    }
		  });

		  // ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ì„ ìµœì¢…ì ìœ¼ë¡œ approvalContentì— ì¶”ê°€
		  Object.keys(checkboxGroups).forEach(key => {
		    if (checkboxGroups[key].length > 0) {
		      approvalContent[key] = checkboxGroups[key];
		    }
		  });

		  if (hasEmpty) {
		    alert("ê²°ì¬ì„œ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		    return;
		  }
		
		  // [3] ê²°ì¬ì„  ìœ íš¨ì„± ê²€ì‚¬
		  const approverIds = Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value);
		  const approverSteps = Array.from(document.querySelectorAll('input[name="approverSteps"]')).map(el => parseInt(el.value));
		  const agreerIds = Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value);
		  const agreerSteps = Array.from(document.querySelectorAll('input[name="agreerSteps"]')).map(el => parseInt(el.value));
		  const refererIds = Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value);
		  const refererSteps = Array.from(document.querySelectorAll('input[name="refererSteps"]')).map(el => parseInt(el.value));
		  
		
//		  if (approverSteps.length === 0 && agreerSteps.length === 0 && refererSteps.length === 0) {
		  if (approverSteps.length === 0 && agreerSteps.length === 0) {
		    alert("ê²°ì¬ì, í•©ì˜ìë¥¼ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
		    return;
		  }
		  if (approverSteps.length > 5 || agreerSteps.length > 5) {

			  alert("ê²°ì¬ì, í•©ì˜ìëŠ” ê°ê° ìµœëŒ€ 5ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
		    return;
		  }
		
		  if (
		    approverIds.length !== approverSteps.length ||
		    agreerIds.length !== agreerSteps.length ||
		    refererIds.length !== refererSteps.length
		  ) {
		    alert("ê²°ì¬ì ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
		    return;
		  }
		
		  // [4] ì‘ì„±ì ì •ë³´ ìˆ˜ì§‘
		  const writerFields = ["date", "department_name", "team_name", "employee_position", "employee_name"];
		  const writerData = {};
		  let editApprovalNo = null;
		  // editëª¨ë“œì¼ ê²½ìš° approval ê°ì²´ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
			if(/*[[${mode}]]*/ null == 'edit') {
				editApprovalNo = /*[[${approval.approval_no}]]*/ null;
			}
		  
		  writerFields.forEach(field => {
		    const el = document.getElementById(`basic-form-${field}`);
		    writerData[field] = el ? (el.value ?? el.textContent.trim()) : null;
		  });
		  
		
		  // [5-1] ì„œë²„ ì „ì†¡
		  /* fetch('/approval/create', {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json',
		      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
		      'header': document.querySelector('meta[name="_csrf_header"]').content
		    },
		    body: JSON.stringify({
		      writer: writerData,
		      title: approvalTitle,
		      format_no: approvalFormatNo,
		      content: approvalContent,
		      approverIds,
		      approverSteps,
		      agreerIds,
		      agreerSteps,
		      refererIds,
		      refererSteps,
		      approvalAttachFiles,
		      editApprovalNo : editApprovalNo
		    })
		  })
		  .then(res => res.json())
		  .then(data => {
		    if (data.res_code === "200") {
		      alert("ê²°ì¬ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
		      location.href = '/approval/myRequestedApprovals';
		    } else {
		      alert("ê²°ì¬ì„œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + data.res_msg);
		    }
		  })
		  .catch(err => {
		    console.error(err);
		    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		  }); */
		  
		  
		  

		  // [5-2] íŒŒì¼ ê¸°ëŠ¥ ì¶”ê°€ë¥¼ ìœ„í•œ formData ì¶”ê°€ ë²„ì „
		  const fileFormData = new FormData();
		  // ê¸°ë³¸ ë°ì´í„°
		  fileFormData.append("title", approvalTitle);
		  fileFormData.append("format_no", approvalFormatNo);
		  fileFormData.append("editApprovalNo", editApprovalNo ?? '');

		  // ì‘ì„±ì ì •ë³´
		  fileFormData.append("writer", new Blob([JSON.stringify(writerData)], { type: "application/json" }));

		  // ë³¸ë¬¸ ë‚´ìš©
		  fileFormData.append("content", new Blob([JSON.stringify(approvalContent)], { type: "application/json" }));

		  // ê²°ì¬ì„  ì •ë³´
		  fileFormData.append("approverIds", new Blob([JSON.stringify(approverIds)], { type: "application/json" }));
		  fileFormData.append("approverSteps", new Blob([JSON.stringify(approverSteps)], { type: "application/json" }));
		  fileFormData.append("agreerIds", new Blob([JSON.stringify(agreerIds)], { type: "application/json" }));
		  fileFormData.append("agreerSteps", new Blob([JSON.stringify(agreerSteps)], { type: "application/json" }));
		  fileFormData.append("refererIds", new Blob([JSON.stringify(refererIds)], { type: "application/json" }));
		  fileFormData.append("refererSteps", new Blob([JSON.stringify(refererSteps)], { type: "application/json" }));

		  // ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ì¶”ê°€
		  const approvalAttachFileIds = Array.from(document.querySelectorAll('input[name="approvalAttachFileIds"]')).map(el => parseInt(el.value));
		  fileFormData.append("approvalAttachFileIds", new Blob([JSON.stringify(approvalAttachFileIds)], { type: "application/json" }));
		  // ìƒˆ ì²¨ë¶€íŒŒì¼ ì¶”ê°€
		  for (const file of approvalAttachFiles.files) {
			  fileFormData.append("files", file); // name="files"ê°€ DTOë‘ ë§ì•„ì•¼ í•´
		  }

		  // [3] ì„œë²„ ì „ì†¡
		  fetch('/approval/create', {
		    method: 'POST',
		    headers: {
		      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
		      'header': document.querySelector('meta[name="_csrf_header"]').content
		    },
		    body: fileFormData
		  })
		  .then(res => res.json())
		  .then(data => {
		    if (data.res_code === "200") {
		      alert("ê²°ì¬ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
		      location.href = '/approval/myRequestedApprovals';
		    } else {
		      alert("ê²°ì¬ì„œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + data.res_msg);
		    }
		  })
		  .catch(err => {
		    console.error(err);
		    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		  });
		  
		  
		  
		  
		  
		  
		  
		  
		});
	</script>
	
    <!-- editëª¨ë“œë¡œ ë“¤ì–´ì™”ì„ ë•Œ ê²°ì¬ì ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ -->	
	<!-- <script>
	  document.addEventListener("DOMContentLoaded", function () {
	    const closeButtons = document.querySelectorAll(".btn-close");
	
	    closeButtons.forEach(btn => {
	      btn.addEventListener("click", function () {
	        const target = btn.closest("div");
	        target.remove();
	      });
	    });
	  });
	</script> -->
	<!-- ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë±ƒì§€ -->
	
	<script>
	function removeFile(element) {
	  const li = element.closest('li');
	  if (li) {
	    li.remove();
	  }
	}
	</script>



	</main>
</body>
</html>