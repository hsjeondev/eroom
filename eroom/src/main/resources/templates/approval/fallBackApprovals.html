<!DOCTYPE html>
<html 
lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{include/layout}">
 <body>
		<div class="content">
	<main class="main" id="top" layout:fragment="content">
	<!-- ì—¬ê¸°ì— ìš”ì†Œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤. -->
		<div class="d-flex justify-content-start align-items-center mb-5">
			<i class="uil uil-file-check text-secondary me-2"></i><span class="fw-bold fs-7">íšŒìˆ˜ ë¬¸ì„œ</span>
		</div>
			<div class="pb-8">
				<!-- &quot;page&quot;: ì—¬ê¸° ìˆ«ì ë°”ê¾¸ë©´ í•œ í˜ì´ì§€ ì»¨í…ì¸  ìˆ˜ ì¡°ì ˆ ê°€ëŠ¥ -->
				<div id="reports" style="display: none;" data-list='{
										       "valueNames": ["writer", "text1", "title", "state", "date", "reports"],
										       "page": 6,
										       "pagination": true
										     }'>
					<div class="row g-3 justify-content-between mb-2">
						<div class="col-12">
							<div class="d-md-flex justify-content-between">
							
								<!-- ê²°ì¬ì„œ ì‘ì„± ë²„íŠ¼ ë¶€ë¶„ -->
								<div class="mb-3">
									<a href="/approval/create"><button class="btn btn-primary me-2">
										ê²°ì¬ì„œ ì‘ì„±
										
									</button></a>
								    <button type="button" class="btn btn-primary" id="openSignature">
								      ì„œëª… ê´€ë¦¬
								    </button>
									
								</div>
								
								<div class="d-flex mb-3">
									<!-- ê²€ìƒ‰ì°½ -->
									<div class="search-box me-2">
										  <input class="form-control search-input search" type="search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." aria-label="Search">
										  <svg style="height: 30%;" class="svg-inline--fa fa-magnifying-glass search-box-icon" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="magnifying-glass" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
										  	<path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"></path>
										  </svg><!-- <span class="fas fa-search search-box-icon"></span> Font Awesome fontawesome.com -->
									</div>
									<!-- í•„í„° ë²„íŠ¼  -->
									<button class="btn px-3 btn-phoenix-secondary" type="button" data-bs-toggle="modal" data-bs-target="#reportsFilterModal" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
										<svg class="svg-inline--fa fa-filter text-primary" data-fa-transform="down-3" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="filter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="" style="transform-origin: 0.5em 0.6875em;">
											<g transform="translate(256 256)">
												<g transform="translate(0, 96)  scale(1, 1)  rotate(0 0 0)">
													<path fill="currentColor" d="M3.9 54.9C10.5 40.9 24.5 32 40 32H472c15.5 0 29.5 8.9 36.1 22.9s4.6 30.5-5.2 42.5L320 320.9V448c0 12.1-6.8 23.2-17.7 28.6s-23.8 4.3-33.5-3l-64-48c-8.1-6-12.8-15.5-12.8-25.6V320.9L9 97.3C-.7 85.4-2.8 68.8 3.9 54.9z" transform="translate(-256 -256)"></path>
												</g>
											</g>
										</svg><!-- <span class="fa-solid fa-filter text-primary" data-fa-transform="down-3"></span> Font Awesome fontawesome.com -->
									</button>
									<!-- í•„í„° ëª¨ë‹¬ -->
									<div class="modal fade" id="reportsFilterModal" tabindex="-1">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content border border-secondary">
												<form id="addEventForm" autocomplete="off">
													<div class="modal-header bg-light">
														<h5 class="modal-title">í•„í„°/ì •ë ¬</h5>
														<button class="btn-close btn-close-secondary" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
													</div>
													<div class="modal-body pt-4 pb-2 px-4">
														<div class="mb-3">
															<label class="form-label fw-semibold" for="formatNo">ê²°ì¬ì–‘ì‹</label>
															<select class="form-select" id="formatNo">
																<option th:value="0">ì „ì²´ ë³´ê¸°</option>
																<option 
																		th:each="formList : ${approvalFormatList}"
																		th:value="${formList.approval_format_no}"
					          											th:text="${formList.approval_format_title}">
			          											</option>
															</select>
														</div>
														<div class="mb-3">
															<label class="form-label fw-semibold" for="dateSort">ë‚ ì§œ</label>
															<select class="form-select" id="dateSort">
																<option value="DESC">ìµœì‹ ìˆœ</option>
																<option value="ASC">ì˜¤ë˜ëœìˆœ</option>
															</select>
														</div>
														<div class="mb-3">
															<label class="form-label fw-semibold" for="approvalStatus">ì§„í–‰ì—¬ë¶€</label>
															<select class="form-select" id="approvalStatus">
																<option th:value="F" selected>ğŸŸ  íšŒìˆ˜</option>
																<!-- ğŸŸ¡ -->
															</select>
														</div>
													</div>
												<div class="modal-footer d-flex justify-content-end align-items-center px-4 pb-4 border-0 pt-3">
												  <button id="filterBtn" class="btn btn-sm btn-primary px-9 fs-10 my-0" type="button">í™•ì¸</button>
												  </div>
												</form>
											</div>
										</div>
									</div>
									
									
								</div> <!-- d-flex mb-3 ë  -->
							</div> <!-- d-md-flex justify-content-between ë -->
						</div> <!-- col-12 ë -->
					</div><!-- row g-3 justify-content-between mb-2 ë -->
					
					
					<!-- ì¹´ë“œ ì „ì²´ -->
					<div class="row g-3 list" id="reportsList">
					  <!-- ë¹„ì–´ìˆì„ ê²½ìš°ì—ë„ .list-item í•˜ë‚˜ëŠ” ìˆì–´ì•¼ í•¨ -->
					  <div th:if="${#lists.isEmpty(resultList)}" class="list-item">
					  
					  
					  
						<div>
							<div class="text-center text-muted py-5">ê²°ì¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
						</div>
					    <span class="writer"></span>
					    <span class="text1"></span>
					    <span class="text2"></span>
					    <span class="text3"></span>
					    <a class="title"></a>
					    <span class="state"></span>
					    <span class="date"></span>
					    <span class="reports"></span>
					  </div>
						<!-- ì¹´ë“œ fragment ë°˜ë³µ -->
						<div class="bg-light rounded p-4 mt-4" th:replace="~{approval/cardFragment :: cardFragment}"></div>
					</div><!-- row g-3 list -->
				
				<!-- í˜ì´ì§• -->
				<div class="row align-items-center justify-content-center py-2 pe-0 fs-9 mt-2">
					<div class="col-auto d-flex">
						<button class="page-link disabled" data-list-pagination="prev" disabled=""><svg class="svg-inline--fa fa-chevron-left" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg=""><path fill="currentColor" d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"></path></svg><!-- <span class="fas fa-chevron-left"></span> Font Awesome fontawesome.com --></button>
							<ul class="mb-0 pagination">
								<li class="active">
									<button class="page" type="button" data-i="1" data-page="10">1</button>
								</li>
							</ul>
						<button class="page-link pe-0" data-list-pagination="next"><svg class="svg-inline--fa fa-chevron-right" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg=""><path fill="currentColor" d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path></svg><!-- <span class="fas fa-chevron-right"></span> Font Awesome fontawesome.com --></button>
					</div>
				  </div>
				
				</div> <!-- reports ë -->
				<div id="loadingSpinner" class="text-center py-3"  style="display: block;">
				   <div class="spinner-border" role="status">
				  	<span class="visually-hidden">ë¡œë”©ì¤‘...</span>
				  </div>
				</div>
			
			</div><!-- pb-8 ë -->
			
		
		
		
		
		
		
		    <!-- ì‹œê·¸ë‹ˆì²˜íŒ¨ë“œ ëª¨ë‹¬ êµ¬ì¡° -->
    <div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border border-secondary">
          <div class="modal-header bg-light">
            <h5 class="modal-title" id="signatureModalLabel">ì„œëª…</h5>
            <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body text-center">
				        <div class="canvas-wrapper" style="position: relative; width: 100%; max-width: 500px; margin: 0 auto;">
						  <canvas id="signatureCanvas" style="border: 1px solid #000; background: #fff; width: 100%; height: auto;"></canvas>
						</div>    

            <div class="mt-3">
              <button type="button" class="btn btn-secondary" id="clearSignature">íŒ¨ë“œ ì´ˆê¸°í™”</button>
              <button type="button" class="btn btn-primary" id="saveSignature">ì €ì¥</button>
              <!-- <button th:if="${approvalSignature != null}" type="button" class="btn btn-danger" id="deleteSignature">ì €ì¥ëœ ì„œëª… ì‚­ì œ</button> -->
            </div>
          </div>
        </div>
      </div>
    </div>
	<!-- Thymeleafì—ì„œ base64 ë°ì´í„° ë°”ì¸ë”© -->
	<input type="hidden" id="signatureImage" th:value="${approvalSignature}" />


<script>
	document.addEventListener("DOMContentLoaded", function() {
	   document.getElementById('loadingSpinner').style.display = 'none';
	   document.getElementById('reports').style.display = 'block';
	});
</script>

	<!-- ì‹œê·¸ë‹ˆì²˜ ëª¨ë‹¬ ì‘ë™ ìŠ¤í¬ë¦½íŠ¸ -->
	<script>
    window.addEventListener('load', function () {
    	let initialCanvasData = null;
      let signaturePad;
  		function lastSignature() {
  		    fetch('/approval/signature')
  	        .then(response => response.json())
  	        .then(data => {
  	            if (data != null && data.res_code == '200' && data.signatureDto != '') {
  	                const canvas = document.getElementById('signatureCanvas');
  	                const ctx = canvas.getContext('2d');
  	                const image = new Image();
  	                
  	                image.onload = function() {
  	                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
	  	                initialCanvasData = canvas.toDataURL();
  	                };
  	                image.src = data.signatureDto.signature_data_url;
  	            }
  	        })
  	        .catch(error => {
  	            console.error('ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨:', error);
  	        });
    	};
      const canvas = document.getElementById('signatureCanvas');
      const clearBtn = document.getElementById('clearSignature');
      const saveBtn = document.getElementById('saveSignature');
      const deleteBtn = document.getElementById('deleteSignature');

      function initSignaturePad() {
    	  // Canvasì˜ ì‹¤ì œ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ê°€ì ¸ì˜´
    	  const rect = canvas.getBoundingClientRect();
    	  const ratio = Math.max(window.devicePixelRatio || 1, 1);

    	  // ì‹¤ì œ í¬ê¸°ì™€ í•´ìƒë„ë¥¼ ë™ê¸°í™”
    	  canvas.width = rect.width * ratio;
    	  canvas.height = rect.height * ratio;

    	  const ctx = canvas.getContext('2d');
    	  ctx.scale(ratio, ratio);  // ë¹„ìœ¨ ì¡°ì •

    	  // ì‹œê·¸ë‹ˆì²˜ íŒ¨ë“œ ì´ˆê¸°í™”
    	  signaturePad = new SignaturePad(canvas, {
    	    backgroundColor: 'rgb(255,255,255)',
    	    penColor: 'black'
    	  });
    	}

      const signatureModal = document.getElementById('signatureModal');
      signatureModal.addEventListener('shown.bs.modal', function () {
        initSignaturePad();
        lastSignature();
      });

      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'openSignature') {
          const modal = new bootstrap.Modal(signatureModal);
          modal.show();
        }
      });

      clearBtn.addEventListener('click', function () {
        if (signaturePad) {
          signaturePad.clear();
        }
      });
		
      if(saveBtn){
	      saveBtn.addEventListener('click', function () {
	    	  const currentCanvasData = canvas.toDataURL();
	    	  if (initialCanvasData === currentCanvasData) {
	              // console.log("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
	              const modalInstance = bootstrap.Modal.getInstance(signatureModal);
	              modalInstance.hide();
	              return;
	          }
	        if (!signaturePad.isEmpty()) {
	          const saveDataURL = signaturePad.toDataURL();
	          console.log('ì„œëª… ë°ì´í„° URL:', saveDataURL);
	          
	          fetch('/approval/signature/create', {
	        	  method : 'POST',
	        	  headers : {
	      	        'Content-Type': 'application/json',
	    	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	    	        'header': document.querySelector('meta[name="_csrf_header"]').content
	        	  },
	        	  body : JSON.stringify({
	        		  signature_data_url : saveDataURL
	        	  })
	          })
	          .then(response => response.json())
	          .then(data => {
	        		  alert(data.res_msg);
	          })
	          
	          const modalInstance = bootstrap.Modal.getInstance(signatureModal);
	          modalInstance.hide();
	        } else {
	       		// ì„œëª… ë¯¸ì…ë ¥ì‹œ.
	          //alert('ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤!');
	       		// ì„œëª…ì´ ì—†ëŠ” ê²½ìš° ì§€ì›Œë²„ë¦¬ê¸°
	    	  fetch('/approval/signature/delete', {
	    		  method : 'PUT',
	        	  headers : {
	      	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	      	        'header': document.querySelector('meta[name="_csrf_header"]').content
	          	  }
	    	  })
	    	  .then(response => response.json())
	    	  .then(data => {
	    		  console.log(data.res_msg);
	    	      location.reload();
	    	  })
	    	  .catch(error => {
	    	        console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	    	        alert('ì‚­ì œ ì‹¤íŒ¨');
	    	  });
	       		
	        }
	      });
      }
      
      // ì‚¬ìš©ì í¸ì˜ì„±ì„ ìœ„í•´ ì§€ìš°ê¸°ëŠ” ìˆ˜ì •ì— í•©ì¹˜ì
      /* if(deleteBtn){
	      deleteBtn.addEventListener('click', function(){
	    	  fetch('/approval/signature/delete', {
	    		  method : 'PUT',
	        	  headers : {
	      	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	      	        'header': document.querySelector('meta[name="_csrf_header"]').content
	          	  }
	    	  })
	    	  .then(response => response.json())
	    	  .then(data => {
	    		  alert(data.res_msg);
	    	        location.reload();
	    	  })
	    	  .catch(error => {
	    	        console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	    	        alert('ì‚­ì œ ì‹¤íŒ¨');
	    	  });
	      });
      } */
      
      
      
    });
    
    
    </script>
    <!-- ê²€ìƒ‰ ê¸°ëŠ¥ í•¨ìˆ˜ ë”°ë¡œ ë¹¼ê¸°. ì›ë˜ íƒœê·¸ ìˆ˜ì • í•„ìš”ì—†ìŒ -->
	<script>
	  function bindSearch() {
	    const searchInput = document.querySelector('.search-input');
	    if (!searchInput) return;
	
	    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€ìš©)
	    const newSearchInput = searchInput.cloneNode(true);
	    searchInput.parentNode.replaceChild(newSearchInput, searchInput);
	
	    newSearchInput.addEventListener('input', function () {
	      const keyword = this.value.toLowerCase();
	      const cards = document.querySelectorAll('#reportsList > .col-12.col-xl-6');
	
	      cards.forEach(card => {
	        const text = card.innerText.toLowerCase();
	        if (text.includes(keyword)) {
	          card.style.display = 'block';
	        } else {
	          card.style.display = 'none';
	        }
	      });
	    });
	  }
	</script>

    <!-- í•„í„° ëª¨ë‹¬ ê°’ ë¹„ë™ê¸°ë¡œ ì ìš©í•˜ê¸° -->
<script>
document.getElementById("filterBtn").addEventListener("click", function () {
  const formatNo = document.getElementById("formatNo").value;
  const status = document.getElementById("approvalStatus").value;
  const dateSort = document.getElementById("dateSort").value;

  const query = new URLSearchParams();
  if (formatNo) query.append("formatNo", formatNo);
  if (status) query.append("approvalStatus", status);
  if (dateSort) query.append("dateSort", dateSort);

  fetch("/approval/fallBackApprovals/fragment?" + query.toString())
    .then(response => {
      if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
      return response.text();
    })
    .then(html => {
      document.getElementById("reportsList").innerHTML = html;

      requestAnimationFrame(() => {
        const hasItems = document.querySelector('#reportsList .col-12');
        if (!hasItems) {
          document.getElementById("reportsList").innerHTML =
            `<div class="text-center text-muted py-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          closeFilterModal();
          resetSearchInput();
          bindSearch();
          return;
        }

        // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì œê±° (destroyê°€ ë” ì•ˆì „)
        if (window.reportsListObj && typeof window.reportsListObj.destroy === 'function') {
          window.reportsListObj.destroy();
        }
        window.reportsListObj = null;

        // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œ ì´ˆê¸°í™”
        try {
          const options = {
            valueNames: ["writer", "text1", "title", "state", "date", "reports"],
            page: 6,
            pagination: true
          };
          window.reportsListObj = new List('reports', options);
        } catch (e) {
          console.error("List.js ì´ˆê¸°í™” ì‹¤íŒ¨", e);
          alert("ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
          return;
        }

        closeFilterModal();
        resetSearchInput();
        bindSearch();
      });
    })
    .catch(error => {
      console.error("í•„í„°ë§ ì¤‘ ì˜ˆì™¸:", error);
      alert("í•„í„°ë§ ì‹¤íŒ¨: " + error.message);
      closeFilterModal();
    });

  function closeFilterModal() {
    const filterModal = bootstrap.Modal.getInstance(document.getElementById('reportsFilterModal'));
    if (filterModal) filterModal.hide();
  }

  function resetSearchInput() {
    const searchInput = document.querySelector('.search-input');
    if (searchInput) searchInput.value = '';
  }
});
</script> 
	</main>
		</div> <!-- content ë -->
</body>
</html>