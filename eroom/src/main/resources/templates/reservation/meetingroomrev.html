<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{include/layout}">
<head>
<meta charset="UTF-8">
<title>회의실 예약</title>
<style>
/* 점 사라지게 */
.fc-list-event-graphic {
  display: none !important;
}

/* 혹시 남아있을 border까지 확실히 없애기 */
.fc-list-event-graphic {
  border-right: none !important;
}
  .treeview-label-strong {
      font-weight: bold;
      text-decoration: underline;
      color: #007bff;
    }
    .treeview-row {
      pointer-events: none;
    }
    .treeview-text a {
      text-decoration: none !important;
    display: block;
    width: 100%;
    height: 100%;
    padding: 5px 10px;
    }

    .treeview-text summary::marker,
    .treeview-text a::before,
    .treeview-text a::after {
      display: none !important;
      content: none !important;
    }
      .treeview-text {
    cursor: pointer; /* 마우스 커서를 클릭 가능 모양으로 변경 */
  }
  
  .treeview-text:hover {
    background-color: #f0f4ff; /* 호버 시 살짝 색상 변화 */    
}

.treeview-text input[type="checkbox"] {
  display: none;
  }
</style>

</head>


<body>
	<main class="main" id="top" layout:fragment="content">
	

		<div class="row">

			<!-- 왼쪽: 회의실 예약 목록 + 오늘 예약 현황 -->
			<div class="col-md-6 d-flex flex-column gap-4">

				<!-- 회의실 예약 목록 -->
				<div>
					<h5 class="fw-bold">회의실 예약 목록</h5>
					<div id="meetingRoomTable"
						data-list='{"valueNames":["no","room","capacity","date"], "page": 5, "pagination": true}'>
						<div class="table-responsive">
							<table class="table table-striped table-sm fs-9 mb-0 text-center">
								<thead class="text-center align-middle">
									<tr>
										<th class="sort" data-sort="no" style="width: 5%;">번호</th>
										<th class="sort" data-sort="room" style="width: 25%;">회의실</th>
										<th class="sort" data-sort="capacity" style="width: 20%;">수용
											인원</th>
										<th class="sort" data-sort="date" style="width: 20%;">등록일</th>
										<th style="width: 10%;"></th>
									</tr>
								</thead>
								<tbody class="list align-middle">
									<tr th:if="${#lists.isEmpty(list)}">
										<td colspan="5">등록된 회의실이 없습니다 😓</td>
									</tr>
									<tr class="align-middle room-row"
										th:each="result, stat : ${list}">
										<td class="no" th:text="${stat.count}"></td>
										<td class="room" th:text="${result.facilityName}"></td>
										<td class="capacity" th:text="${result.facilityCapacity}"></td>
										<td class="date"
											th:text="${#temporals.format(result.facilityRegDate, 'yyyy.MM.dd')}"></td>
										<td class="text-end pe-0">
											<button class="btn btn-sm btn-outline-primary"
												data-bs-toggle="modal" data-bs-target="#addEventModal"
												th:attr="data-facility-no=${result.facilityNo}, data-facility-name=${result.facilityName}">
												예약하기</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>

						<!-- ✅ 페이징 -->
						<div class="d-flex justify-content-center mt-3">
							<div class="d-flex">
								<button class="page-link" data-list-pagination="prev">
									<i class="fas fa-chevron-left"></i>
								</button>
								<ul class="mb-0 pagination"></ul>
								<button class="page-link" data-list-pagination="next">
									<i class="fas fa-chevron-right"></i>
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- 오늘 예약 현황 -->
				<div>
					<h5 class="fw-bold">오늘 예약 현황</h5>
					<div class="table-responsive">
						<table class="table table-striped table-sm fs-9 mb-0 text-center">
							<thead class="text-center align-middle">
								<tr>
									<th style="width: 5%;">번호</th>
									<th style="width: 20%;">회의실</th>
									<th style="width: 20%;">예약자</th>
									<th style="width: 20%;">예약 날짜</th>
									<th style="width: 25%;">예약 시간</th>
								</tr>
							</thead>
							<tbody class="align-middle">
								<tr th:if="${#lists.isEmpty(todayReservations)}">
									<td colspan="5">오늘 예약된 회의실이 없습니다 😊</td>
								</tr>
								<tr th:each="res, stat : ${todayReservations}">
									<td th:text="${stat.count}"></td>
									<td th:text="${res.meetingRoomName}"></td>
									<td th:text="${res.reserverName}"></td>
									<td
										th:text="${#temporals.format(res.reservation_start, 'yyyy.MM.dd')}"></td>
									<td><span
										th:text="${#temporals.format(res.reservation_start, 'HH:mm')}"></span>
										~ <span
										th:text="${#temporals.format(res.reservation_end, 'HH:mm')}"></span>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

			</div>

			<!-- 오른쪽: 캘린더 -->
			<div class="col-md-6">
				<div class="calendar-outline" id="appCalendar"
					style="height: 400px;"></div>
			</div>

		</div>
		
		
		
		
		<div class="modal fade" id="addEventModal" tabindex="-1">
							<div class="modal-dialog modal-dialog-centered">
								<div class="modal-content border border-translucent">
									<form id="addEventForm" autocomplete="off" name="addEventForm">
										<div class="modal-header px-card border-0">
											<h5 class="mb-0 text-body-highlight">회의실 예약</h5>
											<button
												class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-2 me-2 px-2 py-1"
												style="font-size: 0.9rem;" type="button"
												data-bs-dismiss="modal" aria-label="Close">×</button>
										</div>


									

										<!-- 등록 모달창 -->
										<div class="modal-body p-4">
											<!-- 숨겨진 값들 -->
											<input type="hidden" name="employee_no"
												th:value="${#authentication.principal.employee.employeeNo}" />
											<input type="hidden" name="facility_no" id="modalFacilityNo"
												value="" /> <input type="hidden" name="separator_code"
												value="F001" id="separator"> <input type="hidden"
												name="reservation_creator"
												th:value="${#authentication.principal.employee.employeeId}" />

											<div class="mb-3 text-center">
												<label class="form-label text-primary fw-semibold mb-1"
													for="selectedFacilityName" style="font-size: 1rem;">
													선택한 회의실 </label>
												<div class="form-control text-center fw-bold fs-5"
													id="selectedFacilityName"
													style="border: none; background-color: #f8f9fa;">회의실이
													선택되지 않았습니다</div>
											</div>
											

								<!-- 			<div class="mb-3">
												<label class="form-label">소속</label> <select
													class="form-select" id="departmentSelect">
													<option disabled selected>-- 소속 선택 --</option>
													<option th:each="dept : ${structureList}"
														th:value="${dept.separator_code}"
														th:text="${dept.separator_name}"
														th:selected="${dept.separator_name == param.department}">
													</option>
												</select>
											</div> -->

											<!-- 참여자 선택 -->
										<!-- 	<div class="mb-3">
												<label class="form-label">참여자 선택</label>
												<div class="d-flex">
													<select id="employeeSelect" class="form-select me-2"
														style="flex: 1;">
														<option disabled selected>-- 참여자 선택 --</option>
													</select>
													<button type="button" class="btn btn-outline-primary"
														onclick="addParticipant()">추가</button>
												</div>
											</div> -->
											
							<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#treeModal">
							  참여자 선택하기
							</button>

							<!-- 선택된 참여자 표시 -->
											<div class="mb-3">
												<label class="form-label">선택된 참여자</label>
												<div id="selectedParticipants"
													class="d-flex flex-wrap gap-1">								
												</div>
											</div>

											<!-- 시간 -->
											<div class="row g-2 mb-3">
												<!-- 날짜 선택 -->
												<div class="row g-2">
													<div class="col">
														<label class="form-label">시작 날짜</label> <input type="date"
															id="startDate" class="form-control"
															name="reservation_start_date">
													</div>
													<div class="col">
														<label class="form-label">종료 날짜</label> <input type="date"
															id="endDate" class="form-control"
															name="reservation_end_date">
													</div>
												</div>

												<!-- 시간 선택 -->
												<div class="row g-2 mt-2">
													<div class="col">
														<label class="form-label">시작 시간</label> <select
															id="startTime" class="form-select" name="startTime">
															<option value="09:00">09:00</option>
															<option value="10:00">10:00</option>
															<option value="11:00">11:00</option>
															<option value="12:00">12:00</option>
															<option value="13:00">13:00</option>
															<option value="14:00">14:00</option>
															<option value="15:00">15:00</option>
															<option value="16:00">16:00</option>
															<option value="17:00">17:00</option>
														</select>
													</div>
													<div class="col">
														<label class="form-label">종료 시간</label> <select
															id="endTime" class="form-select" name="endTime">
															<option value="10:00">10:00</option>
															<option value="11:00">11:00</option>
															<option value="12:00">12:00</option>
															<option value="13:00">13:00</option>
															<option value="14:00">14:00</option>
															<option value="15:00">15:00</option>
															<option value="16:00">16:00</option>
															<option value="17:00">17:00</option>
															<option value="18:00">18:00</option>
															<option value="19:00">19:00</option>
															<option value="20:00">20:00</option>
															<option value="21:00">21:00</option>
															<option value="22:00">22:00</option>
															<option value="23:00">23:00</option>
														</select>
													</div>
												</div>
												
												

												<!-- 숨겨서 서버로 보낼 datetime-local 값 -->
												<input type="hidden" name="reservation_start"
													id="calendarStartTime"> <input type="hidden"
													name="reservation_end" id="calendarEndTime">
											</div>
										</div>
										<div class="modal-body p-4">

											<div class="alert text-center mb-3" role="alert"
												style="font-size: 0.9rem; background-color: #E3F2FD; border: 1px solid #BBDEFB; color: #0D47A1;">
												ℹ️ <strong>예약 확정 후에는 시간 수정이 불가능합니다.</strong><br> 변경이
												필요할 경우 <strong>기존 예약을 취소</strong>한 뒤 다시 예약해주세요.<br>
												<br> 🏢 <strong>회의실은 다음 이용자와의 원활한 이용을 위해</strong><br>
												<strong>사용 종료 시간을 반드시 지켜주시기 바랍니다.</strong><br>
												<br> 신중하게 예약하고, <strong>정시에 종료</strong>해 주세요 😊
											</div>
										</div>

											<div class="modal-footer border-0 px-4 pb-3">
												<button class="btn btn-primary w-100" type="submit">
													예약하기</button>
											</div>
									</form>
								</div>
							</div>
						</div>
		
		<!-- 트리 구조 모달 -->
		<div class="modal fade" id="treeModal" tabindex="-1"
			aria-labelledby="treeModalLabel" aria-hidden="true"
			data-bs-focus="false">
			<div class="modal-dialog modal-dialog-centered modal-lg"
				style="max-width: 550px; height: 400px;">
				<div class="modal-content">
					<div class="modal-header bg-light">
						<h5 class="modal-title" id="treeModalLabel">조직도 선택</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="닫기"></button>
					</div>

					<div class="modal-body px-4"
						style="height: 400px; overflow-y: auto;">
						<div class="row" style="height: 100%;">
							<div class="col-6">
								<ul class="treeview" id="treeviewTree">
									<li class="treeview-list-item">
										<p class="treeview-text">
											<input type="checkbox"
												class="form-check-input me-2 root-checkbox"
												data-name="이룸 컴퍼니" data-no="root"
												onchange="handleCheck(this)" > <a
												href="javascript:void(0);" data-bs-target="#tree-company">
												<span
												class="fa-solid fa-folder treeview-icon text-info-light"></span>
												<span id="eroomCompanySpan"
												class="treeview-label-text fw-bold treeview-label-strong">이룸
													컴퍼니</span>
											</a>
										</p>
										<ul class="collapse show treeview-list" id="tree-company">
											<li class="treeview-list-item"
												th:each="dept : ${departmentList}">
												<p class="treeview-text ms-2">
													<input type="checkbox"
														class="form-check-input me-2 dept-checkbox"
														th:attr="data-name=${dept.codeName}, data-no=${dept.separatorCode}"
														onchange="handleCheck(this)"> <a
														href="javascript:void(0);"
														th:attr="data-bs-toggle='collapse', data-bs-target='#dept-'+${dept.separatorCode}">
														<span class="fa-solid fa-folder treeview-icon"></span> <span
														class="treeview-label-text" th:text="${dept.codeName}">부서명</span>
													</a>
												</p>
												<ul class="collapse treeview-list"
													th:id="'dept-'+${dept.separatorCode}">
													<li class="treeview-list-item"
														th:each="team : ${teamMap[dept.codeName]}">
														<p class="treeview-text ms-3">
															<input type="checkbox"
																class="form-check-input me-2 team-checkbox"
																th:attr="data-name=${team.codeName}, data-no=${team.separatorCode}"
																onchange="handleCheck(this)"> <a
																href="javascript:void(0);"
																th:attr="data-bs-toggle='collapse', data-bs-target='#team-'+${team.separatorCode}">
																<span class="fa-solid fa-file-lines treeview-icon"></span>
																<span class="treeview-label-text"
																th:text="${team.codeName}">팀명</span>
															</a>
														</p>
														<ul class="collapse treeview-list"
															th:id="'team-'+${team.separatorCode}">
															<li class="treeview-list-item"
																th:each="emp : ${teamEmployeeMap[team.separatorCode]}">
																<p class="treeview-text ms-4">
																	<input type="checkbox"
																		class="form-check-input me-2 emp-checkbox"
																		th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}"
																		onchange="handleCheck(this)"> <span
																		class="fa-solid fa-user treeview-icon"></span> <span
																		class="treeview-label-text"
																		th:text="${emp.employee_name}">사원명</span>
																</p>
															</li>
														</ul>
													</li>
													<!-- 부서는 있지만 팀 없는 사람 -->
													<li class="treeview-list-item"
														th:each="emp : ${teamEmployeeMap[dept.separatorCode + '_notAssigned']}">
														<p class="treeview-text ms-3">
															<!-- ← ms-4 에서 ms-3으로 맞춰줌 -->
															<input type="checkbox"
																class="form-check-input me-2 emp-checkbox"
																th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}"
																onchange="handleCheck(this)"> <span
																class="fa-solid fa-user treeview-icon"></span> <span
																class="treeview-label-text"
																th:text="${emp.employee_name}">사원명</span>
														</p>
													</li>
												</ul>
											</li>
										
										</ul>
									</li>
								</ul>
							</div>

							<div class="col-6 d-flex flex-column">
								<!-- [1] 상단 고정 영역 -->
								<div id="selectedResult"
									class="border bg-white rounded p-2 mb-2 small"
									style="position: sticky; top: 0; z-index: 2; background-color: white;">
									<strong>선택한 항목:</strong>
									<div style="overflow-y: auto; max-height: 270px;"
										id="selectedTags" class="mt-1 flex-wrap gap-2"></div>
								</div>

								<!-- [2] 중간: 빈 영역 (스크롤 여유) -->
								<div class="flex-grow-1"></div>

								<!-- [3] 하단 고정 영역 -->
								<div class="text-end"
									style="position: sticky; bottom: 0; z-index: 2; background-color: white;">
									<button id="clearBtn" class="btn btn-light btn-sm"
										type="button">비우기</button>
								</div>
							</div>


						</div>
					</div>

						<div class="modal-footer py-2">
							<button type="button" class="btn btn-light btn-sm"
								data-bs-dismiss="modal">취소</button>
							<button type="button" class="btn btn-primary btn-sm"
								onclick="confirmSelection()">선택 완료</button>
						</div>
					</div>
				</div>
			</div>
	
		
		<script>
		
			document.addEventListener("DOMContentLoaded", function () {
				  const treeModal = document.getElementById("treeModal");
	
				  if (treeModal) {
				    treeModal.addEventListener("hidden.bs.modal", function () {
				      resetTree(); // 체크박스, 태그 등 초기화 함수 호출
				    });
				  }
				});
			function handleCheck(checkbox) {
			  const name = checkbox.getAttribute('data-name');
			  const code = checkbox.getAttribute('data-no');
			  const li = checkbox.closest('li.treeview-list-item');
			  
			  if (name === '이룸 컴퍼니') return;
			
			  if (checkbox.checked) {
			    addTag(name, code);
			    handleHighlight(li);
			  } else {
			    removeTag(code);
			  }
			
			  updateChildren(checkbox, checkbox.checked);
			  updateParents(checkbox);
			}
			
			function updateChildren(checkbox, isChecked) {
				  const li = checkbox.closest('li.treeview-list-item');
				  if (!li) return;
			
				  const descendants = li.querySelectorAll('input[type="checkbox"]');
				  descendants.forEach(child => {
				    if (child !== checkbox) {
				      child.checked = isChecked;
			
				      // 하위 태그 제거 (상위 클릭 시 기존 하위 태그 남는 문제 해결)
				      const code = child.getAttribute('data-no');
				      removeTag(code);
				    }
				  });
				}
			
			
			function updateParents(checkbox) {
				  let li = checkbox.closest('li.treeview-list-item');
			
				  while (li) {
				    const parentLi = li.parentElement.closest('li.treeview-list-item');
				    if (!parentLi) break;
			
				    const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[type="checkbox"]');
				    const childCheckboxes = Array.from(parentLi.querySelectorAll(':scope > ul > li.treeview-list-item > .treeview-text input[type="checkbox"]'));
			
				    const allChecked = childCheckboxes.length > 0 && childCheckboxes.every(cb => cb.checked);
				    const someChecked = childCheckboxes.some(cb => cb.checked);
			
				    if (parentCheckbox) {
				      if (allChecked) {
				        parentCheckbox.checked = true;
			
				        // 상위만 tag
				        const pname = parentCheckbox.getAttribute('data-name');
				        const pcode = parentCheckbox.getAttribute('data-no');
				        addTag(pname, pcode);
			
				        // 하위 tag 제거
				        childCheckboxes.forEach(cb => removeTag(cb.getAttribute('data-no')));
			
				      } else if (someChecked) {
				        parentCheckbox.checked = false;
			
				        // 상위 tag 제거
				        const pcode = parentCheckbox.getAttribute('data-no');
				        removeTag(pcode);
			
				        // 하위 중 체크된 것만 tag 추가
				        childCheckboxes.forEach(cb => {
				          const cname = cb.getAttribute('data-name');
				          const ccode = cb.getAttribute('data-no');
				          if (cb.checked) addTag(cname, ccode);
				          else removeTag(ccode);
				        });
			
				      } else {
				        parentCheckbox.checked = false;
			
				        // 전부 제거
				        const pcode = parentCheckbox.getAttribute('data-no');
				        removeTag(pcode);
				      }
				    }
			
				    li = parentLi;
				  }
				}
			

				function addTag(label, code) {
					  const tagWrap = document.getElementById("selectedTags");
					  if (document.getElementById(`tag-${code}`)) return;
			
					  // Card 생성
					  const card = document.createElement("div");
					  card.className = "card mb-2"; // 여기서 flex는 제거됨
					  card.id = `tag-${code}`;
					  card.name = `tag-${label}`;
					  card.style.borderRadius = "5px";
					  card.style.padding = "8px";
					  card.style.backgroundColor = "#f8f9fa";
					  card.style.display = "block"; // 한 줄씩 표시
			
					  // 이름 라벨
					  const labelElement = document.createElement("span");
					  labelElement.textContent = label;
					  card.appendChild(labelElement);
			
					  // 삭제 버튼
					  const button = document.createElement("button");
					  button.type = "button";
					  button.className = "btn-close";
					  button.style.float = "right"; // 오른쪽 정렬
					  button.setAttribute("aria-label", "Remove");
					  button.addEventListener("click", () => {
					    card.remove();
					    removeTag(code, true);  // 태그 삭제 시 체크박스도 해제
					  });
			
					  card.appendChild(button);
			
					  // Card를 선택된 태그 컨테이너에 추가
					  tagWrap.appendChild(card);
					}
			
				
				function removeTag(code, skipCheckbox = false) {
					  const tag = document.getElementById(`tag-${code}`);
					  if (tag) tag.remove();
			
					  if (!skipCheckbox) return;
			
					  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
					  if (checkbox && checkbox.checked) {
					    checkbox.checked = false;
					    handleCheck(checkbox); // 연쇄 동기화
					  }
					}
			
			
				function confirmSelection() {
					  const selected = document.querySelectorAll("#selectedTags .card");

					  const result = Array.from(selected).map((el, index) => ({
					    code: el.id.replace('tag-', ''),
					    name: el.name.replace('tag-', ''),
					    step: index + 1
					  }));

					  // 👉 참여자 표시 영역 가져오기
					  const participantBox = document.getElementById("selectedParticipants");
					  participantBox.innerHTML = ''; // 기존 항목 초기화

					  result.forEach(item => {
					    const badge = document.createElement("span");
					    badge.className = "badge badge-phoenix badge-phoenix-secondary me-2 mb-2";
					    badge.dataset.id = item.code;
					    badge.id = 'participant-' + item.code;
					    badge.innerHTML = `
					      ${item.name}
					      <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>
					    `;
					    participantBox.appendChild(badge);
					  });

					  // 트리 모달 닫기
					  bootstrap.Modal.getInstance(document.getElementById('treeModal')).hide();
					  const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
					  addEventModal.show(); // 🔥 이거 추가해야 원래 모달로 돌아감
					}

					document.addEventListener('DOMContentLoaded', function () {
				
			
				  const tree = document.querySelector('#treeviewTree');

				  tree.addEventListener('click', function (e) {
				    const clickedLi = e.target.closest('li.treeview-list-item');
				    if (!clickedLi) return;

				    // 클릭된 요소가 label-text 또는 treeview-text일 때만 반응
				    if (
				      e.target.classList.contains('treeview-label-text') ||
				      e.target.classList.contains('treeview-text')
				    ) {
				      const checkbox = clickedLi.querySelector('input[type="checkbox"]');
				      if (checkbox) {
				        checkbox.checked = !checkbox.checked;
				        handleCheck(checkbox);
				      }
				    }

				    // 강조 효과
				    handleHighlight(clickedLi);
				  });
				
				});
			
			
			</script>
			
			<!-- 비우기 버튼 -->
			<script>
				document.getElementById('clearBtn').addEventListener('click', resetTree);
				
				function resetTree() {
					  // 1. 선택된 태그 비우기
					  document.getElementById('selectedTags').innerHTML = '';
			
					  // 2. 모든 체크박스 해제
					  const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
					  checkboxes.forEach(cb => {
					    cb.checked = false;
					  });
			
					  // 3. 강조 스타일 제거 (이룸 컴퍼니 제외)
					  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => {
					    // 이룸 컴퍼니 제외
					    if (!el.closest('a')?.querySelector('#eroomCompanySpan')) {
					      el.classList.remove('text-info-light');
					    }
					  });
			
					  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => {
					    if (el.id !== 'eroomCompanySpan') {
					      el.classList.remove('treeview-label-strong');
					    }
					  });
			
					  // 4. 트리 접기 (이룸 컴퍼니 제외)
					  document.querySelectorAll('.treeview-list.collapse').forEach(ul => {
					    if (ul.id !== 'tree-company') {
					      ul.classList.remove('show');
					    } else {
					      ul.classList.add('show');
					    }
					  });
					}
			
			
			</script>
			
			<!-- 색상 강조 -->
			<script>
			function handleHighlight(li) {
				  if (!li) return; // ❗예외 처리
			
				  // 기존 강조 제거
				  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => el.classList.remove('text-info-light'));
				  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => el.classList.remove('treeview-label-strong'));
			
				  // 현재 강조
				  const icon = li.querySelector('.treeview-icon');
				  const label = li.querySelector('.treeview-label-text');
				  if (icon) icon.classList.add('text-info-light');
				  if (label) label.classList.add('treeview-label-strong');
			
				  // 상위 강조
				  let currentUl = li.parentElement;
				  while (currentUl && currentUl.classList.contains('treeview-list')) {
				    const parentLi = currentUl.closest('li.treeview-list-item');
				    if (!parentLi) break;
			
				    const parentIcon = parentLi.querySelector('.treeview-icon');
				    const parentLabel = parentLi.querySelector('.treeview-label-text');
				    if (parentIcon) parentIcon.classList.add('text-info-light');
				    if (parentLabel) parentLabel.classList.add('treeview-label-strong');
			
				    currentUl = parentLi.parentElement;
				  }
				}
			
			</script>

		<!-- 커스텀 메시지 모달 -->
							<div class="modal fade" id="messageModal" tabindex="-1"
								aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered modal-sm">
									<div
										class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
										<div class="modal-header border-0">
											<h5 class="modal-title text-dark" id="messageModalTitle">알림</h5>
										</div>
										<div class="modal-body text-center">
											<p class="mb-0 text-body" id="messageModalBody">메시지 내용이
												들어갑니다.</p>
										</div>
										<div class="modal-footer justify-content-center border-0">
											<button type="button" class="btn btn-primary"
												data-bs-dismiss="modal">확인</button>
										</div>
									</div>
								</div>
							</div>
							
							
					
							<script>
							function showMessageModal(message, title = "알림", reload = false) {
								  const modalTitle = document.getElementById("messageModalTitle");
								  const modalBody = document.getElementById("messageModalBody");
								  modalTitle.textContent = title;
								  modalBody.textContent = message;

								  const modalEl = document.getElementById("messageModal");
								  const modal = new bootstrap.Modal(modalEl);
								  modal.show();

								  const confirmBtn = modalEl.querySelector('button[data-bs-dismiss="modal"]');

								  // ✅ 기존 이벤트 제거
								  const newBtn = confirmBtn.cloneNode(true);
								  confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

								  // ✅ reload 조건 처리
								  if (reload) {
								    newBtn.addEventListener("click", () => location.reload());
								  }
								}


								</script>
					
					
					
							<script>
							
							document.addEventListener("DOMContentLoaded", function () {
							  const modal = document.getElementById("addEventModal");
							  const form = document.forms["addEventForm"];
							  const facilityInput = document.getElementById("modalFacilityNo");
							  const submitBtn = form.querySelector('button[type="submit"]');
							
							  if (!modal || !form) return;
							
							  // 모달 열릴 때 초기화
							  modal.addEventListener("show.bs.modal", function (event) {
							    form.reset();
							    const selectedParticipants = document.getElementById('selectedParticipants');
							   
							
							    const startDate = document.getElementById('startDate');
							    const endDate = document.getElementById('endDate');
							    const startTime = document.getElementById('startTime');
							    const endTime = document.getElementById('endTime');
							    const calendarStartTime = document.getElementById('calendarStartTime');
							    const calendarEndTime = document.getElementById('calendarEndTime');
							
							    const today = new Date().toISOString().split("T")[0]; // ✨ 오늘 날짜 구하기
							
							    if (startDate) {
							      startDate.value = today;    //  시작날짜 기본값 세팅
							      startDate.min = today;      //  과거 선택 금지
							    }
							    if (endDate) {
							      endDate.value = today;      // 종료날짜 기본값 세팅
							      endDate.min = today;        // 과거 선택 금지
							    }
							    if (startTime) startTime.selectedIndex = 0;
							    if (endTime) endTime.selectedIndex = 0;
							    if (calendarStartTime) calendarStartTime.value = '';
							    if (calendarEndTime) calendarEndTime.value = '';
							
							    const button = event.relatedTarget;
							    const facilityNo = button.getAttribute("data-facility-no");
							    const facilityName = button.getAttribute("data-facility-name");
							
							    facilityInput.value = facilityNo;
							    document.getElementById("selectedFacilityName").textContent = facilityName || "차량명이 없습니다";
							  });
							
							  // submit 처리
							 form.addEventListener("submit", function (e) {
							  e.preventDefault();
							  submitBtn.disabled = true;
							
							  const today = new Date().toISOString().split("T")[0];
							  form.reservation_start_date.min = today;
							  form.reservation_end_date.min = today;
							
							
							  const participantBadges = document.querySelectorAll('#selectedParticipants .badge');
							  const participantIds = Array.from(participantBadges).map(badge => badge.dataset.id);
							
							  if (participantIds.length === 0) {
								  showMessageModal("참여자를 1명 이상 선택해주세요!");
								  submitBtn.disabled = false;
								  return;
								}
							
							  const startDate = form.reservation_start_date.value;
							  const endDate = form.reservation_end_date.value;
							  const startTime = form.startTime.value;
							  const endTime = form.endTime.value;
							
							  if (!startDate || !endDate || !startTime || !endTime) {
							    showMessageModal("날짜와 시간을 모두 선택해주세요!");
							    submitBtn.disabled = false;
							    return;
							  }
							
							  const fullStart = `${startDate}T${startTime}`;
							  const fullEnd = `${endDate}T${endTime}`;
							
							  if (fullStart >= fullEnd) {
							    showMessageModal("종료일시는 시작일시보다 늦어야 합니다!");
							    submitBtn.disabled = false;
							    return;
							  }
							
							  // 중복 시간 검사
							  const startHour = parseInt(startTime.split(":")[0]);
							  const endHour = parseInt(endTime.split(":")[0]);
							  const bookedHours = [...form.startTime.options]
							    .filter(opt => opt.disabled)
							    .map(opt => parseInt(opt.value.split(":")[0]));
							
							  for (let hour = startHour; hour < endHour; hour++) {
							    if (bookedHours.includes(hour)) {
							      showMessageModal("선택한 시간 범위에 이미 예약된 시간이 포함되어 있습니다!");
							      submitBtn.disabled = false;
							      return;
							    }
							  }
							
							  form.calendarStartTime.value = fullStart;
							  form.calendarEndTime.value = fullEnd;
							
							  const payload = new FormData(form);
							  participantIds.forEach(id => payload.append("participants", id));
							
							  fetch('/reservation/meetingroom/reserve', {
							    method: 'POST',
							    headers: {
							      'header': document.querySelector('meta[name="_csrf_header"]').content,
							      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
							    },
							    body: payload
							  })
							    .then(response => response.json())
							    .then(data => {
							      if (data.res_code == "200") {
							        showMessageModal(data.res_msg || "회의실 예약이 완료되었습니다.", "알림", true); // ✅ 확인 후 새로고침
							      } else {
							        showMessageModal(data.res_msg || "회의실 예약에 실패했습니다.");
							        submitBtn.disabled = false;
							      }
							    })
							    .catch(error => {
							      console.error(error);
							      showMessageModal("요청 처리 중 오류가 발생했습니다. 다시 시도해주세요 😭");
							      submitBtn.disabled = false;
							    	});
								});
							}); 
							</script>

						<script>
						let isCreateMode = true; // 기본은 생성 모드
						document.addEventListener("DOMContentLoaded", function () {
							  bindDepartmentChange();
							  bindParticipantAdd();
							});
				
						function bindDepartmentChange() {
							  const departmentSelect = document.getElementById("departmentSelect");
							  if (!departmentSelect) return;
							 
							
							  departmentSelect.addEventListener("change", function () {
								  const deptId = this.value;
								  //console.log("소속 선택됨:", deptId);
							  
							    fetch('/reservation/employees?separator_code=' + encodeURIComponent(deptId))
							      .then(response => response.json())
							      .then(data => {
							    	console.log("받아온 직원 목록:", data);
							        const select = document.getElementById('employeeSelect');
							        select.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
							        data.forEach(emp => {
							          const option = document.createElement('option');
							          option.value = emp.employee_no;
							          option.text = emp.employee_name;
							          select.appendChild(option);
							        });
							      })
							      .catch(error => console.error('직원 로딩 실패:', error));
							  });
							}
							
					// 참여자 추가
					function bindParticipantAdd() {
						  const btn = document.querySelector("button[onclick='addParticipant()']");
						  if (!btn) return;
						
						  btn.addEventListener("click", () => {
						    const select = document.getElementById('employeeSelect');
						    const selectedOptions = Array.from(select.selectedOptions);
						
						    if (selectedOptions.length === 0) {
						      alert('참여자를 선택해주세요.');
						      return;
						    }
						
						    selectedOptions.forEach(option => {
						      const participantId = option.value;
						      const participantName = option.text;
						
						      // 중복 추가 방지
						      if (document.getElementById('participant-' + participantId)) {
						        alert('이미 추가된 참여자입니다.');
						        return;
						      }
						
						      // 배지 생성
						      const badge = document.createElement('span');
						      badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
						      badge.id = 'participant-' + participantId;
						      badge.dataset.id = participantId;
						      badge.innerHTML = `
						        ${participantName}
						        <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>
						      `;
						
						      document.getElementById('selectedParticipants').appendChild(badge);
						    });
						
						   
						  });
						  
						}
						
						</script>
						
					

						<!-- 회의실 예약 상세조회 모달 -->
						<div class="modal fade" id="vehicleDetailModal" tabindex="-1"
							aria-labelledby="vehicleDetailModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered">
								<div class="modal-content border border-translucent">
									<div class="modal-header px-card border-0 position-relative">
										<h5 class="mb-0 lh-sm text-body-highlight"
											id="vehicleDetailModalLabel">회의실 예약 상세조회</h5>
										<button
											class="btn-close position-absolute top-0 end-0 mt-2 me-2"
											type="button" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>

									<div class="modal-body p-4">
										<input type="hidden" id="detailReservationNo"> <input
											type="hidden" name="reservation_creator" id="loginEmployeeId"
											th:value="${#authentication.principal.employee.employeeId}" />

										<div class="mb-3">
											<strong>회의실명:</strong> <span id="detailVehicleName"></span>
										</div>
										<div class="mb-3">
											<strong>예약자:</strong> <span id="detailReserverName"></span>
										</div>
										<div class="mb-3">
											<strong>참여자:</strong> <span id="detailLocation"></span>
										</div>
										<div class="mb-3">
											<strong>시작 시간:</strong> <span id="detailStartTime"></span>
										</div>
										<div class="mb-3">
											<strong>종료 시간:</strong> <span id="detailEndTime"></span>
										</div>
									</div>

									<div
										class="modal-footer d-flex justify-content-between align-items-center border-0">
										<div class="d-flex">
											<!-- <button class="btn btn-subtle-secondary me-1 mb-1"
						type="button" id="editVehicleBtn">수정</button> -->
											<button class="btn btn-outline-info me-1 mb-1" type="button"
												id="deleteVehicleBtn">예약취소</button>
										</div>
										<div>
											<button class="btn btn-primary px-4" type="button"
												data-bs-dismiss="modal">확인</button>
										</div>
									</div>
								</div>
							</div>
						</div>

				<!-- 삭제 모달 -->
			<!-- 				<div class="modal fade" id="confirmDeleteModal" tabindex="-1"
								aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered modal-sm">
									<div
										class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
									
										<div class="modal-body text-center">
											<p class="mb-0 text-body">
												예약을 취소하시겠습니까?<br>취소 후 자동으로 새로고침됩니다.
											</p>
										</div>
										<div class="modal-footer justify-content-center border-0">
											<button type="button" class="btn btn-phoenix-secondary"
												data-bs-dismiss="modal">취소</button>
											<button type="button" class="btn btn-danger" id="confirmDeleteBtn">삭제</button>
										</div>
									</div>
								</div>
							</div> -->


		
		<!-- 캘린더 script -->
		<script>
			document.addEventListener('DOMContentLoaded', function () {
			  const calendarEl = document.getElementById('appCalendar');
			  const separator = document.getElementById('separator').value;
			  const loginEmployeeId = document.getElementById("loginEmployeeId").value;
			
			  const calendar = new FullCalendar.Calendar(calendarEl, {
			    initialView: 'listMonth',
			    locale: 'ko',
			    headerToolbar: {
			      left: 'prev,next today',
			      center: 'title',
			      right: ''
			    },
			    buttonText: {
			      today: '오늘'
			    },
			    noEventsContent: '예약이 없습니다',
			    validRange: {           
			        start: new Date()      
			      },
			    dayMaxEventRows: true,
			    views: {
			      dayGridMonth: {
			        dayMaxEventRows: 3,
			        moreLinkText: "더보기"
			      }
			    },
			    eventSources: [
			      {
			        events: function (fetchInfo, successCallback, failureCallback) {
			          fetch('/meetingroom/list/' + separator)
			            .then(response => response.json())
			            .then(events => successCallback(events))
			            .catch(error => {
			              console.error("회의실 예약 불러오기 실패", error);
			              failureCallback(error);
			            });
			        }
			      }
			    ],
			    eventDisplay: 'block',
			    dayCellContent: function (info) {
			      return info.date.getDate();
			    },
			    eventClick: function(info) {
			      const event = info.event;
			      const options = {
			        year: 'numeric', month: 'long', day: 'numeric', weekday: 'short',
			        hour: '2-digit', minute: '2-digit', hour12: false
			      };
			
			      const isOwner = loginEmployeeId === event.extendedProps.reservationCreator;
			      document.getElementById("deleteVehicleBtn").style.display = isOwner ? 'inline-block' : 'none';
			
			      document.getElementById("detailReservationNo").value = event.extendedProps.reservation_no || '';
			      document.getElementById("detailVehicleName").textContent = event.extendedProps.meetingRoomName || '';
			      document.getElementById("detailReserverName").textContent = event.extendedProps.reserverName || '';
			      document.getElementById("detailLocation").textContent =
			        (event.extendedProps.participantNames || []).join(', ') || '없음';
			
			      document.getElementById("detailStartTime").textContent =
			        new Intl.DateTimeFormat('ko-KR', options).format(new Date(event.start));
			      document.getElementById("detailEndTime").textContent =
			        new Intl.DateTimeFormat('ko-KR', options).format(new Date(event.end));
			
			      const modalElement = document.getElementById('vehicleDetailModal');
			      if (modalElement) {
			        const modal = new bootstrap.Modal(modalElement);
			        modal.show();
			      } else {
			        console.error("모달이 없습니다.");
			      }
			    },
			    eventDidMount: function(info) {
			    	  const el = info.el;
			    	  const eventDate = new Date(info.event.start);
			    	  

			    	 
			    	  // 기본 스타일 먼저 적용
			    	  el.style.setProperty("background-color", "#F9F9F9", "important");
			    	  el.style.setProperty("border", "1px solid #DDD", "important");
			    	  el.style.setProperty("color", "#000", "important");
			    	  el.style.setProperty("font-size", "12px", "important");
			    	  el.style.setProperty("font-weight", "700", "important");
			    	  el.style.setProperty("padding", "6px 10px", "important");
			    	  el.style.setProperty("margin", "4px 0", "important");
			    	  el.style.setProperty("border-radius", "6px", "important");
			    	  el.style.setProperty("box-shadow", "0 2px 5px rgba(0,0,0,0.05)", "important");
			    	  el.style.setProperty("transition", "background-color 0.2s ease", "important");
			    	  el.style.setProperty("white-space", "nowrap", "important");
			    	  el.style.setProperty("overflow", "hidden", "important");
			    	  el.style.setProperty("text-overflow", "ellipsis", "important");

			    	
			    	 
			    	}
			  });
			
			// 삭제 버튼 누르면 모달 띄우기
			document.getElementById("deleteVehicleBtn").addEventListener("click", function () {
			  const reservationNo = document.getElementById("detailReservationNo").value;
			
			  const modalEl = document.getElementById("messageModal");
			  const modalTitle = document.getElementById("messageModalTitle");
			  const modalBody = document.getElementById("messageModalBody");
			  const modalBtn = document.querySelector("#messageModal .modal-footer button");
			
			  // 1. 확인용 메시지 세팅
			  modalTitle.textContent = "알림";
			  modalBody.textContent = "정말 예약을 취소하시겠습니까?";
			
			  // 2. 기존 버튼 초기화
			  const newBtn = modalBtn.cloneNode(true);
			  modalBtn.parentNode.replaceChild(newBtn, modalBtn);
			  newBtn.textContent = "확인";
			  newBtn.className = "btn btn-primary";
			
			  // 3. 혹시 떠 있는 모달 있으면 닫기
			  document.querySelectorAll(".modal.show").forEach(modalEl => {
			    bootstrap.Modal.getInstance(modalEl)?.hide();
			  });
			
			  // 4. 확인 버튼 클릭 시 → 모달 닫고 삭제 실행
			  newBtn.addEventListener("click", () => {
			    const modalInstance = bootstrap.Modal.getInstance(modalEl);
			    modalInstance.hide();
			
			    // 모달이 완전히 닫힌 후 삭제 요청
			    modalEl.addEventListener("hidden.bs.modal", () => {
			      fetch('/meetingroom/delete/' + reservationNo, {
			        method: "POST",
			        headers: {
			          'header': document.querySelector('meta[name="_csrf_header"]').content,
			          'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			        }
			      })
			        .then(response => response.json())
			        .then(data => {
			          showMessageModal(data.res_msg || "취소가 완료되었습니다.", "알림", true); // 확인 후 새로고침
			        })
			        .catch(error => {
			          console.error("❌ 삭제 중 오류:", error);
			          showMessageModal("삭제 중 오류가 발생했습니다. 다시 시도해주세요.", "오류");
			        });
			    }, { once: true });
			  });
			
			  // 5. 모달 띄우기
			  const confirmModal = new bootstrap.Modal(modalEl);
			  confirmModal.show();
			});

			
			  setTimeout(() => {
			    calendar.render();
			  }, 0);
			});
			</script>

	</main>
</body>
</html>