<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">
<head>
<meta charset="UTF-8">
<title>ì°¨ëŸ‰ ëª©ë¡</title>
</head>


<body>
	<main class="main" id="top" layout:fragment="content">

		<div class="row">
			<!--  ì°¨ëŸ‰ ì˜ˆì•½ ëª©ë¡ (ì™¼ìª½) -->
			<div class="col-md-6">
				<div class="mb-3">
					<div class="d-flex align-items-center mb-2">
						<i class="fas fa-car me-2"></i> <span class="fw-bold fs-7">
							ì°¨ëŸ‰ ì˜ˆì•½</span>
					</div>

					<div id="vehicleTable"
						data-list='{"valueNames":["no","vehicle","passengers","date"], "page": 5, "pagination": true}'>
						<div class="table-responsive">
							<table class="table table-striped table-sm fs-9 mb-0 text-center">
								<thead class="text-center align-middle">
									<tr>
										<th class="sort" data-sort="no" style="width: 5%;">ë²ˆí˜¸</th>
										<th class="sort" data-sort="vehicle" style="width: 25%;">ì°¨ëŸ‰</th>
										<th class="sort" data-sort="passengers" style="width: 20%;">íƒ‘ìŠ¹
											ì¸ì›</th>
										<th class="sort" data-sort="date" style="width: 20%;">ë“±ë¡ì¼</th>
										<th style="width: 10%;"></th>
									</tr>
								</thead>
								<tbody class="list align-middle">
									<tr th:if="${#lists.isEmpty(list)}">
										<td colspan="4">ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜“</td>
									</tr>
									<tr class="align-middle vehicle-row" th:if="${!#lists.isEmpty(list)}"
										th:each="result, resultstatus : ${list}">
										<td class="no" th:text="${resultstatus.count}"></td>
										<td class="vehicle" th:text="${result.facilityName}"></td>
										<td class="passengers" th:text="${result.facilityCapacity}"></td>
										<td class="date"
											th:text="${#temporals.format(result.facilityRegDate, 'yy-MM-dd')}"></td>
										<td class="text-end pe-0"><button
												class="btn btn-sm btn-outline-primary"
												data-bs-toggle="modal" data-bs-target="#addEventModal"
												th:attr="data-facility-no=${result.facilityNo}">
												ì˜ˆì•½í•˜ê¸°</button></td>
									</tr>
								</tbody>
							</table>
							
							</div>
						<div class="modal fade" id="addEventModal" tabindex="-1">
							<div class="modal-dialog modal-dialog-centered">
								<div class="modal-content border border-translucent">
									<form id="addEventForm" autocomplete="off" name="addEventForm">
										<div class="modal-header px-card border-0">
											<h5 class="mb-0 text-body-highlight"> ì°¨ëŸ‰ ì˜ˆì•½</h5>
											<button
												class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-2 me-2 px-2 py-1"
												style="font-size: 0.9rem;" type="button"
												data-bs-dismiss="modal" aria-label="Close">Ã—</button>
										</div>
										
										
										<!-- ëª¨ë‹¬ì°½ ì•ˆì— facilityNoê°’ì„ ë„£ì–´ì£¼ëŠ” script -->
										<script>
										  document.addEventListener("DOMContentLoaded", function () {
										    const modal = document.getElementById("addEventModal");
										    const facilityInput = document.getElementById("modalFacilityNo");
											
										    modal.addEventListener("show.bs.modal", function (event) {
										      const button = event.relatedTarget;
										      const facilityNo = button.getAttribute("data-facility-no");
										     // console.log("facilityNo:", facilityNo); 
										      facilityInput.value = facilityNo;
										    });
										  });
										</script>
										
										
										<!-- ë“±ë¡ ëª¨ë‹¬ì°½ -->
										<div class="modal-body p-4">												
											<!-- ìˆ¨ê²¨ì§„ ê°’ë“¤ -->
											<input type="hidden" name="employee_no"
												th:value="${#authentication.principal.employee.employeeNo}" />
											<input type="hidden" name="facility_no" id="modalFacilityNo" value="" /> 
											<input type="hidden" name="separator_code" value="F002" id="separator">
											<input type="hidden" name="reservation_creator"
												th:value="${#authentication.principal.employee.employeeId}" />

											<!-- ì¥ì†Œ -->
											<div class="mb-3">
												<label for="calendarLocation" class="form-label">
													ëª©ì ì§€</label> <input type="text" class="form-control form-control-sm"
													id="calendarLocation" name="reservation_location"
													placeholder="ëª©ì ì§€ë¥¼ ì ì–´ì£¼ì„¸ìš”" />
											</div>

											<!-- ì‹œê°„ -->
											<div class="row g-2 mb-3">											
												<!-- ë‚ ì§œ ì„ íƒ -->
												<div class="row g-2">
													<div class="col">
														<label class="form-label">ì‹œì‘ ë‚ ì§œ</label> <input type="date"
															id="startDate" class="form-control"   name="reservation_start_date">
													</div>
													<div class="col">
														<label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label> <input type="date"
															id="endDate" class="form-control"   name="reservation_end_date" >
													</div>
												</div>

												<!-- ì‹œê°„ ì„ íƒ -->
												<div class="row g-2 mt-2">
													<div class="col">
														<label class="form-label">ì‹œì‘ ì‹œê°„</label> <select
															id="startTime" class="form-select">
															<option value="09:00">09:00</option>
															<option value="10:00">10:00</option>
															<option value="11:00">11:00</option>
															<option value="12:00">12:00</option>
															<option value="13:00">13:00</option>
															<option value="14:00">14:00</option>
															<option value="15:00">15:00</option>
															<option value="16:00">16:00</option>
															<option value="17:00">17:00</option>
														</select>
													</div>
													<div class="col">
														<label class="form-label">ì¢…ë£Œ ì‹œê°„</label> <select
															id="endTime" class="form-select">
															<option value="10:00">10:00</option>
															<option value="11:00">11:00</option>
															<option value="12:00">12:00</option>
															<option value="13:00">13:00</option>
															<option value="14:00">14:00</option>
															<option value="15:00">15:00</option>
															<option value="16:00">16:00</option>
															<option value="17:00">17:00</option>
															<option value="18:00">18:00</option>
															<option value="19:00">19:00</option>
															<option value="20:00">20:00</option>
															<option value="21:00">21:00</option>
															<option value="22:00">22:00</option>
															<option value="23:00">23:00</option>														
														</select>
													</div>
												</div>

												<!-- ìˆ¨ê²¨ì„œ ì„œë²„ë¡œ ë³´ë‚¼ datetime-local ê°’ -->
												<input type="hidden" name="reservation_start"
													id="calendarStartTime"> <input type="hidden"
													name="reservation_end" id="calendarEndTime">

												<!-- 	<div class="col">
													<label for="calendarStartTime" class="form-label">
														ì‹œì‘ì‹œê°„</label> <input type="datetime-local"
														class="form-control form-control-sm"
														id="calendarStartTime" name="reservation_start" />
												</div>
												<div class="col">
													<label for="calendarEndTime" class="form-label">
														ì¢…ë£Œì‹œê°„</label> <input type="datetime-local"
														class="form-control form-control-sm" id="calendarEndTime"
														name="reservation_end" />
												</div> -->
											</div>
										</div>
										<div class="modal-footer border-0 px-4 pb-3">
											<button class="btn btn-primary w-100" type="submit">ğŸš˜
												ì˜ˆì•½í•˜ê¸°</button>
										</div>
									</form>
								</div>
							</div>
						</div>
						
						<!-- ë“±ë¡ì„ ìœ„í•œ fetch -->
						<script>
						  const form = document.addEventForm;
						
						  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
						  const today = new Date().toISOString().split("T")[0];
						  form.reservation_start_date.value = today;
						  form.reservation_end_date.value = today;
						  form.reservation_start_date.min = today;
						  form.reservation_end_date.min = today;
						
						  // ì‹œì‘ ë‚ ì§œ ë³€ê²½ ì‹œ, ì¢…ë£Œ ë‚ ì§œ ì œí•œ
						  form.reservation_start_date.addEventListener("change", function () {
						    const start = form.reservation_start_date.value;
						    form.reservation_end_date.min = start;
						
						    if (form.reservation_end_date.value < start) {
						      form.reservation_end_date.value = start;
						    }
						  });
						
						  // ì˜ˆì•½ ë“±ë¡!
						  form.addEventListener('submit', function(e) {
						    e.preventDefault();
						
						    if (!form.reservation_location.value) {
						      alert('ëª©ì ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
						      return;
						    }
						
						    const startDate = form.reservation_start_date.value;
						    const endDate = form.reservation_end_date.value;
						    const startTime = form.startTime.value;
						    const endTime = form.endTime.value;
						
						    if (!startDate || !endDate || !startTime || !endTime) {
						      alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”!");
						      return;
						    }
						
						    const fullStart = `${startDate}T${startTime}`;
						    const fullEnd = `${endDate}T${endTime}`;
						
						    if (fullStart >= fullEnd) {
						      alert("ì¢…ë£Œì¼ì‹œëŠ” ì‹œì‘ì¼ì‹œë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤!");
						      return;
						    }
						
						    form.calendarStartTime.value = fullStart;
						    form.calendarEndTime.value = fullEnd;
						
						    const payload = new FormData(form);
						    fetch('/resvehicle/reservation', {
						      method: 'post',
						      headers: {
						        'header': document.querySelector('meta[name="_csrf_header"]').content,
						        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
						      },
						      body: payload
						    })
						    .then(response => response.json())
						    .then(data => {
						      alert(data.res_msg);
						      if (data.res_code == 200) {
						        location.reload();
						      }
						    });
						  });
						  
						  form.reservation_start_date.addEventListener("change", function () {
							  const start = form.reservation_start_date.value;
							  const facilityNo = document.getElementById("modalFacilityNo").value;

							  form.reservation_end_date.min = start;
							  if (form.reservation_end_date.value < start) {
							    form.reservation_end_date.value = start;
							  }

							  // ğŸš€ ì˜ˆì•½ëœ ì‹œê°„ ì¡°íšŒ
							  fetch(`/resvehicle/booked-times?date=${start}&facilityNo=${facilityNo}`)
							    .then(response => response.json())
							    .then(bookedTimes => {
							      disableReservedTimes(bookedTimes);
							    });
							});

							// âœ… ì˜ˆì•½ ì‹œê°„ ë¹„í™œì„±í™” í•¨ìˆ˜
							function disableReservedTimes(bookedTimes) {
							  const startSelect = form.startTime;
							  const endSelect = form.endTime;

							  [...startSelect.options, ...endSelect.options].forEach(opt => {
							    opt.disabled = false;
							    opt.textContent = opt.value;
							  });

							  bookedTimes.forEach(time => {
							    const sOpt = [...startSelect.options].find(o => o.value === time);
							    const eOpt = [...endSelect.options].find(o => o.value === time);

							    if (sOpt) {
							      sOpt.disabled = true;
							      sOpt.textContent += " (ì˜ˆì•½ë¨)";
							    }
							    if (eOpt) {
							      eOpt.disabled = true;
							      eOpt.textContent += " (ì˜ˆì•½ë¨)";
							    }
							  });
							}
						</script>


						<!-- í˜ì´ì§• -->
						<div class="d-flex justify-content-center mt-3">
							<div class="d-flex">
								<button class="page-link disabled" data-list-pagination="prev"
									disabled>
									<i class="fas fa-chevron-left"></i>
								</button>
								<ul class="mb-0 pagination">
									<li class="active">
										<button class="page" type="button" data-i="1" data-page="5">1</button>
									</li>
								</ul>
								<button class="page-link pe-0" data-list-pagination="next"
									disabled>
									<i class="fas fa-chevron-right"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>

		

			<!-- ìº˜ë¦°ë” (ì˜¤ë¥¸ìª½) -->
			<div class="col-md-6">
				<div class="calendar-outline" id="appCalendar"
					style="height: 400px;"></div>
				</div>
			</div>
		<!-- ìº˜ë¦°ë” script -->
		<script>
		document.addEventListener('DOMContentLoaded', function () {
			  const calendarEl = document.getElementById('appCalendar');
			  const separator = document.getElementById('separator').value;
			  //console.log(separator+"!!!!!!!!!!!!!!!");
			  const calendar = new FullCalendar.Calendar(calendarEl, {
			      initialView: 'dayGridMonth',
			      locale: 'ko',		      
			      headerToolbar: {
			        left: 'prev,next today',
			        center: 'title',
			        right: ''
			      },
			      buttonText: {
			    	    today: 'ì˜¤ëŠ˜' 
			    	  },
			      dayMaxEventRows: true,
			      views: {
			        dayGridMonth: {
			          dayMaxEventRows: 3,
			          moreLinkText: "ë”ë³´ê¸°"		       
			          }
			      },
			      eventSources: [ //êµ¬ê¸€ ìº˜ë¦°ë”ë¡œ ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¤ê¸°, ì˜ˆì•½ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸°
			    	    {
			    	      events: function (fetchInfo, successCallback, failureCallback) {
			    	        fetch('/resvehicle/list/' + separator)
			    	          .then(response => response.json())
			    	          .then(events => successCallback(events))
			    	          .catch(error => {
			    	            console.error("ì°¨ëŸ‰ ì˜ˆì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹ªíŒ¨", error);
			    	            failureCallback(error);
			    	          });
			    	      }
			    	    },
			    	    {
			    	      events: function (fetchInfo, successCallback, failureCallback) {
			    	        const apiKey = 'AIzaSyCjXiu1ShbhE0XenBtciLx8ezU-mcZI0R0';
			    	        const calendarId = 'ko.south_korea%23holiday@group.v.calendar.google.com';
			    	        const timeMin = new Date(fetchInfo.start).toISOString();
			    	        const timeMax = new Date(fetchInfo.end).toISOString();
			    	        const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;

			    	        fetch(url)
			    	          .then(response => response.json())
			    	          .then(data => {
			    	            if (!data.items) {
			    	              console.warn("ê³µíœ´ì¼ ë°ì´í„° ì—†ìŒ", data);
			    	              return successCallback([]);
			    	            }
			    	            const holidays = data.items.map(item => ({
			    	              title: item.summary,
			    	              start: item.start.date,
			    	              allDay: true,
			    	              extendedProps: {
			    	            	    type: 'holiday'
			    	            	  }
			    	              
			    	            }));
			    	            successCallback(holidays);
			    	          })
			    	          .catch(error => {
			    	            console.error("ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error);
			    	            failureCallback(error);
			    	          });
			    	      }
			    	    }
			    	  ],
			      eventDisplay: 'block',
			      dayCellContent: function (info) {
			        return info.date.getDate();
			      },
			      eventDidMount: function(info) {
			    	  const eventEl = info.el;

			    	 

			    	  // ì´ˆìŠ¬ë¦¼ ìŠ¤íƒ€ì¼ ì ìš©
			    	  eventEl.style.setProperty("font-size", "9px", "important");
			    	  eventEl.style.setProperty("font-weight", "400", "important");
			    	  eventEl.style.setProperty("padding", "0 2px", "important");
			    	  eventEl.style.setProperty("margin", "1px 0", "important");
			    	  eventEl.style.setProperty("border-radius", "2px", "important");
			    	  eventEl.style.setProperty("height", "auto", "important");

			    	
			    	  eventEl.style.setProperty("white-space", "nowrap", "important");
			    	  eventEl.style.setProperty("overflow", "hidden", "important");
			    	  eventEl.style.setProperty("text-overflow", "ellipsis", "important");

			    	  
			    	  const eventMain = eventEl.querySelector(".fc-event-main");
			    	  if (eventMain) {
			    	    eventMain.style.setProperty("white-space", "nowrap", "important");
			    	    eventMain.style.setProperty("overflow", "hidden", "important");
			    	    eventMain.style.setProperty("text-overflow", "ellipsis", "important");
			    	    eventMain.style.setProperty("font-size", "9px", "important");
			    	  }
			    }
			  });

			  	// setTimeout ì‚¬ìš©
				/* <head>ì— ìˆëŠ” FullCalendar CSS íŒŒì¼ì´ ì•„ì§ ë¡œë“œ ì¤‘ì´ë¼
				ìº˜ë¦°ë”ëŠ” ê·¸ë ¤ì¡Œì§€ë§Œ ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ë‚˜ì™€ë²„ë¦¼. */
			  setTimeout(() => {
			    calendar.render();
			  }, 0); 
			});
		</script>
	</main>
</body>
</html>