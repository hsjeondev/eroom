<!DOCTYPE html>
<html lang="ko-KR" dir="ltr" data-navigation-type="default"
	data-navbar-horizontal-shape="default"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">
<body>
	<main class="main" id="top" layout:fragment="content">
		<!-- ì—¬ê¸°ì— ìš”ì†Œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤. -->
		<script>
		  let isGroupChat = false;
		  // "DOMContentLoaded" = HTML ì´ ë‹¤ ê·¸ë ¤ì§€ê³  ë‚œ í›„ ì‹¤í–‰ë¨
		  document.addEventListener("DOMContentLoaded", () => {
		    const chatTypeRadios = document.querySelectorAll('input[name="chatIsGroup"]');
		    chatTypeRadios.forEach(radio => {
		      radio.addEventListener('change', (e) => {
		        isGroupChat = e.target.value === 'Y';
		        console.log("ì±„íŒ… íƒ€ì… ë³€ê²½ë¨:", isGroupChat ? 'ê·¸ë£¹' : '1:1');
		      });
		    });
		  });
		
		  function changeDepartment(dept) {
		    console.log("ì„ íƒëœ ë¶€ì„œ:", dept);
		    fetch('/chat/employes?department=' + encodeURIComponent(dept))
		      .then(response => response.json())
		      .then(data => {
		        const select = document.getElementById('employeeSelect');
		        select.innerHTML = '<option selected disabled>-- ì°¸ì—¬ì ì„ íƒ --</option>';
		
		        data.forEach(emp => {
		          const option = document.createElement('option');
		          option.text = emp.employee_name;
		          console.log(option.text);
		          option.value = emp.employee_no;
		          select.appendChild(option);
		        });
		
		        // ì±„íŒ… íƒ€ì…ì— ë”°ë¼ ì°¸ì—¬ì ì„ íƒ ë°©ì‹ì„ ë°”ê¿”ì¤Œ
		        select.multiple = isGroupChat;
		      })
		      .catch(error => console.error('ë¶€ì„œ ì§ì› ë¡œë”© ì‹¤íŒ¨:', error));
		  }
		</script>
		<script>
		  function addParticipant() {
		    const select = document.getElementById('employeeSelect');
		    const selectedOption = select.options[select.selectedIndex];
		
		    if (!selectedOption || selectedOption.disabled) {
		      alert('ì°¸ì—¬ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
		      return;
		    }
		
		    const participantId = selectedOption.value;
		    const participantName = selectedOption.text;
		
		    // ì´ë¯¸ ì¶”ê°€ëœ ì°¸ì—¬ì ìˆ˜ í™•ì¸
		    const currentCount = document.querySelectorAll('#selectedParticipants .badge').length;
		
		    // 1:1 ì±„íŒ…ì¼ ê²½ìš° 1ëª…ê¹Œì§€ë§Œ í—ˆìš©
		    if (!isGroupChat && currentCount >= 1) {
		      alert('1:1 ì±„íŒ…ì€ í•œ ëª…ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
		      return;
		    }
		
		    // ì¤‘ë³µ ë°©ì§€
		    if (document.getElementById('participant-' + participantId)) {
		      alert('ì´ë¯¸ ì¶”ê°€ëœ ì°¸ì—¬ìì…ë‹ˆë‹¤.');
		      return;
		    }
		
		    const badge = document.createElement('span');
		    badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
		    badge.id = 'participant-' + participantId;
		
		    badge.innerHTML = `
		      ${participantName}
		      <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="removeParticipant('${participantId}')"></button>
		      <input type="hidden" name="participantIds" value="${participantId}">
		      `;
		
		    document.getElementById('selectedParticipants').appendChild(badge);
		  }
		
		  function removeParticipant(id) {
		    const badge = document.getElementById('participant-' + id);
		    if (badge) badge.remove();
		  }
		</script>

		<div class="chat d-flex phoenix-offcanvas-container pt-1 mt-n1 mb-9">
			<div
				class="card p-3 p-xl-1 mt-xl-n1 chat-sidebar me-3 phoenix-offcanvas phoenix-offcanvas-start"
				id="chat-sidebar">
				<button class="btn d-none d-sm-block d-xl-none mb-2"
					data-bs-toggle="modal" data-bs-target="#chatSearchBoxModal">
					<span
						class="fa-solid fa-magnifying-glass text-body-tertiary text-opacity-85 fs-7"></span>
				</button>
				<div class="d-none d-sm-block d-xl-none mb-5">
					<button class="btn w-100 mx-auto" type="button"
						data-bs-toggle="dropdown" data-boundary="window"
						aria-haspopup="true" aria-expanded="false"
						data-bs-reference="parent">
						<span
							class="fa-solid fa-bars text-body-tertiary text-opacity-85 fs-7"></span>
					</button>
					<ul class="dropdown-menu dropdown-menu-end p-0">
						<li><a class="dropdown-item" href="#!">All</a></li>
						<li><a class="dropdown-item" href="#!">Read</a></li>
						<li><a class="dropdown-item" href="#!">Unread</a></li>
					</ul>
				</div>
				<!-- âœ¨ ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸° ë²„íŠ¼ -->
				<div class="d-grid gap-2 mb-3">
					<button class="btn btn-outline-primary" data-bs-toggle="modal"
						data-bs-target="#createChatModal">+ ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
				</div>
				<!-- ê²€ìƒ‰ê¸°ëŠ¥ ìš°ì„ ìˆœìœ„ ìµœí•˜ìœ„ -->
				<div class="form-icon-container mb-4 d-sm-none d-xl-block">
					<input class="form-control form-icon-input" type="text"
						placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" /><span
						class="fas fa-user text-body fs-9 form-icon"></span>
				</div>
				<ul class="nav nav-phoenix-pills mb-5 d-sm-none d-xl-flex"
					id="contactListTab" data-chat-thread-tab="data-chat-thread-tab"
					role="tablist">
					<!-- ì •ë ¬ê¸°ëŠ¥  -->
					<li class="nav-item" role="presentation"><a
						class="nav-link cursor-pointer active" data-bs-toggle="tab"
						data-chat-thread-list="all" role="tab" aria-selected="true">ì „ì²´</a></li>
					<li class="nav-item" role="presentation"><a
						class="nav-link cursor-pointer" data-bs-toggle="tab" role="tab"
						data-chat-thread-list="read" aria-selected="false">ì½ì§€ì•ŠìŒ</a></li>
					<li class="nav-item" role="presentation"><a
						class="nav-link cursor-pointer" data-bs-toggle="tab" role="tab"
						data-chat-thread-list="unread" aria-selected="false">ì½ìŒ</a></li>
				</ul>
				<div class="scrollbar">
					<div class="tab-content" id="contactListTabContent">
						<div data-chat-thread-tab-content="data-chat-thread-tab-content">
							<ul class="nav chat-thread-tab flex-column list">

								<!-- ì°¸ì—¬ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ì„ë•Œ -->
								<div th:if="${#lists.isEmpty(chatroomList)}">
									<p class="text-center text-muted mt-4">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
								</div>

								<!-- ì±„íŒ… ë¦¬ìŠ¤íŠ¸ ì½ì€ì‚¬ëŒ-->
								<li th:if="${!#lists.isEmpty(chatroomList)}"
									th:each="chatroom : ${chatroomList}"
									th:attr="data-room-no=${chatroom.chatroomNo}"
									class="nav-item read mb-1" role="presentation">
									<!-- ì„ íƒëœ ì‚¬ëŒì€ a class ëì— active ë„£ìœ¼ë©´ë¨ --> <a
									class="nav-link d-flex align-items-center justify-content-center p-2  "
									data-bs-toggle="tab" data-chat-thread="data-chat-thread"
									href="#tab-thread-1" role="tab" aria-selected="true"> <!-- ì´ë¯¸ì§€ ë¶€ë¶„ -->
										<!-- <div class="avatar avatar-xl status-online position-relative me-2 me-sm-0 me-xl-2">
                        	<img class="rounded-circle border border-2 border-light-subtle" src="../assets/img/team/20.webp" alt="" />
                        </div>  -->
										<div class="flex-1 d-sm-none d-xl-block">
											<div
												class="d-flex justify-content-between align-items-center">
												<h5 th:text="${chatroom.chatroomName}"
													class="text-body fw-normal name text-nowrap">ì±„íŒ…ë°© ì´ë¦„</h5>
												<p
													class="fs-10 text-body-tertiary text-opacity-85 mb-0 text-nowrap">
													ì‹œê°„ì€ ì¼ë‹¨ ë³´ë¥˜</p>
											</div>
											<div class="d-flex justify-content-between">
												<p th:text="${chatroom.chatLastMessage}"
													class="fs-9 mb-0 line-clamp-1 text-body-tertiary text-opacity-85 message">
													ë§ˆì§€ë§‰ë©”ì‹œì§€</p>
											</div>
										</div>
								</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<!-- ì±„íŒ…ë°©ë§Œë“¤ê¸° ëª¨ë‹¬í˜ì´ì§€-->
			<div class="modal fade" id="createChatModal" tabindex="-1"
				aria-labelledby="createChatModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
						<h3>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h3>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="ë‹«ê¸°"></button>
						</div>
				<!-- ğŸ”˜ ì±„íŒ… ì¢…ë¥˜ ì„ íƒ -->
				<form th:action="@{/chat/create}" method="post">
				  <div class="modal-body">
					<div class="mb-3">
					  <label class="form-label">ì±„íŒ… ì¢…ë¥˜</label>
					  <div id="chatTypeGroup">
					    <input type="radio" name="chatIsGroup" value="N" checked> 1:1 ì±„íŒ…
					    <input type="radio" name="chatIsGroup" value="Y"> ê·¸ë£¹ ì±„íŒ…
					  </div>
					</div>
					    <div class="mb-3" id="chatroomNameBox">
					      <label class="form-label">ì±„íŒ…ë°© ì´ë¦„</label>
					      <input type="text" name="chatroomName" class="form-control"
					             placeholder="ì˜ˆ: ê°œë°œíŒ€ ì±„íŒ…ë°©">
					    </div>
					
					    <!-- ë¶€ì„œ ì„ íƒ -->
					    <div class="mb-3">
						  <label class="form-label">ë¶€ì„œ</label>
						  <select class="form-select" id="departmentSelect" onchange="changeDepartment(this.value)">
						    <option disabled selected>-- ë¶€ì„œ ì„ íƒ --</option>
						    <option th:each="dept : ${departmentList}" 
						            th:value="${dept}" 
						            th:text="${dept}" 
						            th:selected="${dept == param.department}"></option>
						  </select>
						</div>
					    <!-- ì°¸ì—¬ì ì„ íƒ -->
						<div class="mb-3">
						  <label class="form-label">ì°¸ì—¬ì ì„ íƒ</label>
						  <div class="d-flex"> 
						      <select id="employeeSelect" class="form-select me-2" style="flex:1;">
								  <option selected disabled>-- ì°¸ì—¬ì ì„ íƒ --</option>
								</select>
						    <button type="button" class="btn btn-outline-primary" onclick="addParticipant()">ì¶”ê°€</button>
						  </div>
						</div>
						
						<!-- ì„ íƒëœ ì°¸ì—¬ì ë³´ì—¬ì£¼ê¸° -->
						<div class="mb-3">
						  <label class="form-label">ì„ íƒëœ ì°¸ì—¬ì</label>
						  <div id="selectedParticipants">
						    <!-- ì—¬ê¸°ì— badge ì¶”ê°€ë¨ -->
						  </div>
						</div>
					  </div>
					
					  <div class="modal-footer">
					    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
					    <button type="submit" class="btn btn-primary">ìƒì„±</button>
					  </div>
					</form>

					</div>
				</div>
			</div>
			<!--ì±„íŒ…ë°© ì±„íŒ…ë°©ë§Œë“¤ê¸° ì²˜ìŒí™”ë©´  -->
			<div class="card tab-content flex-1 phoenix-offcanvas-container">
				<div class="tab-pane h-100 fade active show" id="tab-thread-1"
					role="tabpanel" aria-labelledby="tab-thread-1">
					<div class="d-flex flex-column h-100">
						<div id="default-chat-area"
							class="d-flex flex-column justify-content-center align-items-center h-100">
							<h4 class="text-body-secondary mb-2">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h4>
							<a href="#" class="fw-bold text-primary text-decoration-none"
								data-bs-toggle="modal" data-bs-target="#createChatModal"> ìƒˆ
								ì±„íŒ…ë°© ë§Œë“¤ê¸° </a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
	
</body>
</html>