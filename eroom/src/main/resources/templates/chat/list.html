<!DOCTYPE html>
<html lang="ko-KR" dir="ltr" data-navigation-type="default"
    data-navbar-horizontal-shape="default"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/include/layout}">
    <style>
	/* ê¸°ë³¸ ìƒíƒœ: ì˜¤ë¥¸ìª½ ì˜ì—­ì€ íˆ¬ëª…í•˜ê³  ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì•½ê°„ ì´ë™í•œ ìƒíƒœ */
	.tab-pane {
	  opacity: 0;
	  transform: translateX(50px);
	  transition: opacity 0.3s ease, transform 0.3s ease;
	  pointer-events: none;
	}
	
	/* í™œì„±í™”ëœ ìƒíƒœ: í´ë¦­ ì‹œ 'active' í´ë˜ìŠ¤ê°€ ì¶”ê°€ë˜ì–´ ë‚˜íƒ€ë‚¨ */
	.tab-pane.active {
	  opacity: 1;
	  transform: translateX(0);
	  pointer-events: auto;
	}
	
	</style>
<body>
  <main class="main" id="top" layout:fragment="content">
    <div class="chat d-flex phoenix-offcanvas-container pt-1 mt-n1 mb-9">
      <!-- ì™¼ìª½ ì±„íŒ… ëª©ë¡ ì˜ì—­ -->
      <div class="card p-3 p-xl-1 mt-xl-n1 chat-sidebar me-3 phoenix-offcanvas phoenix-offcanvas-start" id="chat-sidebar">
        <button class="btn d-none d-sm-block d-xl-none mb-2" data-bs-toggle="modal" data-bs-target="#chatSearchBoxModal">
          <span class="fa-solid fa-magnifying-glass text-body-tertiary text-opacity-85 fs-7"></span>
        </button>
        <div class="d-none d-sm-block d-xl-none mb-5">
          <button class="btn w-100 mx-auto" type="button" data-bs-toggle="dropdown" data-boundary="window"
            aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
            <span class="fa-solid fa-bars text-body-tertiary text-opacity-85 fs-7"></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end p-0">
            <li><a class="dropdown-item" href="#!">All</a></li>
            <li><a class="dropdown-item" href="#!">Read</a></li>
            <li><a class="dropdown-item" href="#!">Unread</a></li>
          </ul>
        </div>
        <!-- ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸° ë²„íŠ¼ -->
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createChatModal">
            + ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°
          </button>
        </div>
        <!-- ê²€ìƒ‰ ì…ë ¥ë€ (ë°ìŠ¤í¬íƒ‘) -->
        <div class="form-icon-container mb-4 d-sm-none d-xl-block">
          <input class="form-control form-icon-input" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
          <span class="fas fa-user text-body fs-9 form-icon"></span>
        </div>
        <!-- íƒ­ ë©”ë‰´ (ì „ì²´, ì½ì§€ì•ŠìŒ, ì½ìŒ) -->
        <ul class="nav nav-phoenix-pills mb-5 d-sm-none d-xl-flex"
          id="contactListTab" data-chat-thread-tab="data-chat-thread-tab" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link cursor-pointer active" data-bs-toggle="tab"
              data-chat-thread-list="all" role="tab" aria-selected="true">ì „ì²´</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link cursor-pointer" data-bs-toggle="tab"
              role="tab" data-chat-thread-list="read" aria-selected="false">ì½ì§€ì•ŠìŒ</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link cursor-pointer" data-bs-toggle="tab"
              role="tab" data-chat-thread-list="unread" aria-selected="false">ì½ìŒ</a>
          </li>
        </ul>
        <!-- ì±„íŒ… ëª©ë¡ -->
        <div class="scrollbar">
          <div class="tab-content" id="contactListTabContent">
            <div data-chat-thread-tab-content="data-chat-thread-tab-content">
              <ul class="nav chat-thread-tab flex-column list chat_list">
                <!-- ì±„íŒ…ë°©ì´ ì—†ì„ ê²½ìš° -->
                <div th:if="${#lists.isEmpty(chatroomList)}">
                  <p class="text-center text-muted mt-4">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                <!-- ì±„íŒ…ë°© ëª©ë¡ (ë°˜ë³µ ë Œë”ë§) -->
                <li th:if="${!#lists.isEmpty(chatroomList)}"
                  th:each="chatroom : ${chatroomList}"
                  th:attr="data-room-no=${chatroom.chatroomNo}"
                  class="nav-item read mb-1" role="presentation">
                  <a class="nav-link d-flex align-items-center justify-content-center p-2"
                    data-bs-toggle="tab" data-chat-thread="data-chat-thread"
                    th:href="'#chatroom-' + ${chatroom.chatroomNo}" role="tab" aria-selected="true">
                    <!-- ì•„ë°”íƒ€ ì´ë¯¸ì§€ -->
                    <div class="avatar avatar-xl status-online position-relative me-2 me-sm-0 me-xl-2">
                      <img class="rounded-circle border border-2 border-light-subtle" src="../assets/img/team/20.webp" alt="" />
                    </div>
                    <div class="flex-1 d-sm-none d-xl-block">
                      <div class="d-flex justify-content-between align-items-center">
                        <h5 th:text="${chatroom.chatroomName}"
                          class="text-body fw-normal name text-nowrap">ì±„íŒ…ë°© ì´ë¦„</h5>
                        <p class="fs-10 text-body-tertiary text-opacity-85 mb-0 text-nowrap">ì‹œê°„ì€ ì¼ë‹¨ ë³´ë¥˜</p>
                      </div>
                      <div class="d-flex justify-content-between">
                        <p th:text="${chatroom.chatLastMessage}"
                          class="fs-9 mb-0 line-clamp-1 text-body-tertiary text-opacity-85 message">
                          ë§ˆì§€ë§‰ë©”ì‹œì§€</p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
      <div class="modal fade" id="createChatModal" tabindex="-1"
        aria-labelledby="createChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h3>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h3>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="ë‹«ê¸°"></button>
            </div>
            <form id="createChatForm">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <div class="modal-body">
                <!-- ì±„íŒ… ì¢…ë¥˜ ì„ íƒ -->
                <div class="mb-3">
                  <label class="form-label">ì±„íŒ… ì¢…ë¥˜</label>
                  <div id="chatTypeGroup">
                    <input type="radio" name="chatIsGroupYn" value="N" checked> 1:1 ì±„íŒ…
                    <input type="radio" name="chatIsGroupYn" value="Y"> ê·¸ë£¹ ì±„íŒ…
                  </div>
                </div>
                <div class="mb-3" id="chatroomNameBox">
                  <label class="form-label">ì±„íŒ…ë°© ì´ë¦„</label>
                  <input type="text" id="chatroomName" name="chatroomName" class="form-control"
                    placeholder="ì˜ˆ: ê°œë°œíŒ€ ì±„íŒ…ë°©" readonly>
                </div>
                <!-- ë¶€ì„œ(ì†Œì†) ì„ íƒ -->
                <div class="mb-3">
                  <label class="form-label">ì†Œì†</label>
                  <select class="form-select" id="departmentSelect" onchange="changeDepartment(this.value)">
                    <option disabled selected>-- ì†Œì† ì„ íƒ --</option>
                    <option th:each="dept : ${structureList}" 
                      th:value="${dept.separator_code}" 
                      th:text="${dept.separator_name}" 
                      th:selected="${dept.separator_name == param.department}">
                    </option>
                  </select>
                </div>
                <!-- ì°¸ì—¬ì ì„ íƒ -->
                <div class="mb-3">
                  <label class="form-label">ì°¸ì—¬ì ì„ íƒ</label>
                  <div class="d-flex">
                    <select id="employeeSelect" class="form-select me-2" style="flex:1;">
                      <option disabled selected>-- ì°¸ì—¬ì ì„ íƒ --</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" onclick="addParticipant()">ì¶”ê°€</button>
                  </div>
                </div>
                <!-- ì„ íƒëœ ì°¸ì—¬ì í‘œì‹œ -->
                <div class="mb-3">
                  <label class="form-label">ì„ íƒëœ ì°¸ì—¬ì</label>
                  <div id="selectedParticipants">
                    <!-- badge í˜•íƒœë¡œ ì¶”ê°€ -->
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ìƒì„±</button>
              </div>
              <div>
                <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- ì˜¤ë¥¸ìª½ ì±„íŒ… ì˜ì—­ (ì„ íƒ ì „ ê¸°ë³¸ í™”ë©´) -->
      <div class="card tab-content flex-1 phoenix-offcanvas-container" id="chat-content">
      
        <div class="tab-pane h-100 fade active show" id="tab-thread-1"
          role="tabpanel" aria-labelledby="tab-thread-1">
          <div class="d-flex flex-column h-100">
            <div id="default-chat-area" class="d-flex flex-column justify-content-center align-items-center h-100">
              <h4 class="text-body-secondary mb-2">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h4>
              <a href="#" class="fw-bold text-primary text-decoration-none"
                data-bs-toggle="modal" data-bs-target="#createChatModal">
                ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°
              </a>
            </div>
          </div>
        </div>
      </div>
      
    </div>
		 <script>
		// ì±„íŒ… ì¢…ë¥˜ ì „í™˜ ë° ì±„íŒ…ë°© ì´ë¦„ readOnly ì²˜ë¦¬
		 let isGroupChat = false;
		 const chatTypeRadios = document.querySelectorAll('input[name="chatIsGroupYn"]');
		 const chatroomNameInput = document.getElementById("chatroomName");

		 chatTypeRadios.forEach(radio => {
		   radio.addEventListener('change', (e) => {
		     isGroupChat = (e.target.value === 'Y');
		     console.log("ì±„íŒ… íƒ€ì… ë³€ê²½ë¨:", isGroupChat ? 'ê·¸ë£¹' : '1:1');
		     chatroomNameInput.readOnly = !isGroupChat;
		     if (!isGroupChat) {
		       chatroomNameInput.value = "";
		     }
		   });
		 });

		 // í¼ ì œì¶œ ì „ ê·¸ë£¹ ì±„íŒ… ì œëª© ìœ íš¨ì„± ì²´í¬ ë° ì±„íŒ…ë°© ìƒì„± ì²˜ë¦¬
		 document.getElementById("createChatForm").addEventListener("submit", function(e) {
		   e.preventDefault();
		   if (isGroupChat) {
		     const chatRoomName = chatroomNameInput.value.trim();
		     if (chatRoomName === "") {
		       alert("ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		       return;
		     }
		   }
		   const formData = new FormData(this);
		   fetch('/chat/create', {
		     method: 'post',
		     body: formData
		   })
		   .then(response => response.json())
		   .then(data => {
		     if (data.res_code === "200") {
		       alert("ì±„íŒ…ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
		       const modalElem = document.getElementById('createChatModal');
		       const modalInstance = bootstrap.Modal.getInstance(modalElem);
		       if (modalInstance) {
		         modalInstance.hide();
		       }
		     } else {
		       alert("ì˜¤ë¥˜: " + data.res_msg);
		     }
		   })
		   .catch(error => {
		     console.error('Error:', error);
		     alert("ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		   });
		 });

		 // ë¶€ì„œ ì„ íƒ ì‹œ ì§ì› ëª©ë¡ ë¡œë”©
		 function changeDepartment(deptId) {
		   console.log("ì„ íƒëœ ë¶€ì„œ ID:", deptId);
		   fetch('/chat/employes?separator_code=' + encodeURIComponent(deptId))
		     .then(response => response.json())
		     .then(data => {
		       console.log(data);
		       const select = document.getElementById('employeeSelect');
		       select.innerHTML = '<option disabled selected>-- ì°¸ì—¬ì ì„ íƒ --</option>';
		       data.forEach(emp => {
		         const option = document.createElement('option');
		         option.value = emp.employee_no;
		         option.text = emp.employee_name;
		         select.appendChild(option);
		       });
		       select.multiple = isGroupChat;
		     })
		     .catch(error => console.error('ì§ì› ë¡œë”© ì‹¤íŒ¨:', error));
		 }

		 // ì°¸ì—¬ì ì¶”ê°€ í•¨ìˆ˜: ì„ íƒëœ ì°¸ì—¬ìë¥¼ badge í˜•íƒœë¡œ í‘œì‹œ
		 function addParticipant() {
		   const chatTypeRadio = document.querySelector('input[name="chatIsGroupYn"]:checked');
		   const isGroupChat = chatTypeRadio && chatTypeRadio.value === 'Y'; 
		   const select = document.getElementById('employeeSelect');
		   const selectedOptions = Array.from(select.selectedOptions);
		   
		   if (selectedOptions.length === 0) {
		     alert('ì°¸ì—¬ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
		     return;
		   }
		   const currentCount = document.querySelectorAll('#selectedParticipants .badge').length;
		   if (!isGroupChat && (currentCount + selectedOptions.length > 1)) {
		     alert('1:1 ì±„íŒ…ì€ í•œ ëª…ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
		     return;
		   }
		   selectedOptions.forEach(option => {
		     const participantId = option.value;
		     const participantName = option.text;
		     if (document.getElementById('participant-' + participantId)) {
		       alert('ì´ë¯¸ ì¶”ê°€ëœ ì°¸ì—¬ì ì…ë‹ˆë‹¤.');
		       return;
		     }
		     const badge = document.createElement('span');
		     badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
		     badge.id = 'participant-' + participantId;
		     badge.innerHTML = `
		       ${participantName}
		       <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="removeParticipant('${participantId}')"></button>
		       <input type="hidden" name="participantIds" value="${participantId}">
		     `;
		     document.getElementById('selectedParticipants').appendChild(badge);
		     if (!isGroupChat) {
		       document.getElementById("chatroomName").value = participantName;
		     }
		   });
		   select.selectedIndex = -1;
		 }

		 // ì°¸ì—¬ì ì œê±° í•¨ìˆ˜: badge ì œê±° ë° ì´ë¦„ ì´ˆê¸°í™” (1:1 ì±„íŒ… ì‹œ)
		 function removeParticipant(id) {
		   const badge = document.getElementById('participant-' + id);
		   if (badge) badge.remove();
		   if (!isGroupChat) {
		     document.getElementById("chatroomName").value = "";
		   }
		 }
		 // ì±„íŒ…ë°© ë””í…Œì¼?
		 document.querySelectorAll('[data-chat-thread]').forEach(chatLink => {
			  chatLink.addEventListener('click', function (e) {
			    e.preventDefault();

			    // 1. ì˜¤ë¥¸ìª½ ê¸°ë³¸ ì•ˆë‚´ ì œê±°
			    const defaultArea = document.getElementById('default-chat-area');
			    if (defaultArea) {
			      defaultArea.style.display = 'none';
			    }

			    // 2. ì„ íƒëœ ì±„íŒ…ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
			    const chatroomName = this.querySelector('.name')?.innerText || 'ì•Œ ìˆ˜ ì—†ìŒ';
			   

			    // 3. ìƒˆë¡œìš´ ë‚´ìš© ë™ì  ì‚½ì…
			    const chatContent = document.getElementById('chat-content');

			    // ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€
			    chatContent.innerHTML = `
			    	  <div class="tab-pane h-100 fade show active d-flex flex-column">

			    	    <!-- ì±„íŒ…ë‚´ìš©ì´ ë“¤ì–´ê°€ëŠ” ì˜ì—­ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥ + ë‚¨ëŠ” ê³µê°„ ì°¨ì§€) -->
			    	    <div class="flex-grow-1 overflow-auto p-4">
			    	      <h4 class="mb-3">${chatroomName}</h4>
			    	      <div class="chat-history">
			    	        <hr>
			    	        <p>ğŸ“© ì±„íŒ… ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ (ì¶”ê°€ ê°€ëŠ¥)</p>
			    	      </div>
			    	    </div>

			    	    <!-- í•˜ë‹¨ ê³ ì •ëœ ì…ë ¥ì°½ -->
			    	    <div class="chat-footer border-top p-3 d-flex align-items-center bg-white">
			    	      <button class="btn btn-light me-2"><i class="fas fa-smile"></i></button>
			    	      <label for="fileInput" class="btn btn-light me-2">
			    	        <i class="fa-solid fa-paperclip"></i>
			    	      </label>
			    	      <input type="file" id="fileInput" style="display: none;">
			    	      <input class="form-control me-2" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="messageInput">
			    	      <button class="btn btn-primary" onclick="sendMessage()">ë³´ë‚´ê¸°</button>
			    	    </div>

			    	  </div>
			    	`;

			  });
			});

	    </script>
	</main>
	
</body>
</html>