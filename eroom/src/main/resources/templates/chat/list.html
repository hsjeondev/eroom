<!DOCTYPE html>
<html lang="ko-KR" dir="ltr" data-navigation-type="default"
	data-navbar-horizontal-shape="default"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{include/layout}">
<style>
/* 기본 상태: 오른쪽 영역은 투명하고 오른쪽으로 약간 이동한 상태 */
.tab-pane {
	opacity: 0;
	transform: translateX(50px);
	transition: opacity 0.3s ease, transform 0.3s ease;
	pointer-events: none;
}

/* 활성화된 상태: 클릭 시 'active' 클래스가 추가되어 나타남 */
.tab-pane.active {
	opacity: 1;
	transform: translateX(0);
	pointer-events: auto;
}
.treeview-label-strong {
  font-weight: bold;
  text-decoration: underline;
  color: #007bff;
}
.treeview-text {
  cursor: pointer;
}
.treeview-text:hover {
  background-color: #f0f4ff;
}
.treeview-text a {
  text-decoration: none !important;
  display: block;
  width: 100%;
  height: 100%;
  padding: 5px 10px;
}
</style>

<body>
	<main class="main" id="top" layout:fragment="content">

		<input type="hidden" id="myEmployeeNo"
			th:value="${#authentication.principal.employee.employeeNo}">
		<div class="chat d-flex phoenix-offcanvas-container pt-1 mt-n1 mb-9">
			<!-- 왼쪽 채팅 목록 영역 -->
			<div
				class="card p-3 p-xl-1 mt-xl-n1 chat-sidebar me-3 phoenix-offcanvas phoenix-offcanvas-start"
				id="chat-sidebar">
				<button class="btn d-none d-sm-block d-xl-none mb-2"
					data-bs-toggle="modal" data-bs-target="#chatSearchBoxModal">
					<span
						class="fa-solid fa-magnifying-glass text-body-tertiary text-opacity-85 fs-7"></span>
				</button>
				<div class="d-none d-sm-block d-xl-none mb-5">
					<button class="btn w-100 mx-auto" type="button"
						data-bs-toggle="dropdown" data-boundary="window"
						aria-haspopup="true" aria-expanded="false"
						data-bs-reference="parent">
						<span
							class="fa-solid fa-bars text-body-tertiary text-opacity-85 fs-7"></span>
					</button>
					<ul class="dropdown-menu dropdown-menu-end p-0">
						<li><a class="dropdown-item" href="#!">All</a></li>
						<li><a class="dropdown-item" href="#!">Read</a></li>
						<li><a class="dropdown-item" href="#!">Unread</a></li>
					</ul>
				</div>
				<!-- 새 채팅방 만들기 버튼 -->
				<div class="d-grid gap-2 mb-3">
					<button class="btn btn-outline-primary" data-bs-toggle="modal"
						data-bs-target="#createChatModal">+ 새 채팅방 만들기</button>
				</div>
				<!-- 검색 입력란 -->
				<div class="form-icon-container mb-4 d-sm-none d-xl-block">
					<input class="form-control form-icon-input search" type="text" placeholder="이름을 입력하세요" /> 
					<span class="fas fa-user text-body fs-9 form-icon"></span>
				</div>
				<!-- 탭 메뉴 (전체, 읽지않음, 읽음) -->
				<ul class="nav nav-phoenix-pills mb-5 d-sm-none d-xl-flex"
					id="contactListTab" data-chat-thread-tab role="tablist">
					<li class="nav-item" role="presentation"><a
						class="nav-link cursor-pointer active" data-bs-toggle="tab"
						data-chat-thread-list="all" role="tab" aria-selected="true">전체</a>
					</li>
					<li class="nav-item item read" role="presentation"><a
						class="nav-link cursor-pointer" data-bs-toggle="tab" role="tab"
						data-chat-thread-list="read" aria-selected="false">읽음</a></li>
					<li class="nav-item item unread" role="presentation"><a
						class="nav-link cursor-pointer" data-bs-toggle="tab" role="tab"
						data-chat-thread-list="unread" aria-selected="false">읽지않음</a></li>
				</ul>
				<!-- 채팅 목록 -->
				<div class="scrollbar">
					<div class="tab-content" id="contactListTabContent">
						<div data-chat-thread-tab-content="data-chat-thread-tab-content">
							<ul class="nav chat-thread-tab flex-column list chat_list">
								<!-- 채팅방이 없을 경우 -->
								<li th:if="${#lists.isEmpty(chatroomList)}">
									<p class="text-center text-muted mt-4">참여 중인 채팅방이 없습니다.</p>
								</li>
								<!-- 채팅방 목록 -->
								<li th:if="${!#lists.isEmpty(chatroomList)}"
									th:each="chatroom : ${chatroomList}"
									th:attr="data-room-no=${chatroom.chatroomNo}, data-group=${chatroom.chatIsGroupYn}, data-chat-thread='data-chat-thread'"
									th:classappend="${chatroom.unreadCount > 0} ? 'unread' : 'read'"
									class="nav-item read mb-1 item" role="presentation"><a
									class="nav-link d-flex align-items-center justify-content-center p-2"
									th:href="'#chatroom-' + ${chatroom.chatroomNo}"
									th:attr="data-room-no=${chatroom.chatroomNo}, data-group=${chatroom.chatIsGroupYn}"
									data-bs-toggle="tab" data-chat-thread="data-chat-thread"
									role="tab" aria-selected="true"> 
									<!-- 아바타 이미지 -->
										<div class="avatar avatar-xl status-online position-relative me-2 me-sm-0 me-xl-2">
										  <img class="rounded-circle border border-2 border-light-subtle"
										     th:src="@{${chatroom.chatIsGroupYn == 'Y' ? '/assets/img/icons/logo.png' : chatroom.profileImageUrl}}"
										     alt="프로필 이미지">
										</div>
										<div class="flex-1 d-sm-none d-xl-block">
										  <div class="d-flex justify-content-between align-items-start">
										    <h5 th:text="${chatroom.chatroomName}"
										        class="text-body fw-normal name text-nowrap">채팅방 이름</h5>
										
										    <div class="d-flex flex-column align-items-end ms-2">
										      <p th:text="${#temporals.format(chatroom.lastMessageRegDate, 'yy.MM.dd HH:mm')}"
										         class="fs-10 text-body-tertiary text-opacity-85 mb-1 text-nowrap">
										         마지막 메시지 시간
										      </p>
										      <div th:if="${chatroom.unreadCount > 0}"
										           class="badge badge-phoenix badge-phoenix-primary px-1 unread-badge"
										           th:text="${chatroom.unreadCount}">4</div>
										    </div>
										  </div>
										  <div class="d-flex justify-content-between">
										    <p th:text="${chatroom.chatLastMessage != null and !#strings.isEmpty(chatroom.chatLastMessage) ? chatroom.chatLastMessage : '[파일] 첨부됨'}"
											   class="fs-9 mb-0 line-clamp-1 text-body-tertiary text-opacity-85 message">
											</p>

										  </div>
										</div>
								</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>

			<!-- 채팅방 생성 모달 -->
			<div class="modal fade" id="createChatModal" tabindex="-1"
				aria-labelledby="createChatModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h3>새 채팅방 만들기</h3>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="닫기"></button>
						</div>
						<form id="createChatForm">
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" />
							<div class="modal-body">
								<!-- 채팅 종류 선택 -->
								<div class="mb-3">
									<label class="form-label">채팅 종류</label>
									<div id="chatTypeGroup">
										<input type="radio" name="chatIsGroupYn" value="N" checked>
										1:1 채팅 <input type="radio" name="chatIsGroupYn" value="Y">
										그룹 채팅
									</div>
								</div>
								<div class="mb-3" id="chatroomNameBox">
									<label class="form-label">채팅방 이름</label> <input type="text"
										id="chatroomName" name="chatroomName" class="form-control"
										placeholder="예: 개발팀 채팅방" readonly>
								</div>
								<div id="selectedParticipants" class="mt-2 d-flex flex-wrap gap-2"></div>
								
								<div class="mb-3">
  								 <label class="form-label">참여자 선택</label>
								 <div class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
								 	<div class="row" style="height: 100%;">
<div class="col-6">
<ul class="treeview" id="treeviewTree">
  <li class="treeview-list-item">
    <p class="treeview-text">
      <input type="checkbox" class="form-check-input me-2 root-checkbox" data-name="이룸 컴퍼니" data-no="root" onchange="handleCheck(this)">
      <a href="javascript:void(0);"  data-bs-target="#tree-company" >
        <span class="fa-solid fa-folder treeview-icon text-info-light"></span>
        <span id="eroomCompanySpan" class="treeview-label-text fw-bold treeview-label-strong">이룸 컴퍼니</span>
      </a>
    </p>
    <ul class="collapse show treeview-list" id="tree-company">
      <li class="treeview-list-item" th:each="dept : ${departmentList}">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2 dept-checkbox" th:attr="data-name=${dept.codeName}, data-no=${dept.separatorCode}" onchange="handleCheck(this)">
          <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#dept-'+${dept.separatorCode}">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text" th:text="${dept.codeName}">부서명</span>
          </a>
        </p>
        <ul class="collapse treeview-list" th:id="'dept-'+${dept.separatorCode}">
          <li class="treeview-list-item" th:each="team : ${teamMap[dept.codeName]}">
            <p class="treeview-text ms-3">
              <input type="checkbox" class="form-check-input me-2 team-checkbox" th:attr="data-name=${team.codeName}, data-no=${team.separatorCode}" onchange="handleCheck(this)">
              <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#team-'+${team.separatorCode}">
                <span class="fa-solid fa-file-lines treeview-icon"></span>
                <span class="treeview-label-text" th:text="${team.codeName}">팀명</span>
              </a>
            </p>
            <ul class="collapse treeview-list" th:id="'team-'+${team.separatorCode}">
              <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap[team.separatorCode]}">
                <p class="treeview-text ms-4">
                  <input type="checkbox" class="form-check-input me-2 emp-checkbox" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
                  <span class="fa-solid fa-user treeview-icon"></span>
                  <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
                </p>
              </li>
            </ul>
          </li>
          	<!-- 부서는 있지만 팀 없는 사람 -->
			<li class="treeview-list-item" 
			    th:each="emp : ${teamEmployeeMap[dept.separatorCode + '_notAssigned']}">
			  <p class="treeview-text ms-3"> <!-- ← ms-4 에서 ms-3으로 맞춰줌 -->
			    <input type="checkbox" class="form-check-input me-2 emp-checkbox"
			           th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}"
			           onchange="handleCheck(this)">
			    <span class="fa-solid fa-user treeview-icon"></span>
			    <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
			  </p>
			</li>
        </ul>
      </li>
      <!-- <li class="treeview-list-item">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2" data-name="무소속" data-no="noTeam" onchange="handleCheck(this)">
          <a href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#noTeam">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text">무소속</span>
          </a>
        </p>
        <ul class="collapse treeview-list" id="noTeam">
          <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap['noTeam']}">
            <p class="treeview-text ms-4">
              <input type="checkbox" class="form-check-input me-2 emp-checkbox" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
              <span class="fa-solid fa-user treeview-icon"></span>
              <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
            </p>
          </li>
        </ul>
      </li> -->
    </ul>
  </li>
</ul>
</div>
								
								<div class="col-6 d-flex flex-column">
								  <!-- [1] 상단 고정 영역 -->
								  <div id="selectedResult"
								       class="border bg-white rounded p-2 mb-2 small"
								       style="position: sticky; top: 0; z-index: 2; background-color: white; ">
								    <strong>선택한 항목:</strong>
								    <div style="overflow-y: auto; max-height: 270px;" id="selectedTags" class="mt-1 flex-wrap gap-2"></div>
								  </div> 
								
								  <!-- [2] 중간: 빈 영역 (스크롤 여유) -->
								  <div class="flex-grow-1"></div>
								
								  <!-- [3] 하단 고정 영역 -->
								  <div class="text-end"
								       style="position: sticky; bottom: 0; z-index: 2; background-color: white;">
								    <button id="clearBtn" class="btn btn-light btn-sm" type="button">비우기</button>
								  </div>
								</div>
								
								
								</div>
								 </div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary"
									data-bs-dismiss="modal">취소</button>
								<button type="submit" class="btn btn-primary">생성</button>
							</div>
							<div>
								<input type="hidden" name="creater"
									th:value="${#authentication.principal.employee.employeeNo}">
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- 오른쪽 채팅 영역 (선택 전 기본 화면) -->
			<div class="card tab-content flex-1 phoenix-offcanvas-container"
				id="chat-content">

				<div class="tab-pane h-100 fade active show" id="tab-thread-1"
					role="tabpanel" aria-labelledby="tab-thread-1">
					<div class="d-flex flex-column h-100">
						<div id="default-chat-area"
							class="d-flex flex-column justify-content-center align-items-center h-100">
							<h4 class="text-body-secondary mb-2">채팅방을 선택해주세요.</h4>
							<a href="#" class="fw-bold text-primary text-decoration-none"
								data-bs-toggle="modal" data-bs-target="#createChatModal"> 새
								채팅방 만들기 </a>
						</div>
					</div>
				</div>
			</div>
			<template id="chat-pane-template">
			  <div class="tab-pane h-100 fade show active d-flex flex-column">
			    <div class="d-flex align-items-center justify-content-between px-4 pt-3">
			      <h4 class="mb-0 chatroom-title cursor-pointer text-primary"
			          data-group="" data-room-no=""></h4>
			    </div>
			    <div class="flex-grow-1 overflow-auto p-4">
			      <div class="chat-history">
			        <hr />
			        <p>채팅 내용이 여기에 표시됩니다</p>
			      </div>
			    </div>
			    <div class="chat-footer border-top p-3 d-flex align-items-center flex-column bg-white">
			      <div class="d-flex w-100 align-items-center mb-2">
			        <label for="chatFileInput" class="btn btn-light me-2">
			          <i class="fa-solid fa-paperclip"></i>
			        </label>
			        <div class="input-group">
			          <input type="text" class="form-control" placeholder="메시지를 입력하세요..." id="messageInput">
			          <button class="btn btn-primary" type="button" id="sendBtn">보내기</button>
			        </div>
			      </div>
			      <input type="file" id="chatFileInput" name="files" style="display: none;" multiple>
			      <div id="chatFilePreview" class="d-flex flex-wrap gap-2 w-100"></div>
			    </div>
			  </div>
			</template>
			
			<!-- 채팅방 상세 모달 -->
			<div class="modal fade" id="chatroomDetailModal" tabindex="-1"
				aria-labelledby="chatroomDetailModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-lg modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-body">
							<div class="text-center mb-3">
								<img id="modalProfileImage" src="/assets/img/profile/default-profile.png" class="rounded-circle" width="80" />
								<h5 id="modalChatroomName" class="mt-2">채팅방 이름</h5>
							</div>
							<div id="group-only-options">
								<input type="hidden" th:name="${_csrf.parameterName}"
									th:value="${_csrf.token}" />
								<ul class="list-unstyled mb-4" style="font-size: 14px;">
								  <li data-action="rename" class="cursor-pointer chat-action-item">✏️ 채팅방 이름 변경</li>
								  <li data-action="add" class="cursor-pointer chat-action-item">➕ 참여자 추가하기</li>
								  <li data-action="leave" class="cursor-pointer chat-action-item">📤 채팅방 나가기</li>
								  <li data-action="delete" id="deleteChatroomBtn" class="cursor-pointer chat-action-item d-none">🗑️ 채팅방 삭제</li>
								</ul>

							</div>
							<div id="participantListBox" class="mb-4">
								<h6
									class="fw-semibold border-bottom border-translucent pb-2 mb-2">참여자</h6>
								<ul id="participantList" style="
								  display: grid;
								  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
								  gap: 8px 12px;
								  padding: 8px 16px;
								  list-style: none;
								  margin: 0;
								">
								</ul>
							</div>
							<div id="shared-file-list-title" class="fw-semibold border-bottom border-translucent pb-2 mb-2">
							  공유된 파일
							</div>
							<div id="shared-file-list" class="mb-2">
							  <!-- 자바스크립트에서 동적으로 채워짐 -->
							</div>
							<a class="btn btn-link fs-10 p-0" id="loadMoreFilesBtn" href="#!">
							  5개 더 보기 <i class="fa-solid fa-chevron-down ms-1"></i>
							</a>
							</div>
						</div>
					</div>
				</div>
		<script>
	 	let socket = null; 
		let currentReceiverNo = null;
		let isCreateMode = true; // 기본은 생성 모드
		let lastSelectedChatroomName = null;
		let currentChatroomNo = null;
		let existingParticipantIds = [];
		
		document.addEventListener("DOMContentLoaded", () => {
		  bindModalReset(); // 모달 초기화
		  bindChatroomPanelEvents(); // 채팅방 클릭 이벤트
		  bindChatroomRename(); // 채팅방 이름 변경
		  bindParticipantAddButton(); // 참여자 추가 버튼 클릭 이벤트
		  bindChatroomCreate(); // 채팅방 생성 버튼 클릭 이벤트
		  bindChatTypeChange(); // 채팅 종류 변경시
		  bindChatroomDelete(); // 채팅방 삭제
		  bindChatroomLeave();  // 채팅방 나가기
		  connectWebSocket(); // 웹소켓 연결
		  bindFilePreview(); // 채팅 파일 
		});
		function getFileIconClass(extension) {
		    const map = {
		      pdf: "fa-file-pdf",
		      doc: "fa-file-word",
		      docx: "fa-file-word",
		      xls: "fa-file-excel",
		      xlsx: "fa-file-excel",
		      ppt: "fa-file-powerpoint",
		      pptx: "fa-file-powerpoint",
		      zip: "fa-file-zipper",
		      rar: "fa-file-zipper",
		      txt: "fa-file-lines",
		      jpg: "fa-file-image",
		      jpeg: "fa-file-image",
		      png: "fa-file-image",
		      gif: "fa-file-image",
		      bmp: "fa-file-image",
		      webp: "fa-file-image",
		      mp4: "fa-file-video",
		      avi: "fa-file-video",
		      mp3: "fa-file-audio",
		      wav: "fa-file-audio"
		    };
		    return map[extension] || "fa-file";
		  }
		// 모달 초기화 (열릴 때 기본 리셋)
		function bindModalReset() {
		  const modal = document.getElementById("createChatModal");
		  if (!modal) return;
		
		  modal.addEventListener("shown.bs.modal", () => {
			  document.getElementById("chatroomName").value = "";
			  document.getElementById("chatroomName").readOnly = true;
			  document.getElementById("selectedParticipants").innerHTML = "";

			  const deptSelect = document.getElementById("departmentSelect");
			  if (deptSelect) deptSelect.selectedIndex = 0;

			  const empSelect = document.getElementById("employeeSelect");
			  if (empSelect) {
			    empSelect.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
			  }

			  document.getElementById("chatroomNameBox").style.display = isCreateMode ? "block" : "none";
			  document.getElementById("chatTypeGroup").style.display = isCreateMode ? "block" : "none";

			  [...document.querySelectorAll('input[name="participantIds"]')].forEach(el => el.remove());
			});
		  modal.addEventListener("hidden.bs.modal", () => {
			    resetTree(); // ✅ 여기 추가
			  });
		}
		
		// 소속 선택시 직원 목록 로딩
		function bindDepartmentChange() {
		  const departmentSelect = document.getElementById("departmentSelect");
		  if (!departmentSelect) return;
		
		  departmentSelect.addEventListener("change", function () {
		    const deptId = this.value;
		    fetch('/chat/employes?separator_code=' + encodeURIComponent(deptId))
		      .then(response => response.json())
		      .then(data => {
		        const select = document.getElementById('employeeSelect');
		        select.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
		        data.forEach(emp => {
		          const option = document.createElement('option');
		          option.value = emp.employee_no;
		          option.text = emp.employee_name;
		          select.appendChild(option);
		        });
		      })
		      .catch(error => console.error('직원 로딩 실패:', error));
		  });
		}
		
		// 참여자 추가
		function bindParticipantAdd() {
		  const btn = document.querySelector("button[onclick='addParticipant()']");
		  if (!btn) return;
		  btn.addEventListener("click", () => {
		    const isGroupChat = document.querySelector('input[name="chatIsGroupYn"]:checked')?.value === 'Y';
		    const select = document.getElementById('employeeSelect');
		    const selectedOptions = Array.from(select.selectedOptions);
		    const selectedIds = [...document.querySelectorAll('#selectedTags .card')].map(el => el.id.replace('tag-', ''));
		    if (selectedOptions.length === 0) {
		      alert('참여자를 선택해주세요.');
		      return;
		    }
		    const currentCount = document.querySelectorAll('#selectedParticipants .badge').length;
		    if(isCreateMode && !isGroupChat && (currentCount + selectedOptions.length > 1)) {
	    	  alert('1:1 채팅은 한 명만 선택할 수 있습니다.');
	    	  return;
	    	}
		
		    selectedOptions.forEach(option => {
		      const participantId = option.value;
		      const participantName = option.text;
		      if (document.getElementById('participant-' + participantId)) {
		        alert('이미 추가된 참여자입니다.');
		        return;
		      }
		      const badge = document.createElement('span');
		      badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
		      badge.id = 'participant-' + participantId;
		      badge.dataset.id = participantId;
		      badge.innerHTML = `
		        ${participantName}
		        <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>
		      `;
		      document.getElementById('selectedParticipants').appendChild(badge);
		
		      if (!isGroupChat) {
		        document.getElementById("chatroomName").value = participantName;
		      }
		    });
		    select.selectedIndex = -1;
		  });
		}
		
		// 채팅 종류 변경시
		function bindChatTypeChange() {
		  const radios = document.querySelectorAll('input[name="chatIsGroupYn"]');
		  if (!radios) return;
		
		  radios.forEach(radio => {
		    radio.addEventListener("change", () => {
		      const isGroup = document.querySelector('input[name="chatIsGroupYn"]:checked').value === 'Y';
		      const chatroomNameInput = document.getElementById("chatroomName");
		      if (isGroup) {
		        chatroomNameInput.value = "";
		        chatroomNameInput.readOnly = false;
		      } else {
		        chatroomNameInput.value = "";
		        chatroomNameInput.readOnly = true;
		        document.getElementById("selectedParticipants").innerHTML = "";
		        
		        resetTree();
		      }
		    });
		  });
		}
		
		// 채팅방 목록 클릭
		function bindChatroomPanelEvents() {
		  document.addEventListener("click", function (e) {
			  if (e.target.tagName != 'H4') {
			const target = e.target.closest('[data-room-no]');

		    if (!target) return;
		    
		    const sharedFileList = document.getElementById("shared-file-list");
			if (sharedFileList) sharedFileList.innerHTML = "";

			const loadMoreBtn = document.getElementById("loadMoreFilesBtn");
			if (loadMoreBtn) {
			  sharedFilePage = 0;
			  allFilesLoaded = false;
			  loadMoreBtn.style.display = "block"; // 초기엔 항상 보이도록 설정
			}
		
		    const chatroomNo = target.dataset.roomNo;
		    currentChatroomNo = chatroomNo; 
		    const isGroup = target.dataset.group === "Y";
		    const chatroomNameEl = target.querySelector('.name');
		    const chatroomName = chatroomNameEl
		    ? chatroomNameEl.innerText.trim()
		    : target.innerText?.trim() || "채팅방"; 
		    lastSelectedChatroomName = chatroomName;
		    
			// 기본 채팅 영역 숨기기
		    const defaultArea = document.getElementById("default-chat-area");
		    if (defaultArea) defaultArea.style.display = "none";
			// 채팅창 오른쪽 영역 보이기
		    const chatContent = document.getElementById("chat-content");
		    const myEmployeeNo = document.getElementById("myEmployeeNo").value;
		    
		 // 삭제 버튼 노출 여부 제어
			fetch('/chat/roomDetail?roomNo=' + chatroomNo)
			  .then(response => response.json())
			  .then(detail => {
			    const myEmployeeNo = document.getElementById("myEmployeeNo").value;
			    const deleteBtn = document.getElementById("deleteChatroomBtn");

			    if (deleteBtn) {
			      const isOwner = detail.creater === Number(myEmployeeNo);
			      deleteBtn.classList.toggle("d-none", !isOwner);
			    }
			  });
			renderChatroomUI(chatroomNo, chatroomName, isGroup);
		    	bindFilePreview();
		    // 수신자 employeeNo 가져오기
		    if (!isGroup) {
			    fetch('/chat/receiver?chatroomNo=' + chatroomNo)
			    .then(response => response.json())
			    .then(data => {
			        // 기존의 hidden input 제거
			        const oldInput = document.getElementById("receiverNo");
			        if (oldInput) {
			            oldInput.remove();
			        }
			        // 새로운 hidden input 생성
			        const receiverInput = document.createElement("input");
			        receiverInput.type = "hidden";
			        receiverInput.id = "receiverNo";
			        receiverInput.value = data.receiverNo;
			        document.body.appendChild(receiverInput);
			    })
			    .catch(error => {
			        console.error('수신자 불러오기 실패:', error);
			    });
			    
		    }else{
		    	// 그룹 채팅일 경우 receiverNo 제거
		    	const receiverInput = document.getElementById("receiverNo");
		        if (receiverInput) {
		            receiverInput.remove();
		        }
		    }
		    
			    fetch('/chat/read', {
			    	  method: 'POST',
			    	  headers: {
			    	    'Content-Type': 'application/json',
			    	    'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			    	  },
			    	  body: JSON.stringify({
			    	    chatroomNo: chatroomNo,
			    	    senderNo: document.getElementById("myEmployeeNo").value
			    	  })
			    	})
			    	.then(res => res.json())
			    	.then(result => {
			    	  const sidebarItem = document.querySelector(`[data-room-no="${chatroomNo}"]`);
			    	  if (sidebarItem) {
			    	    sidebarItem.classList.remove('unread');
			    	    sidebarItem.classList.add('read');
			    	    const badge = sidebarItem.querySelector('.badge');
			    	    if (badge) badge.remove();
			    	  }
			    	})
			    	.catch(error => {
			    	  console.error('❌ 읽음 처리 실패:', error);
			    	});
	
			    
			    // 채팅 이력 불러오기
			    setTimeout(() => {
			    	  loadChatroomDetail(chatroomNo);
			    	}, 0);
		    }
		    
		  });

		  document.addEventListener("click", function (e) {
		    const target = e.target.closest(".chatroom-title");
		    if (!target) return;
		
		    document.getElementById("modalChatroomName").innerText = target.innerText;
		    document.getElementById("modalChatroomName").dataset.roomNo = target.dataset.roomNo;
		
		    const groupOptions = document.getElementById("group-only-options");
		    if (groupOptions) groupOptions.style.display = target.dataset.group === "Y" ? "block" : "none";
		    
			// 참여자 목록 불러오기
		    const chatroomNo = target.dataset.roomNo;
		    fetch('/chat/participants?chatroomNo=' + encodeURIComponent(chatroomNo))
		    .then(response => response.json())
		    .then(data => {
		      const myEmployeeNo = document.getElementById("myEmployeeNo").value;

		      // 상대방 프로필 이미지 설정
		      const other = data.find(user => String(user.employeeNo) !== String(myEmployeeNo));
		      const isGroupChat = target.dataset.group === "Y";
		      const imageUrl = isGroupChat
		      ? '/assets/img/icons/logo.png'
		      : (data.find(user => String(user.employeeNo) !== String(myEmployeeNo))?.profileImageUrl || '/assets/img/profile/default-profile.png');

		    const modalProfileImg = document.getElementById("modalProfileImage");
		    if (modalProfileImg) {
		      modalProfileImg.src = imageUrl;
		    }

		      // 참여자 목록 렌더링
		      const participantList = document.getElementById('participantList');
		      participantList.innerHTML = '';
		      data.forEach(p => {
		        const li = document.createElement('li');
		        li.textContent = p.employeeName;
		        
		        li.style.backgroundColor = '#f8f9fa';
		        li.style.border = '1px solid #dee2e6';
		        li.style.borderRadius = '8px';
		        li.style.padding = '6px 10px';
		        li.style.fontSize = '14px';
		        li.style.textAlign = 'center';
		        li.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
		        li.style.whiteSpace = 'nowrap';
		        li.style.overflow = 'hidden';
		        li.style.textOverflow = 'ellipsis';
		        
		        participantList.appendChild(li);
		      });
		    })
		    .catch(error => {
		      console.error('참여자 불러오기 실패:', error);
		    });

		    const modal = new bootstrap.Modal(document.getElementById("chatroomDetailModal"));
		    modal.show();
		  });
		}
		
		// 채팅방 이름 변경
		function bindChatroomRename() {
		  const detailModal = document.getElementById("chatroomDetailModal");
		  if (!detailModal) return;
		
		  detailModal.addEventListener("click", function (e) {
			  const li = e.target.closest("li");
			  if (!li || li.dataset.action !== "rename") return;

			  const nameEl = document.getElementById("modalChatroomName");
			  const chatroomNo = nameEl.dataset.roomNo;
			  const currentName = nameEl.innerText;
			  const newName = prompt("새 채팅방 이름을 입력하세요:", currentName);
			  if (!newName || newName.trim() === "" || newName === currentName) return;

			  fetch('/chat/rename', {
			    method: 'POST',
			    headers: {
			      'Content-Type': 'application/json',
			      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			    },
			    body: JSON.stringify({ chatroomNo, chatroomName: newName })
			  })
			  .then(res => res.json())
			  .then(data => {
			    if (data.res_code === "200") {
			      alert("채팅방 이름이 변경되었습니다.");
			      nameEl.innerText = newName;
			      const titleEl = document.querySelector(".chatroom-title");
			      if (titleEl) titleEl.innerText = newName;
			      const sideNameEl = document.querySelector(`[data-room-no="${chatroomNo}"] .name`);
			      if (sideNameEl) sideNameEl.innerText = newName;
			      lastSelectedChatroomName = newName;
			      const modal = bootstrap.Modal.getInstance(document.getElementById("chatroomDetailModal"));
			      modal?.hide();
			    } else {
			      alert("변경 실패: " + data.res_msg);
			    }
			  })
			  .catch(err => {
			    console.error("요청 실패:", err);
			    alert("서버 오류가 발생했습니다.");
			  });
			});


		}
		
		// 채팅방 생성/참여자 추가 submit
		function bindChatroomCreate() {
		  const form = document.getElementById("createChatForm");
		  if (!form) return;
		
		  form.addEventListener("submit", function (e) {
		    e.preventDefault();
		
		    const submitBtn = form.querySelector('button[type="submit"]');
		   
		    
		    if (isCreateMode) {
		      const isGroupChat = document.querySelector('input[name="chatIsGroupYn"]:checked').value === 'Y';
		      const chatroomName = document.getElementById("chatroomName").value.trim();
		      if (isGroupChat && chatroomName === "") {
		        alert("채팅방 제목을 입력해주세요.");
		        return;
		      }
		    }
		
		    [...form.querySelectorAll('input[name="participantIds"]')].forEach(el => el.remove());
		    
		    const selectedIds = [...document.querySelectorAll('#selectedTags .card')].map(el => el.id.replace('tag-', ''));
		    
		    let participantEmpNos = new Set();

		    selectedIds.forEach(code => {
	    	  // 직접 선택된 사원
	    	  const isEmp = document.querySelector(`.emp-checkbox[data-no="${code}"]`);
	    	  if (isEmp) {
	    	    participantEmpNos.add(code);
	    	  } else {
	    	    // 조직 단위 (팀/부서/회사)의 경우
	    	    const parentEl = document.querySelector(`[data-no="${code}"]`)?.closest('li.treeview-list-item');
	    	    if (!parentEl) return;

	    	    // 이 조직 아래 있는 모든 사원 체크박스 찾기
	    	    const empCbs = parentEl.querySelectorAll('.emp-checkbox');
	    	    empCbs.forEach(cb => {
	    	      participantEmpNos.add(cb.getAttribute('data-no'));
	    	    });
	    	  }
	    	});
			 if (participantEmpNos.size === 0) {
			   alert("직원 참여자를 선택해주세요.");
			   return;
			 }
	
			 // input 추가
			 participantEmpNos.forEach(empNo => {
			   const hidden = document.createElement('input');
			   hidden.type = 'hidden';
			   hidden.name = 'participantIds';
			   hidden.value = empNo;
			   form.appendChild(hidden);
			 });
		    
		    
		    if (selectedIds.length === 0) {
		      alert("참여자를 선택해주세요.");
		      return;
		    }
		    submitBtn.disabled = true;
		
		    const formData = new FormData(form);
		    const url = isCreateMode ? '/chat/create' : '/chat/addParticipants';
		    fetch(url, {
		      method: 'POST',
		      body: formData
		    })
		    .then(res => res.json())
		    .then(data => {
		      if (data.res_code === "200") {
		        alert(data.res_msg);
		        bootstrap.Modal.getInstance(document.getElementById("createChatModal"))?.hide();
		        location.href = "/chat/list";
		      } else {
		        alert("오류: " + data.res_msg);
		        submitBtn.disabled = false; 
		      }
		    })
		    .catch(err => {
		      console.error("요청 실패:", err);
		      alert("서버 오류가 발생했습니다.");
		      submitBtn.disabled = false;
		    });
		  });
		}
		
		// 참여자 추가하기 버튼
		function bindParticipantAddButton() {
		  const detailModal = document.getElementById("chatroomDetailModal");
		  if (!detailModal) return;
		
		  detailModal.addEventListener("click", function (e) {
		    const li = e.target.closest("li");
		    if (!li || !li.textContent.includes("참여자 추가하기")) return;
		
		    const chatroomNo = document.getElementById("modalChatroomName").dataset.roomNo;
		    if (chatroomNo) {
		      const detailModalInstance = bootstrap.Modal.getInstance(detailModal);
		      detailModalInstance.hide();
		      setTimeout(() => {
		        openParticipantAddModal(chatroomNo);
		      }, 300);
		    }
		  });
		}
		// 채팅방 나가기
		function bindChatroomLeave() {
		  const detailModal = document.getElementById("chatroomDetailModal");
		  if (!detailModal) return;
		
		  detailModal.addEventListener("click", function (e) {
		    const li = e.target.closest("li");
		    if (!li || li.dataset.action !== "leave") return;
		
		    const chatroomNo = document.getElementById("modalChatroomName").dataset.roomNo;
		    const myEmployeeNo = document.getElementById("myEmployeeNo").value;
		    if (!chatroomNo) return;
		
		    // ✅ 생성자 정보 확인
		    fetch(`/chat/roomDetail?roomNo=${chatroomNo}`)
		      .then(res => res.json())
		      .then(detail => {
		        const creatorNo = detail.creater;
		
		        if (String(myEmployeeNo) === String(creatorNo)) {
		          alert("방장은 채팅방에서 나갈 수 없습니다. 삭제를 이용해주세요.");
		          return;
		        }
		
		        // ✅ 나가기 진행
		        if (confirm("채팅방에서 나가시겠습니까?")) {
		          fetch("/chat/leave", {
		            method: "POST",
		            headers: {
		              "Content-Type": "application/json",
		              "X-CSRF-Token": document.querySelector('meta[name="_csrf"]').content
		            },
		            body: JSON.stringify({ chatroomNo: chatroomNo })
		          })
		            .then(res => res.json())
		            .then(data => {
		              if (data.res_code === "200") {
		                alert("채팅방에서 나갔습니다.");
		                location.href = "/chat/list";
		              } else {
		                alert("나가기 실패: " + data.res_msg);
		              }
		            })
		            .catch(err => {
		              console.error("나가기 요청 실패:", err);
		              alert("서버 오류가 발생했습니다.");
		            });
		        }
		      })
		      .catch(err => {
		        console.error("생성자 정보 조회 실패:", err);
		        alert("서버 오류가 발생했습니다.");
		      });
		  });
		}

		// 채팅방 삭제
		function bindChatroomDelete() {
          const detailModal = document.getElementById("chatroomDetailModal");
          if (!detailModal) return;
        
          detailModal.addEventListener("click", function (e) {
            const li = e.target.closest("li");
            if (!li || !li.textContent.includes("채팅방 삭제")) return;
        
            const chatroomNo = document.getElementById("modalChatroomName").dataset.roomNo;
            if (chatroomNo) {
              if (confirm("정말로 채팅방을 삭제하시겠습니까?")) {
                fetch('/chat/delete', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
                  },
                  body: JSON.stringify({ chatroomNo })
                })
                .then(res => res.json())
                .then(data => {
                  if (data.res_code === "200") {
                    alert(data.res_msg);
                    location.href = "/chat/list";
                  } else {
                    alert("삭제 실패: " + data.res_msg);
                  }
                })
                .catch(err => {
                  console.error("요청 실패:", err);
                  alert("서버 오류가 발생했습니다.");
                });
              }
            }
          });
        }
		
		// 참여자 추가 모달 열기
	function openParticipantAddModal(chatroomNo) {
  isCreateMode = false;
  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("createChatModal"));
  modal.show();

  document.querySelector("#createChatModal h3").innerText = "참여자 추가하기";
  document.getElementById("chatroomNameBox").style.display = "none";
  document.getElementById("chatTypeGroup").style.display = "none";

  // ✅ 채팅 유형 라디오 버튼을 강제로 'Y'로 설정
  document.querySelector('input[name="chatIsGroupYn"][value="Y"]').checked = true;
  document.querySelector('input[name="chatIsGroupYn"][value="Y"]').dispatchEvent(new Event("change"));

  document.querySelector('#createChatForm button[type="submit"]').innerText = "추가";

  let chatroomInput = document.getElementById("chatroomNoInput");
  if (!chatroomInput) {
    chatroomInput = document.createElement('input');
    chatroomInput.type = 'hidden';
    chatroomInput.name = 'chatroomNo';
    chatroomInput.id = 'chatroomNoInput';
    document.getElementById("createChatForm").appendChild(chatroomInput);
  }
  chatroomInput.value = chatroomNo;

  // ✅ 기존 참여자 목록 저장
  fetch(`/chat/participants?chatroomNo=${chatroomNo}`)
    .then(res => res.json())
    .then(data => {
      window.existingParticipantIds = data.map(p => String(p.employeeNo)); // 전역에서 접근 가능하도록 저장
    })
    .catch(err => {
      console.error("기존 참여자 조회 실패:", err);
      window.existingParticipantIds = [];
    });

  // 상태 복구
  modal._element.addEventListener("hidden.bs.modal", () => {
    isCreateMode = true;
    document.querySelector("#createChatModal h3").innerText = "새 채팅방 만들기";
    document.getElementById("chatroomNameBox").style.display = "block";
    document.getElementById("chatTypeGroup").style.display = "block";
  }, { once: true });
}


		
		
		function connectWebSocket() {
		  const senderNo = document.getElementById("myEmployeeNo").value; 
		  function getFormattedDate() {
			  const now = new Date();
			  return now.getFullYear().toString().slice(2) + '.' +
			         String(now.getMonth() + 1).padStart(2, '0') + '.' +
			         String(now.getDate()).padStart(2, '0');
			}
		  if (socket) {
		    socket.onmessage = null;   // 기존 소켓의 메시지 리스너를 끊는다
		    socket.onclose = null;     // (선택) 기존 소켓의 종료 리스너도 끊는다
		    socket.onerror = null;     // (선택) 기존 소켓의 에러 리스너도 끊는다
		    socket.close();            // 기존 소켓 연결 닫는다
		  }

		  socket = new WebSocket("ws://localhost:8080/ws/chat?senderNo=" + senderNo);
		  
		  socket.onopen = function() {
			 console.log('WebSocket 연결 성공');
		  };
		  // 메시지 수신
		socket.onmessage = function (event) {
  const data = JSON.parse(event.data);
  const myEmployeeNo = document.getElementById("myEmployeeNo").value;
  const currentChatroomNo = document.querySelector(".chatroom-title")?.dataset.roomNo;
  const chatHistory = document.querySelector(".chat-history");
  const sidebarItem = document.querySelector(`[data-room-no="${data.chatroomNo}"]`);
  const isMyMessage = String(data.senderMember) === String(myEmployeeNo);
  if (!sidebarItem) return;

  // 다른 방일 경우 → unread badge 처리
  if (!currentChatroomNo || Number(currentChatroomNo) !== Number(data.chatroomNo)) {
    sidebarItem.classList.add("unread");
    sidebarItem.classList.remove("read");

    const rightInfoBox = sidebarItem.querySelector(".d-flex.flex-column.align-items-end");
    if (rightInfoBox) {
      // 날짜 수정
      const timePreview = rightInfoBox.querySelector("p.text-body-tertiary");
      if (timePreview) {
        timePreview.innerText = getFormattedDate();
      }

      // 배지 수정 또는 추가
      let badge = rightInfoBox.querySelector(".badge");
      if (badge) {
        badge.innerText = (parseInt(badge.innerText) || 0) + 1;
      } else {
        badge = document.createElement("div");
        badge.className = "badge badge-phoenix badge-phoenix-primary px-1 unread-badge";
        badge.innerText = "1";
        rightInfoBox.appendChild(badge);
      }
    }


    const messagePreview = sidebarItem.querySelector(".message");
    if (messagePreview) messagePreview.innerText = data.chatMessageContent;

    const timePreview = sidebarItem.querySelector(".text-body-tertiary");
    if (timePreview) timePreview.innerText = getFormattedDate();

    return;
  }

  const profileImageUrl = data.senderProfileImageUrl && data.senderProfileImageUrl.trim() !== ""
	  ? data.senderProfileImageUrl
	  : "/assets/img/profile/default-profile.png";
  const senderDisplayName = isMyMessage ? "나" : data.senderName || "알 수 없음";

  const wrapper = document.createElement("div");
  wrapper.className = "mb-3";

  const nameLine = document.createElement("div");
  nameLine.className = `d-flex ${isMyMessage ? "justify-content-end" : "justify-content-start"} mb-1`;
  nameLine.innerHTML = `<div class="small text-muted">${senderDisplayName}</div>`;

  const messageLine = document.createElement("div");
  messageLine.className = `d-flex align-items-start ${isMyMessage ? "justify-content-end" : "justify-content-start"} mb-2`;

  const profileImg = document.createElement("img");
  profileImg.src = profileImageUrl;
  profileImg.className = "rounded-circle";
  profileImg.style.width = "35px";
  profileImg.style.height = "35px";
  profileImg.style.objectFit = "cover";

  const messageBubble = document.createElement("div");
  messageBubble.className = `p-2 rounded-2 ${isMyMessage ? "bg-primary text-white" : "bg-light"}`;
  messageBubble.style.maxWidth = "70%";

  if (data.chatMessageContent) {
    const text = document.createElement("div");
    text.innerText = data.chatMessageContent;
    messageBubble.appendChild(text);
  }

  if (data.drivePath) {
    const ext = data.drivePath.split(".").pop().toLowerCase();
    const isImage = ["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext);

    const fileWrapper = document.createElement("div");
    fileWrapper.className = "mt-2";

    if (isImage) {
      const img = document.createElement("img");
      img.src = data.drivePath;
      img.style.maxWidth = "150px";
      img.style.borderRadius = "8px";
      fileWrapper.appendChild(img);
    } else {
      const link = document.createElement("a");
      link.href = "/files/" + data.drivePath.replace(/^\/+/, "");
      link.className = "badge bg-secondary text-white";
      link.target = "_blank";
      link.innerText = "📎 " + (data.driveOriName || "첨부파일 다운로드");
      fileWrapper.appendChild(link);
    }

    messageBubble.appendChild(fileWrapper);
  }

  // 조립
  if (isMyMessage) {
    messageLine.appendChild(messageBubble);
    messageLine.appendChild(profileImg);
  } else {
    messageLine.appendChild(profileImg);
    messageLine.appendChild(messageBubble);
  }

  wrapper.appendChild(nameLine);
  wrapper.appendChild(messageLine);
  chatHistory.appendChild(wrapper);

  const scrollArea = document.querySelector(".flex-grow-1.overflow-auto");
  if (scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
};



  // 현재 열린 방이 없거나, 다른 방이면 읽지 않음 처리
	  if (data.senderMember != myEmployeeNo) {
	  fetch('/chat/unreadCount?chatroomNo=' + data.chatroomNo)
	    .then(response => response.json())
	    .then(result => {
	      sidebarItem.classList.add('unread');
	      sidebarItem.classList.remove('read');;
	
	     let badge = sidebarItem.querySelector('.badge');
	     if (badge) {
	       badge.innerText = result.count;
	     } else {
	       badge = document.createElement('div');
	       badge.className = 'badge bg-danger text-white ms-2';
	       badge.innerText = result.count;
	       const flexBox = sidebarItem.querySelector('.d-flex.justify-content-between');
	       if (flexBox) {
	         flexBox.appendChild(badge);
	       }
	     }
	   })
	   .catch(error => {
	     console.error('뱃지 업데이트 실패:', error);
	   });


// 미리보기 텍스트와 시간은 업데이트해주자 (내 메시지도 포함)
const messagePreview = sidebarItem.querySelector('.message');
if (messagePreview) {
  messagePreview.innerText = data.chatMessageContent;
}

const timePreview = sidebarItem.querySelector('.text-body-tertiary');
if (timePreview) {
  const now = new Date();
  const formatted = now.getFullYear().toString().slice(2) + '.' +
                    String(now.getMonth() + 1).padStart(2, '0') + '.' +
                    String(now.getDate()).padStart(2, '0');
  timePreview.innerText = formatted;
}

  // 같은 방이면 채팅 추가
  if (!chatHistory) {
    console.error("❌ chat-history 없음");
    return;
  }

  const myEmployeeNo = document.getElementById("myEmployeeNo").value;
  const isMyMessage = data.senderMember == myEmployeeNo;

  const wrapperDiv = document.createElement("div");
  wrapperDiv.className = "mb-3";

  const nameDiv = document.createElement("div");
  nameDiv.className = `d-flex ${isMyMessage ? 'justify-content-end' : 'justify-content-start'} mb-1`;
  nameDiv.innerHTML = `<div class="small text-muted">${isMyMessage ? '나' : data.senderName}</div>`;

  const messageOuterDiv = document.createElement("div");
  messageOuterDiv.className = `d-flex ${isMyMessage ? 'justify-content-end' : 'justify-content-start'} mb-2`;

  const messageInnerDiv = document.createElement("div");
  messageInnerDiv.className = `p-2 rounded-2 ${isMyMessage ? 'bg-primary text-white' : 'bg-light'}`;
  messageInnerDiv.style.maxWidth = "70%";
  messageInnerDiv.innerText = data.chatMessageContent;

  messageOuterDiv.appendChild(messageInnerDiv);
  wrapperDiv.appendChild(nameDiv);
  wrapperDiv.appendChild(messageOuterDiv);
  chatHistory.appendChild(wrapperDiv); 

	const chatArea = document.querySelector(".flex-grow-1.overflow-auto");
	if (chatArea) {
	  chatArea.scrollTop = chatArea.scrollHeight;
	}

};




		  socket.onclose = function(event) {
		    console.log('❌ WebSocket 연결 종료:', event);
		  };

		  socket.onerror = function(error) {
		    console.error('🚨 WebSocket 오류 발생:', error);
		  };
		}
		// 메시지 보내기
function sendMessage() {
  const messageInput = document.getElementById("messageInput");
  const message = messageInput.value.trim();
  const fileInput = document.getElementById("chatFileInput");

  const chatroomNo = document.querySelector(".chatroom-title").dataset.roomNo;
  const myEmployeeNo = document.getElementById("myEmployeeNo").value;
  const receiverValue = document.getElementById("receiverNo")?.value;
  const receiverNo = receiverValue && receiverValue !== "undefined" && receiverValue !== "null" ? Number(receiverValue) : null;
  const isGroupChat = document.querySelector('.chatroom-title')?.dataset.group === 'Y';
  
  if (!message && fileInput.files.length === 0) {
    alert("메시지나 파일을 입력해주세요.");
    return;
  }

  //프로필 이미지 URL을 가져오기
  const myProfileImageUrl = document.querySelector('.chat_list [data-room-no="'+chatroomNo+'"] img')?.src 
|| '/assets/img/profile/default-profile.png';
  // 파일이 있는 경우
  if (fileInput.files.length > 0) {
    const formData = new FormData();
    formData.append("chatroomNo", chatroomNo);
    formData.append("driveDescriptions", "");
    
    for (let file of fileInput.files) {
      formData.append("driveFiles", file); 
    }

    fetch("/chat/upload/chat", {
      method: "POST",
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.res_code === "200") {
        const fileNames = data.fileNames;
        
        fileNames.forEach(fileName => {
        	const safeName = fileName.trim();
        	  const drivePath = data.drivePaths?.[fileName];  // ✅ 반드시 선언해야 함

        	  if (!drivePath) {
        	    console.warn(`[경고] ${fileName}에 대한 drivePath 없음`);
        	    return;
        	  }

        	  const chatData = {
        	    chatMessageContent: `[파일] ${fileName}`,
        	    senderMember: Number(myEmployeeNo),
        	    chatroomNo: Number(chatroomNo),
        	    receiverMember: isGroupChat ? null : receiverNo,
        	    driveOriName: fileName,
        	    drivePath: drivePath,
        	    senderProfileImageUrl: myProfileImageUrl,
                senderName: "나"
        	  };

        	  socket.send(JSON.stringify(chatData));
        	});

 	      fileInput.value = "";
 	      document.getElementById("chatFilePreview").innerHTML = "";
 	      messageInput.value = "";
 	      return;
      } else {
        alert("파일 업로드 실패: " + data.res_msg);
      }
    })
    .catch(err => {
      console.error("파일 업로드 오류:", err);
    });

    return; 
  }

  // 파일이 없는 경우에만 메시지 전송
  if (message) {
    const chatData = {
      chatMessageContent: message,
      senderMember: Number(myEmployeeNo),
      chatroomNo: Number(chatroomNo),
      receiverMember: isGroupChat ? null : receiverNo,
      senderProfileImageUrl: myProfileImageUrl, 
      senderName: "나"
    };
    socket.send(JSON.stringify(chatData));
    messageInput.value = "";
  }
}

		
function loadChatroomDetail(chatroomNo) {
    fetch('/chat/roomDetail?roomNo=' + chatroomNo)
        .then(response => response.json())
        .then(data => {
            const chatHistory = document.querySelector(".chat-history");
            if (!chatHistory) return;

            chatHistory.replaceChildren(document.createElement("hr"));

            if (data.messageList && data.messageList.length > 0) {
                const myEmployeeNo = document.getElementById("myEmployeeNo").value;

                data.messageList.forEach(msg => {
                    const isMyMessage = (msg.senderMember == myEmployeeNo);
                    const senderDisplayName = isMyMessage ? '나' : (msg.senderName || '알 수 없음');
                    const profileImageUrl = msg.senderProfileImageUrl || '/assets/img/profile/default-profile.png';

                    const messageDiv = document.createElement("div");
                    messageDiv.className = "mb-3";

                    const messageWrapper = document.createElement("div");
                    messageWrapper.className = `d-flex align-items-start ${isMyMessage ? 'justify-content-end' : 'justify-content-start'} mb-2`;

                    // 프로필 이미지 추가 ✅
                    const profileImg = document.createElement("img");
                    profileImg.src = profileImageUrl;
                    profileImg.className = "rounded-circle";
                    profileImg.style.width = "35px";
                    profileImg.style.height = "35px";

                    if (!isMyMessage) {
                        profileImg.classList.add("me-2");
                        messageWrapper.appendChild(profileImg);
                    }

                    const bubble = document.createElement("div");
                    bubble.className = `p-2 rounded-2 ${isMyMessage ? 'bg-primary text-white' : 'bg-light'}`;
                    bubble.style.maxWidth = "70%";

                    if (msg.driveOriName) {
                        const text = document.createElement("div");
                        text.textContent = `[파일] ${msg.driveOriName}`;
                        bubble.appendChild(text);
                    } else if (msg.chatMessageContent) {
                        const text = document.createElement("div");
                        text.textContent = msg.chatMessageContent;
                        bubble.appendChild(text);
                    }

                    if (msg.drivePath) {
                        const ext = msg.drivePath.split('.').pop().toLowerCase();
                        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);

                        if (isImage) {
                            const fileWrapper = document.createElement("div");
                            fileWrapper.className = "text-center";

                            const img = document.createElement("img");
                            img.src = "/files/" + msg.drivePath.replace(/^\/+/, "");
                            img.style.maxWidth = "180px";
                            img.style.maxHeight = "180px";
                            img.style.borderRadius = "8px";
                            img.style.objectFit = "cover";
                            img.style.display = "block";
                            img.style.margin = "0 auto";

                            fileWrapper.appendChild(img);
                            bubble.appendChild(fileWrapper);
                        } else {
                            const link = document.createElement("a");
                            link.href = "/files" + msg.drivePath;
                            link.target = "_blank";
                            link.className = "badge bg-info text-white mt-2 d-inline-block";
                            link.innerText = "📎 첨부파일 보기";
                            bubble.appendChild(link);
                        }
                    }

                    messageWrapper.appendChild(bubble);

                    if (isMyMessage) {
                        profileImg.classList.add("ms-2");
                        messageWrapper.appendChild(profileImg);
                    }

                    const senderNameDiv = document.createElement("div");
                    senderNameDiv.className = `d-flex ${isMyMessage ? 'justify-content-end' : 'justify-content-start'} mb-1`;
                    senderNameDiv.innerHTML = `<div class="small text-muted">${senderDisplayName}</div>`;

                    messageDiv.appendChild(senderNameDiv);
                    messageDiv.appendChild(messageWrapper);
                    chatHistory.appendChild(messageDiv);
                });

                const chatArea = document.querySelector(".flex-grow-1.overflow-auto");
                setTimeout(() => {
                	  if (chatArea) {
                	    chatArea.scrollTo({
                	      top: chatArea.scrollHeight,
                	      behavior: 'smooth'
                	    });
                	  }
                	}, 0);
            }
        })
        .catch(error => {
            console.error("채팅방 상세 조회 실패:", error);
        });
}



		function bindFilePreview() {
			  const fileInput = document.getElementById("chatFileInput");
			  if (!fileInput) return;
			  
			  fileInput.addEventListener("change", function (e) {
				  const previewArea = document.getElementById("chatFilePreview");
				  previewArea.innerHTML = "";

				  [...e.target.files].forEach((file, index) => {
				    const ext = file.name.split('.').pop().toLowerCase();
				    const isImage = file.type.startsWith("image/");
				    const iconMap = {
				      pdf: "/assets/img/icons/pdf.png",
				      docx: "/assets/img/icons/word.png",
				      xlsx: "/assets/img/icons/excel.png",
				      zip: "/assets/img/icons/zip.png"
				    };

				    const wrapper = document.createElement("div");
				    wrapper.className = "border p-2 rounded d-flex align-items-center gap-2 position-relative";
				    wrapper.style.maxWidth = "200px";

				    const thumb = document.createElement("img");
				    thumb.style.width = "32px";
				    thumb.style.height = "32px";
				    thumb.style.objectFit = "cover";
				    thumb.className = "rounded";

				    if (isImage) {
				      thumb.src = URL.createObjectURL(file);
				    } else if (iconMap[ext]) {
				      thumb.src = iconMap[ext];
				    } else {
				      thumb.src = "/assets/img/icons/file.png";
				    }

				    const name = document.createElement("div");
				    name.className = "small text-truncate";
				    name.innerText = file.name;

				    // ❌ 삭제 버튼
				    const removeBtn = document.createElement("button");
				    removeBtn.className = "btn btn-sm btn-light border position-absolute top-0 end-0 m-1 p-0";
				    removeBtn.style.width = "18px";
				    removeBtn.style.height = "18px";
				    removeBtn.innerText = "×";
				    removeBtn.onclick = () => {
				      const dt = new DataTransfer();
				      [...fileInput.files].forEach((f, i) => {
				        if (i !== index) dt.items.add(f);
				      });
				      fileInput.files = dt.files;
				      fileInput.dispatchEvent(new Event("change"));
				    };

				    wrapper.appendChild(thumb);
				    wrapper.appendChild(name);
				    wrapper.appendChild(removeBtn);
				    previewArea.appendChild(wrapper);
				  });
				});

			}
		function applyChatroomFilter(type) {
			  const allItems = document.querySelectorAll('.chat_list .item');

			  allItems.forEach(item => {
			    const isUnread = item.classList.contains('unread');
			    if (type === 'all') {
			      item.style.display = '';
			    } else if (type === 'read' && isUnread) {
			      item.style.display = 'none';
			    } else if (type === 'unread' && !isUnread) {
			      item.style.display = 'none';
			    } else {
			      item.style.display = '';
			    }
			  });
			}

			// 탭 버튼 클릭 이벤트 바인딩
			document.querySelectorAll('[data-chat-thread-list]').forEach(tab => {
			  tab.addEventListener('click', e => {
			    const type = tab.getAttribute('data-chat-thread-list');
			    applyChatroomFilter(type);

			    // 탭 active 클래스 갱신
			    document.querySelectorAll('[data-chat-thread-list]').forEach(t => t.classList.remove('active'));
			    tab.classList.add('active');
			  });
			});
			// 1대1채팅 바로가기
			document.querySelector('.search')?.addEventListener('input', function () {
				  const keyword = this.value.trim().toLowerCase();
				  const items = document.querySelectorAll('.chat_list .item');

				  items.forEach(item => {
				    const name = item.querySelector('.name')?.innerText.toLowerCase() || '';
				    item.style.display = name.includes(keyword) ? '' : 'none';
				  });
				});

			  document.addEventListener('DOMContentLoaded', function () {
				    const urlParams = new URLSearchParams(window.location.search);
				    const roomNo = urlParams.get('roomNo');

				    if (roomNo) {
				      openChatRoom(roomNo);
				    }
				  });
			  function openChatRoom(roomNo) {
				  const chatItem = document.querySelector(`[data-room-no="${roomNo}"]`);
				  if (chatItem) {
				    chatItem.click();
				  }
				}

				document.addEventListener('DOMContentLoaded', function () {
				  const urlParams = new URLSearchParams(window.location.search);
				  const roomNo = urlParams.get('roomNo');
				  if (roomNo) {
				    openChatRoom(roomNo);
				  }
				});
				let sharedFilePage = 0;
				const sharedFilePageSize = 5;
				let allFilesLoaded = false;

				document.getElementById("loadMoreFilesBtn")?.addEventListener("click", function () {
				  const chatroomNo = document.querySelector(".chatroom-title")?.dataset.roomNo;
				  if (!chatroomNo || allFilesLoaded) return;

				  fetch(`/chat/files?chatroomNo=${chatroomNo}&page=${sharedFilePage}&size=${sharedFilePageSize}`)
				    .then(res => res.json())
				    .then(files => {
				      if (files.length < sharedFilePageSize) {
				        allFilesLoaded = true;
				        this.style.display = "none"; // 더 이상 불러올 게 없으면 버튼 숨김
				      }

				      const container = document.getElementById("shared-file-list");
				      files.forEach(file => {
				    	  const name = file.oriName || file.driveOriName || file.name || null;
				    	  const path = file.path || file.drivePath;

				    	  if (!name || !path) {
				    	    console.warn("⚠️ 유효하지 않은 파일 데이터:", file);
				    	    return;
				    	  }

				    	  const ext = name.split('.').pop().toLowerCase();
				    	  const icon = getFileIconClass(ext);

				    	  const html = `
				    		  <a href="/chat/download/chat/${file.driveAttachNo}" download="${file.driveOriName}" class="text-decoration-none d-flex align-items-center py-3 w-100">
				    		  <div class="btn-icon btn-icon-lg border rounded-3 text-body-quaternary flex-column me-2">
				    		    <i class="fa-solid ${icon} fs-8 mb-1"></i>
				    		    <p class="mb-0 fs-10 fw-bold lh-1">${ext}</p>
				    		  </div>
				    		  <div class="flex-1">
				    		    <h6 class="text-body line-clamp-1">${name}</h6>
				    		    <div class="d-flex align-items-center lh-1">
				    		      <p class="fs-10 mb-0 text-body-tertiary fw-semibold">${file.size || ''}</p>
				    		      <span class="fa-solid fa-circle text-body-quaternary fs-10 mx-1"></span>
				    		      <p class="fs-10 mb-0 text-body-tertiary fw-semibold">${file.regDate || ''}</p>
				    		    </div>
				    		  </div>
				    		  <i class="fa-regular fa-circle-down fs-8 text-body-tertiary ms-auto"></i>
				    		</a>
				    	    </div>`;
				    	  
				    	  container.insertAdjacentHTML("beforeend", html);
				    	});
				    	sharedFilePage++;
				    })
				    .catch(err => console.error("❌ 공유 파일 더보기 실패:", err));
				});
		</script>
		<script>
		<!-- 트리구조 -->
		function handleCheck(checkbox) {
			  const isGroup = document.querySelector('input[name="chatIsGroupYn"]:checked')?.value === 'Y';
			  const isEmp = checkbox.classList.contains("emp-checkbox");

			  const name = checkbox.getAttribute('data-name');
			  const code = checkbox.getAttribute('data-no');
			  const li = checkbox.closest('li.treeview-list-item');

			  // ✅ 1:1 제약 강제: 사원 아니거나 이미 선택된 경우 → 강제 해제 및 중단
			  if (!isGroup) {
				  if (!isEmp) {
				    alert("1:1 채팅은 사원만 선택할 수 있습니다.");
				    checkbox.checked = false;
				    return;
				  }
				
				  const selectedCount = document.querySelectorAll('#selectedTags .card').length;
				  const isAlreadyChecked = document.getElementById(`tag-${code}`) !== null;
				
				  // 새로 선택하려는 경우에만 제한
				  if (!isAlreadyChecked && selectedCount >= 1) {
				    alert("1:1 채팅은 한 명만 선택할 수 있습니다.");
				    checkbox.checked = false;
				    return;
				  }
				}

			  // ✅ 통과한 경우만 처리
			  if (checkbox.checked) {
			    addTag(name, code);
			    handleHighlight(li);
			  } else {
			    removeTag(code);
			  }

			  updateChildren(checkbox, checkbox.checked);
			  updateParents(checkbox);
			}

		function updateChildren(checkbox, isChecked) {
			  const li = checkbox.closest('li.treeview-list-item');
			  if (!li) return;

			  const descendants = li.querySelectorAll('input[type="checkbox"]');
			  descendants.forEach(child => {
			    if (child !== checkbox) {
			      child.checked = isChecked;

			      // 하위 태그 제거 (상위 클릭 시 기존 하위 태그 남는 문제 해결)
			      const code = child.getAttribute('data-no');
			      removeTag(code);
			    }
			  });
			}
		function updateParents(checkbox) {
			  let li = checkbox.closest('li.treeview-list-item');

			  while (li) {
			    const parentLi = li.parentElement.closest('li.treeview-list-item');
			    if (!parentLi) break;

			    const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[type="checkbox"]');
			    const childCheckboxes = Array.from(parentLi.querySelectorAll(':scope > ul > li.treeview-list-item > .treeview-text input[type="checkbox"]'));

			    const allChecked = childCheckboxes.length > 0 && childCheckboxes.every(cb => cb.checked);
			    const someChecked = childCheckboxes.some(cb => cb.checked);

			    if (parentCheckbox) {
			      if (allChecked) {
			        parentCheckbox.checked = true;

			        // 상위만 tag
			        const pname = parentCheckbox.getAttribute('data-name');
			        const pcode = parentCheckbox.getAttribute('data-no');
			        addTag(pname, pcode);

			        // 하위 tag 제거
			        childCheckboxes.forEach(cb => removeTag(cb.getAttribute('data-no')));

			      } else if (someChecked) {
			        parentCheckbox.checked = false;

			        // 상위 tag 제거
			        const pcode = parentCheckbox.getAttribute('data-no');
			        removeTag(pcode);

			        // 하위 중 체크된 것만 tag 추가
			        childCheckboxes.forEach(cb => {
			          const cname = cb.getAttribute('data-name');
			          const ccode = cb.getAttribute('data-no');
			          if (cb.checked) addTag(cname, ccode);
			          else removeTag(ccode);
			        });

			      } else {
			        parentCheckbox.checked = false;

			        // 전부 제거
			        const pcode = parentCheckbox.getAttribute('data-no');
			        removeTag(pcode);
			      }
			    }

			    li = parentLi;
			  }
			}
		function addTag(label, code) {
			  const tagWrap = document.getElementById("selectedTags");
			  const myCode = document.getElementById("myEmployeeNo")?.value;

			  // 이미 존재하면 중복 방지
			  if (document.getElementById(`tag-${code}`)) return;

			  // ▶ 본인 직접 선택한 경우는 제외 (emp-checkbox만)
			  const checkbox = document.querySelector(`input[data-no="${code}"]`);
			  const isEmp = checkbox?.classList.contains("emp-checkbox");
			  if (code === myCode && isEmp && isCreateMode) {
			    alert("오류: 본인은 참여자로 선택할 수 없습니다.");
			    if (checkbox) checkbox.checked = false; // 체크 해제
			    return;
			  }
			  
			  if (!isCreateMode && isEmp && window.existingParticipantIds?.includes(code)) {
				    alert("이미 채팅방에 참여 중인 사원입니다.");
				    if (checkbox) checkbox.checked = false;
				    return;
				  }

			  // Card 생성
			  const card = document.createElement("div");
			  card.className = "card mb-2";
			  card.id = `tag-${code}`;
			  card.name = `tag-${label}`;
			  card.style.borderRadius = "5px";
			  card.style.padding = "8px";
			  card.style.backgroundColor = "#f8f9fa";
			  card.style.display = "block";

			  // 라벨
			  const labelElement = document.createElement("span");
			  labelElement.textContent = label;
			  card.appendChild(labelElement);

			  // 삭제 버튼
			  const button = document.createElement("button");
			  button.type = "button";
			  button.className = "btn-close";
			  button.style.float = "right";
			  button.setAttribute("aria-label", "Remove");
			  button.addEventListener("click", () => {
			    card.remove();
			    removeTag(code, true);
			  });

			  card.appendChild(button);
			  tagWrap.appendChild(card);
			}

		function removeTag(code, skipCheckbox = false) {
			  const tag = document.getElementById(`tag-${code}`);
			  if (tag) tag.remove();

			  if (!skipCheckbox) return;

			  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
			  if (checkbox && checkbox.checked) {
			    checkbox.checked = false;
			    handleCheck(checkbox); // 연쇄 동기화
			  }
			}
		function confirmSelection() {
			  const selected = document.querySelectorAll("#selectedTags .card");
			  const result = Array.from(selected).map((el, index) => ({
			    code: el.id.replace('tag-', ''),
			    name: el.name.replace('tag-', ''),
			    step: index + 1
			  }));

			  // 기존 hidden input 제거
			  document.querySelectorAll('input[name="participantIds"]').forEach(el => el.remove());

			  // form에 input 동적으로 추가
			  const form = document.getElementById("createChatForm");
			  result.forEach(item => {
			    const input = document.createElement('input');
			    input.type = 'hidden';
			    input.name = 'participantIds';
			    input.value = item.code;
			    form.appendChild(input);
			  });

			  bootstrap.Modal.getInstance(document.getElementById('treeModal')).hide();
			}

		
		document.addEventListener('DOMContentLoaded', function () {
			  const tree = document.querySelector('#treeviewTree');

			  tree.addEventListener('click', function (e) {
			    // 최상위 `li`인지 확인
			    const clickedLi = e.target.closest('li.treeview-list-item');
			    if (!clickedLi) return;

			    // 클릭된 대상이 '이룸 컴퍼니'인지 확인
			    const isRootCompany = clickedLi.querySelector('#eroomCompanySpan');
			    if (isRootCompany) {
			      e.stopPropagation(); // 🚫 이벤트 전파 방지
			      return;
			    }

			    // 클릭된 요소가 체크박스인지 확인
			    if (e.target.type === 'checkbox') {
			      handleCheck(e.target);
			      e.stopPropagation(); // 🚫 이벤트 전파 방지
			      return;
			    }

			    // 클릭된 요소가 '사원명' 또는 'treeview-text'일 경우만 체크박스 토글
			    if (e.target.classList.contains('treeview-label-text') || e.target.classList.contains('treeview-text')) {
			      const checkbox = clickedLi.querySelector('input[type="checkbox"].emp-checkbox');

			      // 숨겨진 체크박스일 경우 포인터 이벤트 차단
			      if (checkbox && checkbox.offsetParent === null) {
			        e.stopPropagation();
			        return;
			      }

			      if (checkbox) {
			        checkbox.checked = !checkbox.checked; // 체크박스 상태 변경
			        handleCheck(checkbox); // 상하위 동기화 처리
			      }
			    }

			    // 클릭된 요소에 대해 강조 표시 처리 (handleHighlight 재사용)
			    handleHighlight(clickedLi);
			  });
			});
		</script>
		<script>
	document.getElementById('clearBtn').addEventListener('click', resetTree);
	
	function resetTree() {
		  // 1. 선택된 태그 비우기
		  document.getElementById('selectedTags').innerHTML = '';

		  // 2. 모든 체크박스 해제
		  const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
		  checkboxes.forEach(cb => {
		    cb.checked = false;
		  });

		  // 3. 강조 스타일 제거 (이룸 컴퍼니 제외)
		  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => {
		    // 이룸 컴퍼니 제외
		    if (!el.closest('a')?.querySelector('#eroomCompanySpan')) {
		      el.classList.remove('text-info-light');
		    }
		  });

		  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => {
		    if (el.id !== 'eroomCompanySpan') {
		      el.classList.remove('treeview-label-strong');
		    }
		  });

		  // 4. 트리 접기 (이룸 컴퍼니 제외)
		  document.querySelectorAll('.treeview-list.collapse').forEach(ul => {
		    if (ul.id !== 'tree-company') {
		      ul.classList.remove('show');
		    } else {
		      ul.classList.add('show');
		    }
		  });
		}
	function renderChatroomUI(chatroomNo, chatroomName, isGroup) {
		  const chatContent = document.getElementById("chat-content");
		  chatContent.innerHTML = ""; // 기존 내용 비우기

		  const template = document.getElementById("chat-pane-template");
		  const clone = template.content.cloneNode(true);

		  const titleEl = clone.querySelector(".chatroom-title");
		  titleEl.textContent = chatroomName;
		  titleEl.dataset.group = isGroup ? "Y" : "N";
		  titleEl.dataset.roomNo = chatroomNo;

		  const messageInput = clone.querySelector("#messageInput");
		  const sendBtn = clone.querySelector("#sendBtn");

		  messageInput?.removeEventListener("keydown", messageKeyHandler);
		  messageInput?.addEventListener("keydown", messageKeyHandler);
		  sendBtn?.addEventListener("click", sendMessage);

		  bindFilePreview();
		  chatContent.appendChild(clone);
		}

		function messageKeyHandler(e) {
		  if (e.key === "Enter" && !e.shiftKey) {
		    e.preventDefault();
		    sendMessage();
		  }
		}


</script>
		<script>
		function handleHighlight(li) {
			  if (!li) return; // ❗예외 처리
		
			  // 기존 강조 제거
			  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => el.classList.remove('text-info-light'));
			  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => el.classList.remove('treeview-label-strong'));
		
			  // 현재 강조
			  const icon = li.querySelector('.treeview-icon');
			  const label = li.querySelector('.treeview-label-text');
			  if (icon) icon.classList.add('text-info-light');
			  if (label) label.classList.add('treeview-label-strong');
		
			  // 상위 강조
			  let currentUl = li.parentElement;
			  while (currentUl && currentUl.classList.contains('treeview-list')) {
			    const parentLi = currentUl.closest('li.treeview-list-item');
			    if (!parentLi) break;
		
			    const parentIcon = parentLi.querySelector('.treeview-icon');
			    const parentLabel = parentLi.querySelector('.treeview-label-text');
			    if (parentIcon) parentIcon.classList.add('text-info-light');
			    if (parentLabel) parentLabel.classList.add('treeview-label-strong');
		
			    currentUl = parentLi.parentElement;
			  }
			}
		
		</script>
	</main>
</body>
</html>