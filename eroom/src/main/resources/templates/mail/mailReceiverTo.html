<!DOCTYPE html>
<html 
lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{/include/layout}">
	  
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>

  <body>
    <main class="main" id="top" layout:fragment="content">
      <div class="row align-items-center justify-content-between g-3 mb-4">
		<!-- ìƒë‹¨ ì œëª© -->
		<div class="d-flex justify-content-start">
			<span class="fw-bold fs-6">ë°›ì€ ë©”ì¼í•¨</span>
		</div>
		<input type="hidden" id="myEmployeeNo"
			th:value="${#authentication.principal.employee.employeeNo}">
	</div>
   <div id="mailSummary" data-list='{"valueNames":["senderName", "mailTitle", "mailContent", "sendTime"], "page":6, "pagination":true}'>   
      <div class="row gx-lg-6 gx-3 py-4 z-2 position-sticky bg-body email-header">
            <div class="col-auto"><a class="btn btn-primary email-sidebar-width d-none d-lg-block" th:href="@{mailCreate}">ë©”ì¼ ì“°ê¸°</a>
            </div> 
            <div class="col-auto d-lg-none"><a class="btn btn-primary px-3 px-sm-4" th:href="@{mailCreate}"> <span class="d-none d-sm-inline-block">ë©”ì¼ ì“°ê¸°</span><span class="d-sm-none fas fa-plus"></span></a></div>
            <div class="col-auto flex-1">
              
              <div class="search-box w-100" style="max-width: 250px; position: absolute; right: 20px;">
              <form class="position-relative">
                <input class="form-control search-input search" type="search" placeholder="ê²€ìƒ‰" aria-label="Search" />
                <span class="fas fa-search search-box-icon"></span>
              </form>
            </div>
            </div>
       </div>
       <div class="px-lg-1">
                <div class="d-flex align-items-center flex-wrap position-sticky pb-2 bg-body z-2 email-toolbar inbox-toolbar">
                  <div class="d-flex align-items-center flex-1 me-2">
                    <button class="btn btn-sm p-0 me-2" type="button" onclick="location.reload()"><span class="text-primary fas fa-redo fs-10"></span></button>
                    <p class="fw-semibold fs-10 text-body-tertiary text-opacity-85 mb-0 lh-sm text-nowrap">ìƒˆë¡œ ê³ ì¹¨</p>
                  </div>
                  <div class="d-flex">
                  	<select class="form-control search-input search" onchange="location = this.value;">
                  		<option disabled selected>ì •ë ¬ ì„ íƒ</option>
					    <option value="?sortOrder=latest" th:selected="${sortOrder == 'latest'}">ìµœì‹ ìˆœ</option>
					    <option value="?sortOrder=oldest" th:selected="${sortOrder == 'oldest'}">ì˜¤ë˜ëœìˆœ</option>
					</select>
                  </div>
                </div>
                <!-- ë²”ìš©ì„± ìƒê°í•´ì„œ ì¼ë‹¨ ë³´ë¥˜ -->
                <div class="border-top border-translucent py-2 d-flex justify-content-between">
                  <div class="form-check mb-0 fs-8">
                    <input class="form-check-input" type="checkbox" data-bulk-select-row="data-bulk-select-row" id="chechAll" />
                  </div>
                  <div>
                    <button id="deleteBtn" class="btn p-0 me-2 text-body-quaternary hover text-body-tertiary text-opacity-85" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="íœ´ì§€í†µ"><span class="fas fa-trash fs-10"></span></button>
                    <button id="starBtn" class="btn p-0 me-2 text-body-quaternary hover text-body-tertiary text-opacity-85" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ì¤‘ìš”"><span class="fas fa-star fs-10"></span></button>
                  </div>
                </div>
                <!-- ë²”ìš©ì„± ìƒê°í•´ì„œ ì¼ë‹¨ ë³´ë¥˜ -->
                
                <!-- ë©”ì¼ ëª©ë¡ ìŠ¤íƒ€íŠ¸ë¶€ë¶„ -->
                <div th:if="${#lists.isEmpty(receivedMails)}">
                	<div class="col-12">
							<div class="alert alert-light text-center border border-secondary-light rounded py-4 fs-6 fw-semibold text-body-secondary">
								<i class="fa-solid fa-circle-info me-2 text-secondary"></i>ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
							</div>
						</div>
                </div>
                <div class="list">
                 <div class="border-top border-translucent hover-actions-trigger py-3"
                 		th:if="${!#lists.isEmpty(receivedMails)}"
                 		th:each="receiverMail : ${receivedMails}"
                 		th:onclick="|location.href='@{/mail/detail/{id}(id=${receiverMail.mail.mailNo})}'|"
                 		th:classappend="${receiverMail.mailReceiverReadYn == 'N'} ? 'bg-primary-subtle text-primary-emphasis' : ''">
                  <div class="row align-items-sm-center gx-2">
                    <div class="col-auto">
                      <div class="d-flex flex-column flex-sm-row">
                        <input class="form-check-input mb-2 m-sm-0 me-sm-2 mail_checkbox" type="checkbox" id="checkbox-1" data-bulk-select-row="data-bulk-select-row" 
                        		th:value="${receiverMail.mail.mailNo}"
                        		onclick="event.stopPropagation()"/>
                        <!-- ë³„ ë°•ìŠ¤ -->
                        <!-- <button class="btn p-0"><span class="fas text-warning fa-star"></span></button> -->
                      	<form th:action="@{/mail/status/important/{id}(id=${receiverMail.mail.mailNo})}" method="post">
						    <input type="hidden" name="redirectUrl" value="/mail/receiverTo" />
						    <button class="btn p-0" type="submit" onclick="event.stopPropagation()">
						        <span th:classappend="${
						            mailStatusMap[receiverMail.mail.mailNo]?.mailStatusImportantYn == 'Y' 
						                ? 'fas text-warning fa-star' 
						                : 'far fa-star'
						        }"></span>
						    </button>
						</form>
                      </div>
                    </div>
                    
                    <!-- í”„ë¡œí•„ ì‚¬ì§„ ì´ë¯¸ì§€ ë¶€ë¶„  -->
                    <div class="col-auto">
                      <div class="avatar avatar-s  rounded-circle">
                        <img class="rounded-circle " src="../../assets/img/team/60.webp" alt="" />

                      </div>
                    </div>
                    <div class="col-auto">
					  <a class="inbox-link fs-9 senderName"
					     th:href="@{/mail/detail/{id}(id=${receiverMail.mail.mailNo})}"
					     th:classappend="${receiverMail.mailReceiverReadYn == 'N'} ? 'fw-bold text-body-emphasis' : 'text-body-secondary'"
					     th:text="${receiverMail.mail != null and receiverMail.mail.sender != null ? receiverMail.mail.sender.employeeName : 'ì•Œ ìˆ˜ ì—†ìŒ'}">
					     ë³´ë‚¸ ì‚¬ëŒ
					  </a>
					  <!-- ì¡°ê¸ˆ ë–¨ì–´ì ¸ ìˆìœ¼ë©´ ì¢‹ê² ìŒ  -->
					  <span>|</span>
					  <!-- <span class="inbox-link fs-9"
					  		th:classappend="${receiverMail.mailReceiverReadYn == 'N'} ? 'fw-bold text-body-emphasis' : 'text-body-secondary'"
					        th:text="${receiverMail.mail.mailTitle}">
					  </span> -->
					  <span 
					  		th:classappend="${receiverMail.mailReceiverReadYn == 'N'} ? 'fw-bold text-body-emphasis' : 'text-body-secondary'"
					  		class="inbox-link fs-9 text-body-emphasis mailTitle" th:text="${receiverMail.mail.mailTitle != null and !#strings.isEmpty(receiverMail.mail.mailTitle) ? receiverMail.mail.mailTitle : '(ì œëª©ì—†ìŒ)'}">
					 </span>
					</div>
                    <div class="col-auto ms-auto">
                      <!-- <div class="hover-actions end-0">
                        <button class="btn btn-phoenix-secondary btn-icon dropdown-toggle dropdown-caret-none" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fa-solid fa-ellipsis"></span></button>
                        <div class="dropdown-menu dropdown-menu-end py-2">
                        <form th:action="@{/mail/status/important/{id}(id=${receiverMail.mail.mailNo})}" method="post">
						  <input type="hidden" name="redirectUrl" value="/mail/receiverTo" />
						  <button type="submit" class="dropdown-item">â­ì¤‘ìš” í‘œì‹œ</button>
						</form>
                        <form th:action="@{/mail/trash/{id}(id=${receiverMail.mail.mailNo})}" method="post">
                        	<input type="hidden" name="redirectUrl" value="/mail/receiverTo"/>
						  <button type="submit" class="dropdown-item">ğŸ—‘ï¸íœ´ì§€í†µ</button>
						</form>
						
                        <a class="dropdown-item text-danger" href="#!">ì‚­ì œ</a>
                        </div>
                      </div> -->
                      
                      
                      <!-- 04/17 ë‚˜ì¤‘ì— ì‹œê°„ ë‚¨ìœ¼ë©´ ì¢€ ë” êµ¬ì„±í•´ë³´ê¸° ì¼ë‹¨ ì „ì²´ ì‹œê°„ ë‹¤ ë³´ì´ê²Œ ì„¤ì •í•¨ -->
                       <span class="fs-10 fw-bold sendTime"
					      th:text="${#temporals.format(receiverMail.mail.mailSentTime, 'yyyy.MM.dd HH:mm:ss')}">
					  </span> 
					
                    </div>
                  </div>
                  <div class="ms-4 mt-n3 mt-sm-0 ms-sm-11">
					  <div class="d-block inbox-link"
					     
					     th:data-receiver-id="${#authentication.principal.employee.employeeNo}">
					     
					     <!-- <span class="fs-9 line-clamp-1 mailTitle"
					           th:classappend="${receiverMail.mailReceiverReadYn == 'N'} ? 'fw-bold text-body-emphasis' : 'text-body-secondary'"
					           th:text="${receiverMail.mail.mailTitle}">
					     </span> -->
						<span class="fs-9 ps-0 text-body-tertiary mb-0 line-clamp-2 mailContent" th:utext="${receiverMail.mail.mailContent != null and !#strings.isEmpty(receiverMail.mail.mailContent) ? receiverMail.mail.mailContent : '(ë‚´ìš©ì—†ìŒ)'}"></span>
					     <!-- <span class="fs-9 ps-0 text-body-tertiary mb-0 line-clamp-2 mailContent"
					           th:utext="${receiverMail.mail.mailContent}">
					     </span> -->
					  </div>
					</div>
                </div>
                </div>
                <!-- <div class="d-flex flex-wrap align-items-center justify-content-between py-3 pe-0 fs-9 border-bottom border-translucent">
		              <div class="d-flex">
		             	<p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">ì „ì²´ ë³´ê¸°<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">ì ‘ê¸°<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
		              </div>
		              
		              <div class="d-flex">
		                <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
		                <ul class="mb-0 pagination"></ul>
		                <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
		              </div>
            	</div> -->
            	<!-- <nav aria-label="Page navigation example">
					  <ul class="pagination justify-content-center">
					    <li class="page-item"><a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a></li>
					    <li class="page-item"><a class="page-link" href="#">1</a></li>
					    <li class="page-item"><a class="page-link" href="#">2</a></li>
					    <li class="page-item"><a class="page-link" href="#">3</a></li>
					    <li class="page-item active" aria-current="page"><a class="page-link" href="#">4</a></li>
					    <li class="page-item"><a class="page-link" href="#">5</a></li>
					    <li class="page-item"><a class="page-link" href="#">Next</a></li>
					  </ul>
					</nav> -->
				<div class="d-flex justify-content-center mt-3">
							<div class="d-flex">
								<button class="page-link disabled" data-list-pagination="prev"
									disabled>
									<i class="fas fa-chevron-left"></i>
								</button>
								<ul class="mb-0 pagination">
									<li class="active">
										<button class="page" type="button" data-i="1" data-page="5">1</button>
									</li>
								</ul>
								<button class="page-link pe-0" data-list-pagination="next"
									disabled>
									<i class="fas fa-chevron-right"></i>
								</button>
							</div>
						</div>	
           </div>
         </div>
         <script>
         const checkAll = document.getElementById('chechAll');
         checkAll.addEventListener('change', function () {
           const isChecked = this.checked;
           const checkboxes = document.querySelectorAll('.mail_checkbox');
           checkboxes.forEach(cb => cb.checked = isChecked);
         });
         function getSelectedMailNos() {
        	    return Array.from(document.querySelectorAll('.mail_checkbox:checked'))
        	      .map(cb => cb.value);
        	  }

        	  function sendBulkUpdate(url) {
        	    const selected = getSelectedMailNos();
        	    console.log(selected);	
        	    if (selected.length === 0) {
        	      alert("ë©”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        	      return;
        	    }

        	    fetch(url, {
        	      method: 'POST',
        	      headers: { 
						'Content-Type': 'application/json' ,
						'header': document.querySelector('meta[name="_csrf_header"]').content,
                        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
						},
        	      body: JSON.stringify(selected)
        	    }).then(res => {
        	      if (res.ok) location.reload();
        	      else alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        	    });
        	  }

        	  document.getElementById('deleteBtn').addEventListener('click', function () {
        	    sendBulkUpdate('/mail/trash');
        	  });

        	  document.getElementById('starBtn').addEventListener('click', function () {
        	    sendBulkUpdate('/mail/important');
        	  });
         
         
         document.addEventListener("DOMContentLoaded", function() {
        	 	const senderNo = document.getElementById("myEmployeeNo").value; 
        	    const socket = new WebSocket("ws://localhost:8080/ws/mail?senderNo="+senderNo);  // wss://ë¡œ ìˆ˜ì • í•„ìš” ì‹œ, ë³€ê²½

        	    socket.onopen = () => {
        	      console.log("ë©”ì¼ ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ");
        	    };

        	    socket.onmessage = (event) => {
        	      const data = JSON.parse(event.data);
        	      if (data.type === "mail") {
        	        console.log("ìƒˆ ë©”ì¼ ë„ì°©", data);
        	        fetchNewMails(); // ìƒˆ ë©”ì¼ ë„ì°© ì‹œ ë°›ì€ ë©”ì¼ ëª©ë¡ Ajaxë¡œ ê°±ì‹ 
        	      }
        	    };

        	    socket.onerror = (error) => {
        	      console.error("ì›¹ì†Œì¼“ ì˜¤ë¥˜:", error);
        	    };

        	    socket.onclose = () => {
        	      console.log("ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ");
        	    };

        	    // ìƒˆë¡œìš´ ë©”ì¼ì„ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
        	    function fetchNewMails() {
        	      fetch('/mail/receiverTo/fragment')
        	        .then(response => response.text())
        	        .then(html => {
        	          // ê°±ì‹ ëœ HTMLë¡œ mailSummary ì½˜í…ì¸  ë³€ê²½
        	          const mailSummary = document.querySelector('#mailSummary');
        	          mailSummary.innerHTML = html;

        	          // List.js ì¬ì´ˆê¸°í™”
        	          initializeListJs();
        	        })
        	        .catch(error => console.error('ë©”ì¼ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨:', error));
        	    }

        	    // List.js ì´ˆê¸°í™” í•¨ìˆ˜
        	    function initializeListJs() {
        	      const options = {
        	        valueNames: ["senderName", "mailTitle", "mailContent", "sendTime"],
        	        page: 6,
        	        pagination: true
        	      };

        	      // ê¸°ì¡´ List.js ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì´ˆê¸°í™” í›„ ìƒˆë¡œ ìƒì„±
        	      if (window.mailList && typeof window.mailList.destroy === "function") {
            			window.mailList.destroy();  // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
        			}

        	      window.mailList = new List('mailSummary', options);  // 'mailSummary'ë¥¼ List.jsì— ì—°ê²°
        	    }

        	    // ì´ˆê¸° List.js ì„¤ì • (í˜ì´ì§€ ë¡œë”© ì‹œ ì´ˆê¸°í™”)
        	    initializeListJs();
        	});
         </script>
    </main>
  </body>
</html>