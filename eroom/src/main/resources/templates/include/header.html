<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<th:block th:fragment="headerLayout">
	 <nav class="navbar navbar-top fixed-top navbar-expand" id="navbarDefault">
        <div class="collapse navbar-collapse justify-content-between">
          <div class="navbar-logo">

            <button class="btn navbar-toggler navbar-toggler-humburger-icon hover-bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#navbarVerticalCollapse" aria-controls="navbarVerticalCollapse" aria-expanded="false" aria-label="Toggle Navigation"><span class="navbar-toggle-icon"><span class="toggle-line"></span></span></button>
            <a class="navbar-brand me-1 me-sm-3" th:href="@{/}">
              <div class="d-flex align-items-center">
                <div class="d-flex align-items-center"><img src="/assets/img/icons/logo.png" alt="phoenix" width="27" />
                  <h5 class="logo-text ms-2 d-none d-sm-block">Eroom</h5>
                </div>
              </div>
            </a>
          </div>
          <div class="search-box navbar-top-search-box d-none d-lg-block" data-list='{"valueNames":["title"]}' style="width:25rem;">
            <!-- <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
              <input class="form-control search-input fuzzy-search rounded-pill form-control-sm" type="search" placeholder="Search..." aria-label="Search" />
              <span class="fas fa-search search-box-icon"></span>

            </form> -->
            <!-- <div class="btn-close position-absolute end-0 top-50 translate-middle cursor-pointer shadow-none" data-bs-dismiss="search">
              <button class="btn btn-link p-0" aria-label="Close"></button>
            </div> -->
            <div class="dropdown-menu border start-0 py-0 overflow-hidden w-100">
              <div class="scrollbar-overlay" style="max-height: 30rem;">
                <div class="list pb-3">
                  <h6 class="dropdown-header text-body-highlight fs-10 py-2">24 <span class="text-body-quaternary">results</span></h6>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Recently Searched </h6>
                  <div class="py-2"><a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"><span class="fa-solid fa-clock-rotate-left" data-fa-transform="shrink-2"></span> Store Macbook</div>
                      </div>
                    </a>
                    <a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"> <span class="fa-solid fa-clock-rotate-left" data-fa-transform="shrink-2"></span> MacBook Air - 13″</div>
                      </div>
                    </a>

                  </div>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Products</h6>
                  <div class="py-2"><a class="dropdown-item py-2 d-flex align-items-center" href="/apps/e-commerce/landing/product-details.html">
                      <div class="file-thumbnail me-2"><img class="h-100 w-100 object-fit-cover rounded-3" src="/assets/img/products/60x60/3.png" alt="" /></div>
                      <div class="flex-1">
                        <h6 class="mb-0 text-body-highlight title">MacBook Air - 13″</h6>
                        <p class="fs-10 mb-0 d-flex text-body-tertiary"><span class="fw-medium text-body-tertiary text-opactity-85">8GB Memory - 1.6GHz - 128GB Storage</span></p>
                      </div>
                    </a>
                    <a class="dropdown-item py-2 d-flex align-items-center" href="/apps/e-commerce/landing/product-details.html">
                      <div class="file-thumbnail me-2"><img class="img-fluid" src="/assets/img/products/60x60/3.png" alt="" /></div>
                      <div class="flex-1">
                        <h6 class="mb-0 text-body-highlight title">MacBook Pro - 13″</h6>
                        <p class="fs-10 mb-0 d-flex text-body-tertiary"><span class="fw-medium text-body-tertiary text-opactity-85">30 Sep at 12:30 PM</span></p>
                      </div>
                    </a>

                  </div>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Quick Links</h6>
                  <div class="py-2"><a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"><span class="fa-solid fa-link text-body" data-fa-transform="shrink-2"></span> Support MacBook House</div>
                      </div>
                    </a>
                    <a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"> <span class="fa-solid fa-link text-body" data-fa-transform="shrink-2"></span> Store MacBook″</div>
                      </div>
                    </a>

                  </div>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Files</h6>
                  <div class="py-2"><a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"><span class="fa-solid fa-file-zipper text-body" data-fa-transform="shrink-2"></span> Library MacBook folder.rar</div>
                      </div>
                    </a>
                    <a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"> <span class="fa-solid fa-file-lines text-body" data-fa-transform="shrink-2"></span> Feature MacBook extensions.txt</div>
                      </div>
                    </a>
                    <a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"> <span class="fa-solid fa-image text-body" data-fa-transform="shrink-2"></span> MacBook Pro_13.jpg</div>
                      </div>
                    </a>

                  </div>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Members</h6>
                  <div class="py-2"><a class="dropdown-item py-2 d-flex align-items-center" href="/pages/members.html">
                      <div class="avatar avatar-l status-online  me-2 text-body">
                        <img class="rounded-circle " src="/assets/img/team/40x40/10.webp" alt="" />

                      </div>
                      <div class="flex-1">
                        <h6 class="mb-0 text-body-highlight title">Carry Anna</h6>
                        <p class="fs-10 mb-0 d-flex text-body-tertiary">anna@technext.it</p>
                      </div>
                    </a>
                    <a class="dropdown-item py-2 d-flex align-items-center" href="/pages/members.html">
                      <div class="avatar avatar-l  me-2 text-body">
                        <img class="rounded-circle " src="/assets/img/team/40x40/12.webp" alt="" />

                      </div>
                      <div class="flex-1">
                        <h6 class="mb-0 text-body-highlight title">John Smith</h6>
                        <p class="fs-10 mb-0 d-flex text-body-tertiary">smith@technext.it</p>
                      </div>
                    </a>

                  </div>
                  <hr class="my-0" />
                  <h6 class="dropdown-header text-body-highlight fs-9 border-bottom border-translucent py-2 lh-sm">Related Searches</h6>
                  <div class="py-2"><a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"><span class="fa-brands fa-firefox-browser text-body" data-fa-transform="shrink-2"></span> Search in the Web MacBook</div>
                      </div>
                    </a>
                    <a class="dropdown-item" href="/apps/e-commerce/landing/product-details.html">
                      <div class="d-flex align-items-center">

                        <div class="fw-normal text-body-highlight title"> <span class="fa-brands fa-chrome text-body" data-fa-transform="shrink-2"></span> Store MacBook″</div>
                      </div>
                    </a>

                  </div>
                </div>
                <div class="text-center">
                  <p class="fallback fw-bold fs-7 d-none">No Result Found.</p>
                </div>
              </div>
            </div>
          </div>
          <ul class="navbar-nav navbar-nav-icons flex-row">
            <li class="nav-item">
              <div class="theme-control-toggle fa-icon-wait px-2">
                <input class="form-check-input ms-0 theme-control-toggle-input" type="checkbox" data-theme-control="phoenixTheme" value="dark" id="themeControlToggle" />
                <label class="mb-0 theme-control-toggle-label theme-control-toggle-light" for="themeControlToggle" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Switch theme" style="height:32px;width:32px;"><span class="icon" data-feather="moon"></span></label>
                <label class="mb-0 theme-control-toggle-label theme-control-toggle-dark" for="themeControlToggle" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Switch theme" style="height:32px;width:32px;"><span class="icon" data-feather="sun"></span></label>
              </div>
            </li>
            <li class="nav-item d-lg-none"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchBoxModal"><span data-feather="search" style="height:19px;width:19px;margin-bottom: 2px;"></span></a></li>
            <li class="nav-item dropdown">
            <a class="nav-link" href="#" style="min-width: 2.25rem" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-bs-auto-close="outside" id="notificationBell">
			  <span id="notificationIconWrapper" style="position: relative; display: inline-block;">
			    <span class="d-block" style="height:20px;width:20px;">
			      <span data-feather="bell" style="height:20px;width:20px;"></span>
			    </span>
			    <span id="notificationDot" style="
			      display: none;
			      position: absolute;
			      top: 0;
			      right: 0;
			      width: 8px;
			      height: 8px;
			      background-color: red;
			      border-radius: 50%;
			      border: 1px solid white;">
			    </span>
			  </span>
			</a>						   
            <div class="dropdown-menu dropdown-menu-end notification-dropdown-menu py-0 shadow border navbar-dropdown-caret" id="navbarDropdownNotfication" aria-labelledby="navbarDropdownNotfication">
              <div class="card position-relative border-0">
                <div class="card-header p-2">
                  <div class="d-flex justify-content-between">
                    <h5 class="text-body-emphasis mb-0">알림</h5>
						<button id="markAllAsReadBtn"
					        class="btn btn-link fw-bold fs-10 text-primary text-opacity-30 p-0"
					        type="button">
					  전체 읽음 처리
						</button>
						<input type="hidden" id="loginEmployeeNo" th:value="${#authentication.principal.employee.employeeNo}">						
					</div>
                </div>
                <div class="card-body p-0">
                  <div class="scrollbar-overlay" style="height: 27rem;" id="notificationListContainer">
                    <!-- JS로 알림 내용 동적 삽입 예정 -->
                  </div>
                </div>
                <div class="card-footer p-0 border-top border-translucent border-0">
                  <div class="my-2 text-center fw-bold fs-10 text-body-tertiary text-opactity-85"><a class="fw-bolder" href="/notification">알림 페이지로 이동</a></div>
                </div>
              </div>
            </div>
          </li>
            <li class="nav-item dropdown"><a class="nav-link lh-1 pe-0" id="navbarDropdownUser" href="#!" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-haspopup="true" aria-expanded="false">
                <div class="d-flex align-items-center">
	                <div class="avatar avatar-l d-flex align-items-center">
	                  <img id="headerProfileImg" class="rounded-circle " src="" alt="" style="display: none;" />
	                </div>
	                <span class="text-secondary fw-bold ms-2 d-none d-md-inline" style="font-weight: 900; position: relative; top: 2px;" sec:authentication="principal.employee.employeeName">이름</span>	
                </div>
                
              </a>
              <div class="dropdown-menu dropdown-menu-end navbar-dropdown-caret py-0 dropdown-profile shadow border" aria-labelledby="navbarDropdownUser">
                <div class="card position-relative border-0">
                  <div class="card-body p-0">
                    <div class="text-center pt-4 pb-3">
                      <div class="avatar avatar-xl ">
                        <img id="dropdownProfileImg" class="rounded-circle " src="" alt="" style="display: none;" />
						
                      </div>
                      	<th:block sec:authorize="isAuthenticated()">
    				  		<h6 class="mt-2 text-body-emphasis" sec:authentication="principal.employee.employeeName"></h6>
						</th:block>
                    </div>
                  </div>
                  <div class="overflow-auto scrollbar" style="height: 3rem;">
                    <ul class="nav d-flex flex-column mb-2 pb-1">
                      <li class="nav-item"><a class="nav-link px-3 d-block" th:href="@{/mypage/list}"> <span class="me-2 text-body align-bottom" data-feather="user"></span><span>마이페이지</span></a></li>
                    </ul>
                  </div>
                  <div class="card-footer p-0 border-top border-translucent">
                    <ul class="nav d-flex flex-column my-1">
                    </ul>
                    <div class="px-3">
					  <form th:action="@{/logout}" method="post" style="display: flex;">
					    <button type="submit" class="btn btn-phoenix-secondary d-flex flex-center w-100">
					      <span class="me-2" data-feather="log-out"></span>로그아웃
					    </button>
					  </form>
					</div>
                    <div class="my-2 text-center fw-bold fs-10 text-body-quaternary"></div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
        

    		<script>
    		function fetchNotificationList() {
    		const loginEmployeeNo = document.getElementById("loginEmployeeNo").value;
    		
    	
    		//console.log(loginEmployeeNo+"!!!!!!!!!!!!!!!!!!!");
    			  fetch("/notification/data")
    			    .then(response => response.json())
    			    .then(data => {
    			    	 
    			      const container = document.getElementById("notificationListContainer");
    			      const notificationDot = document.getElementById("notificationDot");
    			      container.innerHTML = "";
    			      
    			      

    			      if (data.length === 0) {
    			        container.innerHTML = `<div class="no-notification-message text-center text-muted py-5">
    			          새로운 알림이 없습니다.
    			        </div>`;
    			        if (notificationDot) notificationDot.style.display = "none";
    			        return;
    			      }

    			      // 최신순 정렬
    			      data.sort((a, b) => new Date(b.reg_date) - new Date(a.reg_date));

    			      let hasUnread = false;

    			      data.forEach(notification => {
    			    	
    			    	  //console.log(" hasUnread:", hasUnread);
    			    	//onsole.log("알림 sender:", notification.employee_no, "로그인 사용자:", loginEmployeeNo);
    			       let message = "";

						if (notification.separator_code === 'R001') {
						  const calendarSeparator = notification.calendarAlarm_separator || "";
						
						  if (calendarSeparator.startsWith("A")) {
						    message = "📢 새로운 회사 일정이 등록되었습니다.";
						  } else if (calendarSeparator.startsWith("T")) {
						    message = "👥 새로운 팀 일정이 등록되었습니다.";
						  } else {
						    message = "📅 새로운 일정 알림이 도착했습니다.";
						  }
						} else if(notification.separator_code === 'R004'){
							message = notification.comment;
						} else {
						  switch (notification.separator_code) {
						    case 'R002':
						      message = "💬 새로운 채팅 메시지가 도착했습니다.";
						      break;
						    case 'R003':
						      message = "✉️ 새로운 메일이 도착했습니다.";
						      break;
						    default:
						      message = "🔔 새로운 알림이 도착했습니다.";
						  }
						}

    			        const time = notification.reg_date
    			          ? (() => {
    			              const date = new Date(notification.reg_date);
    			              const hours = date.getHours();
    			              const minutes = date.getMinutes().toString().padStart(2, '0');
    			              const period = hours >= 12 ? '오후' : '오전';
    			              const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    			              const datePart = `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
    			              return `${period} ${hour12}:${minutes} / ${datePart}`;
    			            })()
    			          : "시간 정보 없음";
    			            
    			            //console.log("loginEmployeeNo:", loginEmployeeNo, typeof loginEmployeeNo);
    			            //console.log("alarm.employee_no:", notification.employee_no, typeof notification.employee_no);
							
    			            //본인이 쓴 거면 종 X
    			            const isUnread = notification.read_yn === "N";
    			            const isMine = notification.employee_no.toString() === loginEmployeeNo;

    			            if (isUnread && !isMine) {
    			              hasUnread = true;
    			            }

    			        const className = isUnread
    			          ? "px-2 px-sm-3 py-3 notification-card unread border-bottom"
    			          : "px-2 px-sm-3 py-3 notification-card read border-bottom";

    			        const html = `
    			          <div class="${className}" data-alarm-id="${notification.alarm_no}">
    			            <div class="d-flex align-items-center">
    			              <div class="avatar avatar-m me-3">
    			                <img class="rounded-circle" src="/assets/img/team/40x40/avatar.webp" alt="profile">
    			              </div>
    			              <div class="flex-1">
    			                <p class="fs-9 text-body-highlight mb-2">${message}</p>
    			                <p class="fs-10 text-body-tertiary">
    			                  <i class="fas fa-clock"></i> ${time}
    			                </p>
    			              </div>
    			            </div>
    			          </div>
    			        `;
    			        container.insertAdjacentHTML("beforeend", html);
    			      });

    			      // 빨간 점 토글
    			      if (notificationDot) {
    			        notificationDot.style.display = hasUnread ? "block" : "none";
    			      }
    			    })
    			    .catch(error => {
    			      console.error("알림 불러오기 실패:", error);
    			    });
    			}

    			// DOMContentLoaded 이후 이벤트 설정

    			document.addEventListener('DOMContentLoaded', function () {
    			  // 알림 종 클릭 시 알림 목록 갱신
    			  document.getElementById("notificationBell").addEventListener("click", fetchNotificationList);

    			  // 전체 읽음 처리 버튼 클릭 시
    			  const markAllBtn = document.getElementById("markAllAsReadBtn");
    			  if (markAllBtn) {
    			    markAllBtn.addEventListener("click", function () {
    			      fetch("/notification/readall", {
    			        method: "PATCH",
    			        headers: {
    			          "Content-Type": "application/json",
    			          [document.querySelector('meta[name="_csrf_header"]').content]: 
    			            document.querySelector('meta[name="_csrf"]').content
    			        }
    			      })
    			      .then(response => {
    			        if (response.ok) {
    			          fetchNotificationList(); // 비동기로 목록만 갱신
    			        } else {
    			          alert("읽음 처리 실패!");
    			        }
    			      })
    			      .catch(error => {
    			        console.error("전체 읽음 처리 중 오류:", error);
    			      });
    			    });
    			  }

    			  // 알림 하나 클릭 시 읽음 처리
    			  const notificationListContainer = document.getElementById("notificationListContainer");
    			  if (notificationListContainer) {
    			    notificationListContainer.addEventListener("click", function (e) {
    			      const alarmItem = e.target.closest('[data-alarm-id]');
    		
    		
    			      const alarmId = alarmItem?.getAttribute('data-alarm-id');
    		
    			      if (alarmItem) {
    			        const alarmId = alarmItem.getAttribute('data-alarm-id');
    			        console.log(alarmId);
    			        if (alarmId) {
    			          fetch(`/notification/read/${alarmId}`, {
    			            method: 'PATCH',
    			            headers: {
    			              'Content-Type': 'application/json',
    			              [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
    			            }
    			          })
    			          .then(response => response.json())
    			          .then(data => {
							  console.log(data.res_msg);
							  console.log("roomNo 확인:", data.roomNo);
							
							  if (data != null && data.res_code == '200') {
							    if (data.separator_code === 'R001') {
							      const sep = data.separator;
							      if (sep?.startsWith('A')) {
							        location.href = "/calendar/all";
							      } else if (sep?.startsWith('T')) {
							        location.href = "/calendar/myteam";
							      }
							    } else if (data.separator_code === 'R002') {
						    	  console.log("📦 이동할 roomNo:", data.roomNo);
						    	  if (data.roomNo) {
						    	    location.href = `/chat/list?roomNo=${data.roomNo}`;
						    	  } else {
						    	    alert("채팅방 정보가 없습니다. 알림 처리만 했습니다.");
						    	  }
							    } else if (data.separator_code === 'R003') {
							      // R003 처리
							      
							       location.href=`/mail/detail/${data.pk}`;
							    } else if (data.separator_code === 'R004') {
							      location.href = `/approval/${data.pk}/detail`;
							    }
							  }
							})
    			        	.catch(error => console.error('읽음 처리 에러:', error));
    			        }
    			      }
    			    });
    			  }
    			  
 			  	  let headerImg = document.getElementById('headerProfileImg');
    			  let dropdownImg = document.getElementById('dropdownProfileImg');
    			  // 프로필 이미지
    			  fetch('/profile/image')
    			  	.then(response => response.json())
    			  	.then(data => {
    			  		if(data.profileImage){
    			  			// 헤더 이미지
    			  			if(headerImg){
    			  				headerImg.onload = () => headerImg.style.display = 'inline';
    			  				headerImg.onerror = () => {
    			  					headerImg.src = '/assets/img/team/40x40/avatar.webp';
    			  					headerImg.style.display = 'inline';
    			  				};
    			  				headerImg.src = data.profileImage;
    			  			}
    			  			
    			  			// 드롭다운용 이미지
    			  			if(dropdownImg){
    			  				dropdownImg.onload = () => dropdownImg.style.display = 'inline';
    			  				dropdownImg.onerror = () => {
    			  					dropdownImg.src = '/assets/img/team/72x72/avatar.webp';
    			  					dropdownImg.style.display = 'inline';
    			  				};
    			  				dropdownImg.src = data.profileImage;
    			  			}
    			  		}else{
    			  			// 프로필 이미지가 없는 경우
    			  			if(headerImg){
    			  				headerImg.src = '/assets/img/team/40x40/avatar.webp';
    			  				headerImg.style.display = 'inline';
    			  			}
    			  			
    			  			if(dropdownImg){
    			  				dropdownImg.src = '/assets/img/team/72x72/avatar.webp';
			  					dropdownImg.style.display = 'inline';
    			  			}
    			  		}
    			  	})
    			  	.catch(error => console.error('프로필 이미지 로드 실패 : ',error));
    			  
    			});			
			</script>

      </nav>
	<style>
	  #navbarDropdownNotfication .notification-card.unread {
	    background-color: #E6F1FF !important;
	    font-weight: bold !important;
	    transition: background-color 0.2s ease;
	  }
	
	  #navbarDropdownNotfication .notification-card.unread:hover {
	    background-color: #d4e9ff !important;
	    cursor: pointer;
	  }
	
	  #navbarDropdownNotfication .notification-card.read {
	    background-color: #f8f9fa !important;
	    opacity: 0.7 !important;
	  }
	
	  #navbarDropdownNotfication .no-notification-message {
	    height: 100%;
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    color: #6c757d;
	    font-size: 0.9rem;
	    padding: 1rem;
	    text-align: center;
	  }
	</style>
</th:block>
</html>