<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">
<head>
  <meta charset="UTF-8">
  <title>ê³µì§€ ì‘ì„±</title>
  <script src="../../vendors/tinymce/tinymce.min.js"></script>
</head>
<body>
<main class="main" id="top" layout:fragment="content">
  <div class="col">
    <div class="card email-content">
      <div class="card-body">
        <form method="post" class="d-flex flex-column h-100"
              action="/article/update" name="notice_create_form" enctype="multipart/form-data">
          <!-- ì‘ì„±ì ì •ë³´ (íˆë“  ì²˜ë¦¬) -->
          <input type="hidden" name="employee_no"
                 th:value="${#authentication.principal.employee.employeeNo}" />
          <input type="hidden" name="article_no" th:value="${article.articleNo}" />

          <div class="row g-3 mb-2">
            <!-- ê¸´ê¸‰ ê³µì§€ ì²´í¬ -->
            <div class="form-check mb-0 fs-8">
				  <input class="form-check-input" type="checkbox" id="checkImportant"
				         th:checked="${article.articleEmergencyYn == 'Y'}" />
				  <span class="text-danger" data-feather="bell" style="height: 30px; width: 30px;"></span>
				  ê¸´ê¸‰ ê³µì§€
				</div>
            <div class="col-12">
              <input class="form-control" type="text" placeholder="ì œëª©" name="article_title" id="notice_title" 
              th:value="${article.articleTitle}"/>
            </div>
          </div>

          <!-- ë‚´ìš© -->
          <div class="mb-3 flex-1">
            <textarea class="tinymce email-textarea" name="article_content" id="notice_content"
                      data-tinymce='{"height":"100%"}'
                      th:text="${article.articleContent}">
            </textarea>
                      
          </div>

          <!-- íŒŒì¼ -->
          <!-- <div class="d-flex justify-content-between align-items-center">
          íŒŒì¼ ì„ íƒ
            <div class="d-flex">
              <label class="btn btn-link py-0 px-2 text-body fs-9" for="noticeAttachment">
                <span class="fa-solid fa-paperclip"></span>
              </label>
              <input class="d-none" id="noticeAttachment" name="article_files" type="file" multiple/>
              <div id="filePreview" class="mt-2"></div>
            </div> 
            <div class="d-flex flex-column mb-3" id="filePreview">
			  ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ëª©ë¡ í‘œì‹œ
			  <div>ê¸°ì¡´ íŒŒì¼(ë”°ë¡œ ë‘ëŠ”ê±¸ë¡œ ì¼ë‹¨ ì‘ì—…ì¤‘)
				  <ul class="list-unstyled">
				    <th:block th:each="file : ${attachList}">
				      <li>
				        <span class="badge bg-light text-dark">
				          <a th:href="@{${file.drivePath}}" target="_blank" th:text="${file.driveOriName}"></a>
				          <button type="button" class="btn btn-sm btn-outline-danger ms-2 py-0 px-1"
				                  th:onclick="'removeFile(' + ${file.driveAttachNo} + ')'" aria-label="ì‚­ì œ">
				            âœ•
				          </button>
				          <input type="hidden" id="attach_no" th:value="${file.driveAttachNo}">
				        </span>
				      </li>
				    </th:block>
				  </ul>
			  </div>
			  <div class="mb-3">
				  <label class="form-label">ğŸ“ ê¸°ì¡´ ì²¨ë¶€íŒŒì¼</label>
				  <ul class="list-unstyled" id="existingFileList">
				    <th:block th:each="file : ${attachList}">
				      <li class="mb-1">
				        <span class="badge bg-light text-dark d-flex align-items-center justify-content-between px-2 py-1"
				              style="font-size: 0.85rem; min-width: 180px;">
				          <a th:href="@{${file.drivePath}}" target="_blank" th:text="${file.driveOriName}" class="me-2 text-decoration-none text-dark"></a>
				          <button type="button" class="btn btn-sm btn-outline-danger ms-2 py-0 px-1"
				                  th:onclick="'removeFile(' + ${file.driveAttachNo} + ')'" aria-label="ì‚­ì œ"
				                  style="font-size: 0.7rem;">âœ•</button>
				        </span>
				      </li>
				    </th:block>
				  </ul>
				</div>
			</div>
			            
            <div class="d-flex">
              <button class="btn btn-primary fs-10" type="button" id="submitBtn">
                ìˆ˜ì •<span class="fa-solid fa-paper-plane ms-1"></span>
              </button>
            </div>
          </div> --><!-- íŒŒì¼ -->
          
          <div class="d-flex justify-content-between align-items-center">
          <div id="filePreview" class="mt-2">
    <!-- íŒŒì¼ ì„ íƒ -->
	    <div class="d-flex">
	        <label class="btn btn-link py-0 px-2 text-body fs-9" for="noticeAttachment">
	            <span class="fa-solid fa-paperclip"></span>
	        </label>
	        <input class="d-none" id="noticeAttachment" name="article_files" type="file" multiple />
	        <div id="filePreview" class="mt-2" th:if="${attachList == null or attachList.isEmpty()}">
	            <!-- íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°, ì•„ë¬´ê²ƒë„ í‘œì‹œë˜ì§€ ì•ŠìŒ -->
	            <ul id="newFileList" class="list-unstyled" style="margin-top: 0;"></ul>
	        </div>
	        <div id="filePreview" class="mt-2" th:if="${attachList != null and !attachList.isEmpty()}">
	            <!-- ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
	            <ul class="list-unstyled" style="margin-bottom: 0;">
	  <th:block th:each="file : ${attachList}">
	    <li class="mb-1">
	      <span class="badge bg-light text-dark d-flex align-items-center justify-content-between px-2 py-1"
	            style="font-size: 0.85rem; min-width: 180px; ">
	        <span>
	          <a th:href="@{${file.drivePath}}" target="_blank"
	             th:text="${file.driveOriName}" 
	             class="me-2 text-decoration-none text-dark"></a>
	          <small th:text="|(${#numbers.formatDecimal(file.driveSize / 1024, 1, 1)} KB)|"></small>
	        </span>
	        <button type="button" class="btn btn-sm btn-outline-danger ms-2 py-0 px-1"
	                th:onclick="'removeFile(' + ${file.driveAttachNo} + ', this)'" aria-label="ì‚­ì œ"
	                style="font-size: 0.7rem;">âœ•</button>
	      </span>
	    </li>
	  </th:block>
	</ul>
    <ul id="newFileList" class="list-unstyled" style="margin-top: 0;"></ul>
	        </div>
	    </div>
</div>
    <!-- ë²„íŠ¼ë“¤ -->
    <div class="d-flex">

        <button class="btn btn-primary fs-10" type="button" id="submitBtn">
            ìˆ˜ì •<span class="fa-solid fa-paper-plane ms-1"></span>
        </button>
    </div>
</div>
        </form>
      </div>
    </div>
  </div>

  <script>
  document.getElementById("submitBtn").addEventListener("click", function () {
	  const form = document.notice_create_form;
	  const title = form.article_title.value.trim();  // ì œëª©
	  const content = tinymce.get('notice_content').getContent().trim();  // ë‚´ìš© (TinyMCEì—ì„œ ê°€ì ¸ì˜´)

	  // ì œëª©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
	  if (!title) {
	    alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	    return;
	  }

	  // ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
	  if (!content || content === "<p>&nbsp;</p>" || content === "") {
	    alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	    return;
	  }
	  let existingInput = document.querySelector('input[name="notice_emergency_yn"]');
	  if (existingInput) {
	    existingInput.remove(); // ì¤‘ë³µ ë°©ì§€
	  }
	  const emergencyInput = document.createElement('input');
	  emergencyInput.type = 'hidden';
	  emergencyInput.name = 'article_emergency_yn';
	  emergencyInput.value = document.getElementById('checkImportant').checked ? 'Y' : 'N';
	  form.appendChild(emergencyInput);
	  // ê³µì§€ ë“±ë¡ì„ í™•ì¸í•˜ëŠ” ë©”ì‹œì§€
	  if (confirm("ê³µì§€ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
	    tinymce.triggerSave(); // TinyMCE ì—ë””í„°ì˜ ë‚´ìš©ì„ í¼ ë°ì´í„°ì— ì €ì¥
		
	    const payload = new FormData(form);

	    selectedFiles.forEach(file => {
	    	payload.append("article_files", file);
	    });

	    fetch("/article/update", {
	      method: "POST",
	      headers: {
	        'header': document.querySelector('meta[name="_csrf_header"]').content,
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
	      },
	      body: payload
	    })
	    .then(response => response.json())
	    .then(data => {
	      alert(data.res_msg);
	      if (data.res_code == 200) {
	        location.href = '/article/notice';
	      }
	    });
	  }
	});

    const selectedFiles = [];

    document.getElementById('noticeAttachment').addEventListener('change', function(event) {
      const fileList = Array.from(event.target.files);
      const previewContainer = document.getElementById('filePreview');

      fileList.forEach(file => {
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (!exists) selectedFiles.push(file);
      });

      renderFilePreview();
      event.target.value = "";
    });

    function renderFilePreview() {
    	  const newFileList = document.getElementById('newFileList');
    	  if (!newFileList) return;

    	  newFileList.innerHTML = ''; // ìƒˆ íŒŒì¼ ëª©ë¡ë§Œ ì´ˆê¸°í™”

    	  if (selectedFiles.length === 0) return;

    	  selectedFiles.forEach((file, index) => {
    	    const li = document.createElement('li');
    	    li.className = 'mb-1';

    	    const fileNameHtml = file.downloadUrl
    	      ? `<a href="${file.downloadUrl}" target="_blank">${file.name}</a>`
    	      : file.name;

    	    li.innerHTML = `
    	      <span class="badge bg-light text-dark d-flex align-items-center justify-content-between px-2 py-1"
    	            style="font-size: 0.85rem; min-width: 180px;">
    	        ${fileNameHtml} <small>(${(file.size / 1024).toFixed(1)} KB)</small>
    	        
    	                <button type="button" class="btn btn-sm btn-outline-danger ms-2 py-0 px-1"
    	                    style="font-size: 0.7rem;" onclick="removeSelectedFile(${index})">âœ•</button>
    	      </span>
    	    `;
    	    newFileList.appendChild(li);
    	  });
    	}

    function removeSelectedFile(index) {
      selectedFiles.splice(index, 1);
      renderFilePreview();
    }
    
    function removeFile(attachNo,btn) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâ€»ê¸°ì¡´ì— ìˆë˜ íŒŒì¼ì…ë‹ˆë‹¤.\n")) return;
        console.log('ì‚­ì œí•  íŒŒì¼ì˜ attachNo:', attachNo);
        fetch('/article/file/delete/' + attachNo, {
          method: 'POST',
          headers: {
            'header': document.querySelector('meta[name="_csrf_header"]').content,
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
          }
        
        })
        .then(res => res.json())
        .then(data => {
          alert(data.res_msg);
          if (data.res_code == 200) {
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” í•´ë‹¹ íŒŒì¼ DOMì—ì„œ ì œê±°
            // location.reload(); // ë˜ëŠ” ì§ì ‘ í•´ë‹¹ li ì œê±° ì²˜ë¦¬
            
            // 12 : 51 ì¶”ê°€í•œ í•œì¤„
        	//  fileElement.remove();
        	  const li = btn.closest('li');
              if (li) li.remove();
           
          }
        })
        .catch(err => {
          console.error(err);
          alert("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
      }
  </script>
</main>
</body>
</html>
