<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{include/layout}">
<th:block layout:fragment="content">
	<style>
/* ì‚­ì œ ë²„íŠ¼ css */
.item-wrapper {
	position: relative;
}

.item-wrapper input.form-control {
	padding-right: 2rem;
}

.item-wrapper .btn-close {
	position: absolute;
	top: 50%;
	right: 0.2rem;
	transform: translateY(-50%);
}
</style>
	<link href="vendors/choices/choices.min.css" rel="stylesheet" />
	<script src="vendors/choices/choices.min.js"></script>
	<main class="main" id="top">
		<div class="pb-8">
			<h2 class="mb-4">ì„¤ë¬¸</h2>
			<div id="reports" data-list='{"valueNames":["title","text","priority","reportsby","reports","date"],"page":9,"pagination":true}'>
				<div class="row g-3 justify-content-between mb-2">
					<div class="col-12">
						<div class="d-md-flex justify-content-between">
							<div class="mb-3">
								<!-- ì„¤ë¬¸ ìƒì„± íŒì—…ì°½ -->
								<form th:action="@{/survey/create}" method="post" id="create-survey-form">
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
									<div class="modal fade" id="create-survey" tabindex="-1" aria-labelledby="scrollingLongModalLabel2" aria-hidden="true">
										<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title" id="scrollingLongModalLabel2">ì„¤ë¬¸ ë“±ë¡</h5>
													<button class="btn btn-close p-1" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<!-- ì„¤ë¬¸ ë“±ë¡ ëª¨ë‹¬ ë³¸ë¬¸ -->
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="surveyTitle">ì œëª©</label>
														<div class="col-sm-8">
															<input class="form-control" id="surveyTitle" name="surveyTitle" type="text" style="width: 97.2%;">
														</div>
													</div>
													<!-- í•­ëª© div -->
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="inputItem">í•­ëª©</label>
														<div class="col-sm-8">
															<div id="itemScrollBox" style="max-height: 400px; overflow-y: auto;">
																<div id="itemContainerDefault">
																	<input class="form-control mb-2" id="inputItem" name="items" type="text" style="width: 97.2%;"> <input class="form-control mb-2" name="items" type="text" style="width: 97.2%;">
																</div>
																<div id="itemContainer"></div>
															</div>
															<!-- í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
															<div class="text-center mt-2">
																<button class="btn btn-phoenix-primary" type="button" id="addItemBtn">+ í•­ëª© ì¶”ê°€</button>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="basic-form-dob">ì˜µì…˜</label>
														<div class="col-sm-8">
															<div class="form-check">
																<input class="form-check-input" id="gridCheck1" name="allowMultiple" type="checkbox"> <label class="form-check-label" for="gridCheck1">ë³µìˆ˜ì„ íƒ</label>
															</div>
															<div class="form-check">
																<input class="form-check-input" id="gridCheck2" name="anonymousVote" type="checkbox"> <label class="form-check-label" for="gridCheck2">ìµëª…íˆ¬í‘œ</label>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="basic-form-dob">ì°¸ì—¬ì</label>
														<div class="col-8">
															<!-- ì°¸ì—¬ì ì „ì²´ì„ íƒ -->
															<div class="col-12 mb-2">
																<div class="form-check">
																	<input class="form-check-input" type="checkbox" id="check-all-teams" onclick="toggleAllTeams(this)"> <label class="form-check-label" for="check-all-teams">ì „ì²´ ì„ íƒ</label>
																</div>
															</div>
															<!-- ì°¸ì—¬ì ì„ íƒ -->
															<div class="row mb-3">
																<div class="col-sm-10">
																	<div class="row">
																		<div class="col-6 col-md-6 mb-2" th:each="team : ${structureList}">
																			<div class="form-check">
																				<input class="form-check-input" type="checkbox" th:id="'team-' + ${team.structure_no}" th:name="selectedTeamIds" th:value="${team.structure_no}"> <label class="form-check-label" th:for="'team-' + ${team.structure_no}" th:text="${team.code_name}"></label>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="basic-form-dob">ë§ˆê°ì¼</label>
														<div class="col-sm-8">
															<input class="form-control" id="basic-form-dob" name="deadline" type="datetime-local" style="width: 97.2%;">
														</div>
													</div>
												</div>
												<div class="modal-footer">
													<button class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">ì·¨ì†Œ</button>
													<button class="btn btn-primary" type="submit">ë“±ë¡</button>
												</div>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
				<div class="row g-3 list" id="reportsList">
					<!-- ì„¤ë¬¸ ëª©ë¡ -->

					<!-- ë“±ë¡ëœ ì„¤ë¬¸ ì—†ì„ë•Œ -->
					<th:block th:if="${#lists.isEmpty(surveyList)}">
						<div class="col-12">
							<div class="alert alert-light text-center border border-secondary-light rounded py-4 fs-6 fw-semibold text-body-secondary">
								<i class="fa-solid fa-circle-info me-2 text-secondary"></i>ë“±ë¡ëœ ì„¤ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
							</div>
						</div>
					</th:block>

					<!-- ë“±ë¡ëœ ì„¤ë¬¸ ìˆì§€ë§Œ ë§ˆê°ëœ ì„¤ë¬¸ ì—†ì„ë•Œ -->
					<th:block th:if="${!#lists.isEmpty(surveyList)}">
						<th:block th:if="${surveyList.?[deadline < T(java.time.LocalDateTime).now()].isEmpty()}">
							<div class="col-12">
								<div class="alert alert-light text-center border border-secondary-light rounded py-4 fs-6 fw-semibold text-body-secondary">
									<i class="fa-solid fa-circle-info me-2 text-secondary"></i>ë§ˆê°ëœ ì„¤ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
								</div>
							</div>
						</th:block>
					</th:block>

					<!-- ë§ˆê°ëœ ì„¤ë¬¸ -->
					<th:block th:each="survey : ${surveyList}" th:if="${survey.deadline < T(java.time.LocalDateTime).now()}">
						<div class="col-12 col-xl-4">
							<div class="card h-100">
								<div class="card-body position-relative">
									<div class="border-bottom border-translucent">
										<div class="d-flex align-items-center justify-content-between mb-1">
											<!-- ì œëª© -->
											<div class="ps-2">
												<button class="btn btn-link me-1 mb-1 fs-6 p-0" th:attr="data-survey-id=${survey.surveyNo}, data-bs-target='#survey-detail-' + ${survey.surveyNo}" data-bs-toggle="modal" th:text="${survey.surveyTitle}" style="max-width: 100%; height: 2rem; overflow: hidden">ì„¤ë¬¸ ì œëª©</button>
											</div>
											<!-- ì‚­ì œ ë²„íŠ¼ -->
											<div>
												<button type="button" class="btn-close position-absolute top-0 end-0 mt-3 me-3" th:if="${survey.writer == #authentication.principal.employee.employeeName and (survey.voterCount == 0 or survey.deadline < T(java.time.LocalDateTime).now())}" th:onclick="'deleteSurvey(' + ${survey.surveyNo} + ')'"></button>
											</div>
										</div>
										<div class="d-flex align-items-center justify-content-between mb-3 ps-2 pe-2">
											<p class="fs-9 fw-semibold text-body mb-0">
												ì‘ì„±ì : <span th:text="${survey.writer}">ì‘ì„±ìëª…</span>
											</p>
											<!-- ìƒíƒœ í‘œì‹œ -->
											<div th:if="${survey.deadline >= T(java.time.LocalDateTime).now()}" class="d-flex align-items-center">
												<span class="fa-solid fa-circle me-1 text-success" data-fa-transform="shrink-6 up-1"></span> <span class="fw-bold fs-9 text-body lh-2">ì§„í–‰ì¤‘</span>
											</div>
											<div th:if="${survey.deadline < T(java.time.LocalDateTime).now()}" class="d-flex align-items-center">
												<span class="fa-solid fa-circle me-1 text-danger" data-fa-transform="shrink-6 up-1"></span> <span class="fw-bold fs-9 text-body lh-2">ë§ˆê°</span>
											</div>
										</div>
									</div>
									<div class="row g-1 g-sm-3 mt-2 lh-1 justify-content-between align-items-center">
										<div class="col-auto">
											<div class="d-flex align-items-center">
												<span class="me-2" data-feather="users" style="stroke-width: 2;"></span>
												<p class="mb-0 fs-9 fw-semibold text-body-tertiary reports" th:attr="id='voter-count-' + ${survey.surveyNo}" th:text="'ì‘ë‹µì ìˆ˜ : ' + ${survey.voterCount} + ' ëª…'">ì‘ë‹µì ìˆ˜</p>
											</div>
										</div>
										<div class="col-auto ms-auto">
											<div class="d-flex align-items-center">
												<span class="me-2" data-feather="clock" style="stroke-width: 2;"></span>
												<p class="mb-0 fs-9 fw-semibold text-body-tertiary date" th:text="'ë§ˆê°ì¼ì‹œ : ' + ${#temporals.format(survey.deadline, 'yyyy.MM.dd HH:mm')}">ë§ˆê°ì¼</p>
											</div>
										</div>
									</div>

									<!-- ê°œë³„ ëª¨ë‹¬ -->
									<div class="modal fade" th:attr="id='survey-detail-' + ${survey.surveyNo}, data-allow-multiple=${survey.allowMultiple}, data-anonymous=${survey.anonymousVote}" tabindex="-1" aria-labelledby="scrollingLongModalLabel2" aria-hidden="true">
										<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title" id="scrollingLongModalLabel2" th:text="${survey.surveyTitle}">Modal title</h5>
													<div class="ms-2">
														<span class="badge bg-secondary text-white me-1" th:if="${survey.allowMultiple}">ë³µìˆ˜</span> <span class="badge bg-secondary text-white" th:if="${survey.anonymousVote}">ìµëª…</span>
													</div>
													<button class="btn btn-close p-1" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
													<div class="vote-loading-area position-relative" style="min-height: 100px;">
														<div class="vote-loading-spinner d-flex justify-content-center align-items-center position-absolute top-0 start-0 w-100 h-100">
															<div class="d-flex justify-content-center align-items-center">
																<div class="spinner-grow" role="status">
																	<span class="visually-hidden">Loading...</span>
																</div>
															</div>
														</div>
														<!-- ì„¤ë¬¸ í•­ëª© -->
														<ul th:attr="id='surveyItemList-' + ${survey.surveyNo}" class="list-group d-none m-0"></ul>
													</div>
												</div>
												<th:block th:if="${survey.deadline >= T(java.time.LocalDateTime).now()}">
													<div class="modal-footer">
														<button class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">ì·¨ì†Œ</button>
														<button class="btn btn-primary" type="button" th:onclick="'submitVote(' + ${survey.surveyNo} + ')'">íˆ¬í‘œ</button>
													</div>
												</th:block>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</th:block>
				</div>
				<div class="row align-items-center justify-content-between py-2 pe-0 fs-9 mt-2">
					<div class="col-4 d-flex">
						<button class="btn btn-subtle-primary me-1 mb-1" type="button" data-bs-toggle="modal" data-bs-target="#create-survey">
							<span class="fas fa-plus me-2"></span>ì„¤ë¬¸ ë“±ë¡
						</button>
					</div>
					<div class="col-4 d-flex justify-content-center">
						<button class="page-link" data-list-pagination="prev">
							<span class="fas fa-chevron-left"></span>
						</button>
						<ul class="mb-0 pagination"></ul>
						<button class="page-link pe-0" data-list-pagination="next">
							<span class="fas fa-chevron-right"></span>
						</button>
					</div>
					<div class="col-4 d-flex justify-content-end">
						<a class="fw-semibold" href="#!" data-list-view="*">ë”ë³´ê¸°</a> <a class="fw-semibold d-none" href="#!" data-list-view="less">ì ‘ê¸°</a>
					</div>
				</div>
			</div>
		</div>
	</main>
	<script>
	
	// ê³µí†µ fetch í•¨ìˆ˜
	function fetchSurveyDetail(surveyId, callback) {
	  fetch('/survey/detail?id=' + surveyId)
	    .then(res => res.json())
	    .then(items => {
	      if (typeof callback === 'function') {
	        callback(items);
	      }
	    });
	}

	
	
	
	
	
	
	// ì„¤ë¬¸ ë“±ë¡ì‹œ í•­ëª© ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸
	document.addEventListener("DOMContentLoaded", function () {
	  const addItemButton = document.getElementById('addItemBtn');
	  const itemContainer = document.getElementById('itemContainer');
	
	  // +í•­ëª© ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ í•­ëª© inputì„ ì¶”ê°€
	  addItemButton.addEventListener('click', addSurveyItem);
	
	  // í•­ëª© input + ì‚­ì œ ë²„íŠ¼ì„ ìƒì„±í•˜ê³  ì¶”ê°€
	  function addSurveyItem() {
	    const wrapper = document.createElement('div');
	    wrapper.className = 'd-flex align-items-center mb-2 item-wrapper';
	
	    // í…ìŠ¤íŠ¸ ì…ë ¥ input ìƒì„±
	    const input = document.createElement('input');
	    input.type = 'text';
	    input.name = 'items';
	    input.className = 'form-control me-2';
	
	    // ì‚­ì œ ë²„íŠ¼ ìƒì„±
	    const removeBtn = document.createElement('button');
	    removeBtn.type = 'button';
	    removeBtn.className = 'btn btn-close btn-sm';
	    removeBtn.addEventListener('click', () => wrapper.remove());
	
	    // ìš”ì†Œ ì¡°ë¦½ ë° ì¶”ê°€
	    wrapper.appendChild(input);
	    wrapper.appendChild(removeBtn);
	    itemContainer.appendChild(wrapper);
	
	    // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™
	    itemContainer.parentElement.scrollTop = itemContainer.parentElement.scrollHeight;
	  }
	});
	
	
	
	
	
	
	
	// ì°¸ì—¬ì ì „ì²´ ì„ íƒ
	function toggleAllTeams(checkbox) {
	  const teamCheckboxes = document.querySelectorAll('input[name="selectedTeamIds"]');
	  teamCheckboxes.forEach(cb => cb.checked = checkbox.checked);
	}
	
	
	
	
	
	
	
	// ì„¤ë¬¸ ë“±ë¡ ìœ íš¨ì„± ê²€ì‚¬
	let focusTarget = null; // í¬ì»¤ìŠ¤ë¥¼ ìœ„í•œ ë³€ìˆ˜
	
	document.addEventListener("DOMContentLoaded", function () {
	  const form = document.getElementById('create-survey-form');

	  form.addEventListener('submit', function (e) {
	    e.preventDefault();
	    
	    const titleInput = form.querySelector('input[name="surveyTitle"]');
	    const title = titleInput.value.trim();
	    const itemInputs = form.querySelectorAll('input[name="items"]');
	    const deadlineInput = form.querySelector('input[name="deadline"]');
	    const deadlineValue = deadlineInput.value;
	    const deadlineDate = new Date(deadlineValue);
	    const now = new Date();

	    // 1. ì œëª© ì…ë ¥ ì—¬ë¶€ í™•ì¸
	    if (!title) {
	      focusTarget = titleInput;
	      showValidationAlert("ì œëª© í™•ì¸", "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	      return;
	    }

	    // 2. í•­ëª© ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬ (ê¸°ë³¸ + ì¶”ê°€ í•­ëª© í¬í•¨)
		let validItemCount = 0;
		let hasEmptyItem = false;
		let firstEmptyInput = null;
		
		itemInputs.forEach(function (input) {
		  const value = input.value.trim();
		  if (value === '') {
		    hasEmptyItem = true;
		    if (!firstEmptyInput) {
		      firstEmptyInput = input;
		    }
		  } else {
		    validItemCount++;
		  }
		});

		// í•­ëª©ì´ 2ê°œ ì´ìƒì´ë©´ì„œ ëª¨ë‘ ê°’ì´ ì±„ì›Œì ¸ ìˆì–´ì•¼ í†µê³¼
		if (validItemCount < 2 || hasEmptyItem) {
		  focusTarget = firstEmptyInput || itemInputs[0];
		  showValidationAlert("í•­ëª© í™•ì¸", "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		  return;
		}

	    // 3. ì°¸ì—¬ íŒ€ì´ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
	    const teamCheckboxes = form.querySelectorAll('input[name="selectedTeamIds"]:checked');
	    if (teamCheckboxes.length === 0) {
	      showValidationAlert("íˆ¬í‘œì í™•ì¸", "íˆ¬í‘œ ì°¸ì—¬ íŒ€ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
	      return;
	    }
	    
	    // 4. ë§ˆê°ì¼ì´ í˜„ì¬ ì‹œê°„ ì´í›„ì¸ì§€ í™•ì¸
	    if (!deadlineValue || deadlineDate <= now) {
		  focusTarget = deadlineInput;
	      showValidationAlert("ë§ˆê°ì¼ í™•ì¸", "ì˜¬ë°”ë¥¸ ë§ˆê°ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
	      return;
	    }

	    // ëª¨ë“  ì¡°ê±´ í†µê³¼ â†’ ì‹¤ì œ í¼ ì œì¶œ
	    form.submit();
	  });
	});

	
	
	
	
	
	
	// ìœ íš¨ì„± ê²½ê³  ëª¨ë‹¬
	function showValidationAlert(title, message) {
	  const titleEl = document.getElementById('validationModalTitle');
	  const messageEl = document.getElementById('validationModalMessage');
	  const modalEl = document.getElementById('validationModal');
	  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

	  titleEl.textContent = title;
	  messageEl.innerHTML = message;
	  modal.show();
	  
	  modalEl.addEventListener('hidden.bs.modal', function onClose() {
	    modalEl.removeEventListener('hidden.bs.modal', onClose);
	    if (focusTarget) {
	      focusTarget.focus();
	      focusTarget = null; 
	    }
	  });
	}
	
	
	
	
	
	

	// ì„¤ë¬¸ ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬ ì´ˆê¸°í™”
	document.addEventListener('DOMContentLoaded', () => {
	  const form = document.getElementById('create-survey-form');
	  const modalEl = document.getElementById('create-survey');
	  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

	  const confirmModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmCloseModal'));
	  const confirmBtn = document.getElementById('confirmCloseBtn');

	  let allowClose = false;

	  // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì´ ìˆì„ ê²½ìš° ë‹«ê¸° ì „ì— í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
	  modalEl.addEventListener('hide.bs.modal', (event) => {
	    if (allowClose) {
	      allowClose = false;
	      return;
	    }

	    const title = form.querySelector('input[name="surveyTitle"]').value.trim();
	    const deadline = form.querySelector('input[name="deadline"]').value.trim();
	    const hasItems = Array.from(form.querySelectorAll('input[name="items"]')).some(input => input.value.trim() !== '');
	    const hasTeams = document.querySelectorAll('#selectedTeam .badge').length > 0;

	    const hasInput = title || deadline || hasItems || hasTeams;

	    if (hasInput) {
	      event.preventDefault();
	      confirmModal.show();
	    }
	  });

	  // í™•ì¸ ëª¨ë‹¬ì—ì„œ 'í™•ì¸' í´ë¦­ ì‹œ ì‹¤ì œ ëª¨ë‹¬ ë‹«ê¸°
	  confirmBtn.addEventListener('click', () => {
	    confirmModal.hide();
	    allowClose = true;
	    modal.hide();
	  });

	  // ëª¨ë‹¬ ì™„ì „íˆ ë‹«íŒ í›„ ì…ë ¥ê°’ ì´ˆê¸°í™”
	  modalEl.addEventListener('hidden.bs.modal', () => {
	    allowClose = false;
	    form.reset();
	    itemContainer.innerHTML = '';
	    selectedTeam.innerHTML = '';
	    selectedTeam.classList.remove('border', 'border-danger', 'rounded', 'p-2');
	  });
	});
	
	
	
	
	
	

	// ì„¤ë¬¸ ì œëª© í´ë¦­ ì‹œ ìƒì„¸ í•­ëª© ì¡°íšŒ ë° í‘œì‹œ
	document.addEventListener('DOMContentLoaded', function () {
	  const reportsList = document.getElementById('reportsList');

	  reportsList.addEventListener('click', function (event) {
	    const button = event.target.closest('button[data-survey-id]');
	    if (!button) return;

	    const surveyId = button.getAttribute('data-survey-id');
	    const itemList = document.getElementById('surveyItemList-' + surveyId);
	    if (!itemList) return;

	    itemList.innerHTML = '';

	    fetchSurveyDetail(surveyId, function (items) {
	      if (items.length === 0) {
	        itemList.innerHTML = '<li class="list-group-item">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
	        return;
	      }

	      items.forEach((item, index) => {
	        const wrapper = document.createElement('div');
	        wrapper.className = 'vote-option d-flex justify-content-between align-items-center rounded p-2 mb-2 bg-light text-dark border';
	        wrapper.setAttribute('onclick', `handleVoteClick(${surveyId}, ${index})`);
	        wrapper.setAttribute('data-index', index);
	        wrapper.setAttribute('data-item-no', item.itemNo);

	        const label = document.createElement('span');
	        label.className = 'fw-semibold';
	        label.textContent = item.item;

	        const countSpan = document.createElement('span');
	        countSpan.id = `vote-count-${surveyId}-${index}`;
	        countSpan.textContent = item.count + 'í‘œ';

	        wrapper.appendChild(label);
	        wrapper.appendChild(countSpan);
	        itemList.appendChild(wrapper);
	      });
	    });
	  });
	});

	
	
	
	
	
	
	// ì„¤ë¬¸ í•­ëª© ë° íˆ¬í‘œ ê²°ê³¼ ë Œë”ë§
	function renderVoteView(surveyId, items) {
	  const itemList = document.getElementById('surveyItemList-' + surveyId);
	  if (!itemList) return;

	  // ê¸°ì¡´ í•­ëª© ì œê±°
	  itemList.innerHTML = '';

	  const modal = document.getElementById('survey-detail-' + surveyId);
	  const allowMultiple = modal.getAttribute('data-allow-multiple') === 'on';
	  const allowAnonymous = modal.getAttribute('data-anonymous') === 'on';

	  // ì‚¬ìš©ìê°€ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸
	  let hasVoted = false;
	  for (let i = 0; i < items.length; i++) {
	    if (items[i].voted === "Y") {
	      hasVoted = true;
	      break;
	    }
	  }

	  // ìµœë‹¤ ë“í‘œ ìˆ˜ ê³„ì‚°
	  let maxVotes = 0;
	  for (let i = 0; i < items.length; i++) {
	    if (items[i].count > maxVotes) {
	      maxVotes = items[i].count;
	    }
	  }

	  // í•­ëª© ìƒì„± ë° ë Œë”ë§
	  for (let i = 0; i < items.length; i++) {
	    const item = items[i];

	    const wrapper = document.createElement('div');
	    wrapper.className = 'vote-option d-flex justify-content-between align-items-center rounded p-2 mb-2 bg-light text-dark border';
	    wrapper.setAttribute('data-index', i);
	    wrapper.setAttribute('data-item-no', item.itemNo);

	    const label = document.createElement('span');
	    label.className = 'fw-semibold';
	    label.textContent = item.item;

	    // ë§ˆê°ëœ ì„¤ë¬¸ì¼ ë•Œ ìµœë‹¤ ë“í‘œ í•­ëª© ê°•ì¡°
	    const isClosed = modal.querySelector('.btn-primary') === null;
	    if (isClosed && item.count === maxVotes && maxVotes > 0) {
	      label.textContent += ' ğŸ†';
	      wrapper.classList.add('bg-warning-subtle', 'border-warning');
	    }

	    const voteCount = document.createElement('span');
	    voteCount.textContent = item.count + 'í‘œ';

	    if (hasVoted) {
	      // ì´ë¯¸ íˆ¬í‘œí–ˆì„ ê²½ìš° ê²°ê³¼ í‘œì‹œ
	      if (item.voted === "Y") {
	        wrapper.classList.add('bg-info-subtle', 'border-primary', 'border-2');
	      }

	      // íˆ´íŒ: ìµëª… ì—¬ë¶€ì— ë”°ë¼ í‘œì‹œ
	      const voterList = allowAnonymous ? 'ìµëª… íˆ¬í‘œ' : item.voters?.join('<br>') || '';
	      voteCount.setAttribute('title', voterList);
	      voteCount.setAttribute('data-bs-toggle', 'tooltip');
	      voteCount.setAttribute('data-bs-placement', 'right');
	      voteCount.setAttribute('data-bs-html', 'true');
	    } else {
	      // íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì„ ê²½ìš° í•­ëª© í´ë¦­ ê°€ëŠ¥
	      wrapper.setAttribute('onclick', `handleVoteClick(${surveyId}, ${i})`);
	    }

	    wrapper.appendChild(label);
	    wrapper.appendChild(voteCount);
	    itemList.appendChild(wrapper);
	  }

	  // íˆ¬í‘œ ë²„íŠ¼ ìš”ì†Œ
	  const voteBtn = document.querySelector(`#survey-detail-${surveyId} .modal-footer .btn-primary`);

	  // ë²„íŠ¼ì´ ì¡´ì¬í•  ê²½ìš° í…ìŠ¤íŠ¸ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
	  if (voteBtn) {
	    if (hasVoted) {
	      // ì´ë¯¸ íˆ¬í‘œí•œ ê²½ìš°
	      voteBtn.textContent = 'ë‹¤ì‹œ íˆ¬í‘œ';
	      voteBtn.onclick = function () {
	        enableRevote(surveyId);
	      };
	    } else {
	      // ì•„ì§ íˆ¬í‘œí•˜ì§€ ì•Šì€ ê²½ìš°
	      voteBtn.textContent = 'íˆ¬í‘œ';
	      voteBtn.onclick = function () {
	        submitVote(surveyId);
	      };
	    }
	  }


	  // íˆ´íŒ ì´ˆê¸°í™”
	  const tooltipElements = itemList.querySelectorAll('[data-bs-toggle="tooltip"]');
	  tooltipElements.forEach(el => {
	    const existing = bootstrap.Tooltip.getInstance(el);
	    if (existing) existing.dispose();
	    new bootstrap.Tooltip(el);
	  });

	  // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê³  í•­ëª© í‘œì‹œ
	  itemList.classList.remove('d-none');
	  const spinner = itemList.previousElementSibling;
	  if (spinner) spinner.classList.add('d-none');
	}
	
	
	
	
	
	
	
	// íˆ¬í‘œ í•­ëª© í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
	function handleVoteClick(surveyId, itemIndex) {
	  const modal = document.getElementById('survey-detail-' + surveyId);
	  if (!modal) return;

	  // ë³µìˆ˜ ì„ íƒ í—ˆìš© ì—¬ë¶€ í™•ì¸
	  const allowMultiple = modal.getAttribute('data-allow-multiple') === 'on';

	  // ì„¤ë¬¸ì´ ë§ˆê°ëœ ê²½ìš° í´ë¦­ ë¬´ì‹œ
	  const voteBtn = modal.querySelector('.modal-footer .btn-primary');
	  if (!voteBtn) return;

	  // ëª¨ë“  í•­ëª© ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
	  const allOptions = document.querySelectorAll(`#surveyItemList-${surveyId} .vote-option`);
	  const selected = allOptions[itemIndex];
	  if (!selected) return;

	  if (allowMultiple) {
	    // ë³µìˆ˜ ì„ íƒ: í˜„ì¬ ì„ íƒ ìƒíƒœ í† ê¸€
	    const isSelected = selected.classList.contains('bg-primary');
	    if (isSelected) {
	      selected.classList.remove('bg-primary', 'border-2', 'text-white');
	      selected.classList.add('bg-light');
	    } else {
	      selected.classList.remove('bg-light');
	      selected.classList.add('bg-primary', 'border-2', 'text-white');
	    }
	  } else {
	    // ë‹¨ì¼ ì„ íƒ: ëª¨ë“  í•­ëª© ì´ˆê¸°í™” í›„ ì„ íƒ í•­ëª©ë§Œ í™œì„±í™”
	    allOptions.forEach(function (el) {
	      el.classList.remove('bg-primary', 'border-2', 'text-white');
	      el.classList.add('bg-light');
	    });

	    selected.classList.remove('bg-light');
	    selected.classList.add('bg-primary', 'border-2', 'text-white');
	  }
	}

	
	
	
	
	
	
	// íˆ¬í‘œ ì œì¶œ ìš”ì²­ í•¨ìˆ˜
	function submitVote(surveyId) {
	  const modal = document.getElementById('survey-detail-' + surveyId);
	  if (!modal) return;

	  // ë³µìˆ˜ ì„ íƒ í—ˆìš© ì—¬ë¶€ í™•ì¸
	  const allowMultiple = modal.getAttribute('data-allow-multiple') === 'on';

	  // ì„ íƒëœ í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
	  const selectedOptions = document.querySelectorAll(`#surveyItemList-${surveyId} .vote-option.bg-primary`);
	  if (selectedOptions.length === 0) {
	    alert('í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
	    return;
	  }

	  // ì„ íƒëœ í•­ëª© ë²ˆí˜¸ë§Œ ì¶”ì¶œ
	  const votedItems = Array.from(selectedOptions).map(function (el) {
	    return parseInt(el.getAttribute('data-item-no'));
	  });

	  // íˆ¬í‘œ ìš”ì²­ ì „ì†¡
	  fetch('/survey/vote', {
	    method: 'POST',
	    headers: {
	      'Content-Type': 'application/json',
	      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
	    },
	    body: JSON.stringify({
	      surveyId: surveyId,
	      votedItems: votedItems
	    })
	  })
	  .then(function (res) {
	    return res.json();
	  })
	  .then(function (result) {
	    if (result.success) {
	      // íˆ¬í‘œ ê²°ê³¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ ë Œë”ë§(ê³µí†µ fetchí•¨ìˆ˜ ì‚¬ìš©)
	      fetchSurveyDetail(surveyId, items => renderVoteView(surveyId, items));

	      // ì‘ë‹µì ìˆ˜ë¥¼ ì•½ê°„ ì§€ì—° í›„ ê°±ì‹  (ê³ ì˜ ì§€ì—°: DBì— ì €ì¥ì´ ì™„ë£Œë˜ê¸° ì „ì— ê°±ì‹ ë˜ëŠ” ê²ƒì„ ë°©ì§€)
	      setTimeout(function () {
	        updateVoterCount(surveyId);
	      }, 300);
	    } else {
	      // ê¶Œí•œ ì—†ëŠ” ê²½ìš° ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ
	      const voteAuthorityModal = bootstrap.Modal.getOrCreateInstance(
	        document.getElementById('voteAuthorityModal')
	      );
	      voteAuthorityModal.show();
	    }
	  });
	}

	
	
	
	
	
	
	// ì„¤ë¬¸ ì‘ë‹µì ìˆ˜ë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì™€ UIì— ë°˜ì˜
	function updateVoterCount(surveyId) {
	  // ë°±ì—”ë“œë¡œë¶€í„° í•´ë‹¹ ì„¤ë¬¸ì˜ ì‘ë‹µì ìˆ˜ ì¡°íšŒ
	  fetch('/survey/voter-count?id=' + surveyId)
	    .then(function (res) {
	      return res.json();
	    })
	    .then(function (data) {
	      const voterCountEl = document.getElementById('voter-count-' + surveyId);

	      // ì‘ë‹µì ìˆ˜ DOM ìš”ì†Œê°€ ì¡´ì¬í•˜ê³ , ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ì—ë§Œ ê°±ì‹ 
	      if (voterCountEl && typeof data.voterCount === 'number') {
	        voterCountEl.textContent = 'ì‘ë‹µì ìˆ˜ : ' + data.voterCount + ' ëª…';
	      } else {
	        console.warn('DOM ìš”ì†Œê°€ ì—†ê±°ë‚˜ ì˜ëª»ëœ ë°ì´í„°:', data);
	      }
	    })
	    .catch(function (error) {
	      console.error('ì‘ë‹µì ìˆ˜ ê°±ì‹  ì‹¤íŒ¨:', error);
	    });
	}

	
	
	
	
	
	
	// ë‹¤ì‹œ íˆ¬í‘œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‚¬ìš©ì íˆ¬í‘œ ì´ˆê¸°í™” í›„ í™”ë©´ ê°±ì‹ 
	function enableRevote(surveyId) {
	  const itemList = document.getElementById('surveyItemList-' + surveyId);
	  if (!itemList) return;

	  // ê¸°ì¡´ íˆ¬í‘œ í•­ëª© ë¹„ìš°ê¸°
	  itemList.innerHTML = '';

	  // ì„œë²„ì—ì„œ ì„¤ë¬¸ í•­ëª© ì¬ì¡°íšŒ í›„ 'voted' ìƒíƒœ ì´ˆê¸°í™”
	  fetchSurveyDetail(surveyId, items => {
		  items.forEach(item => item.voted = "N");
		  renderVoteView(surveyId, items);
	  });

	  // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¬ì„¤ì •
	  const voteBtn = document.querySelector(`#survey-detail-${surveyId} .modal-footer .btn-primary`);
	  if (voteBtn) {
	    voteBtn.textContent = 'íˆ¬í‘œ';
	    voteBtn.onclick = function () {
	      submitVote(surveyId);
	    };
	  }
	}

	
	
	
	
	
	
	// ì„¤ë¬¸ ìƒì„¸ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ íˆ¬í‘œ í•­ëª© ë° íˆ´íŒ í‘œì‹œ ê°±ì‹ 
	document.addEventListener('shown.bs.modal', function (event) {
	  const modal = event.target;

	  // ì„¤ë¬¸ ìƒì„¸ ëª¨ë‹¬ì´ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬ ì¤‘ë‹¨
	  if (!modal.id || !modal.id.startsWith('survey-detail-')) return;

	  const surveyId = modal.id.replace('survey-detail-', '');
	  const itemList = document.getElementById('surveyItemList-' + surveyId);
	  if (!itemList) return;

	  // í•­ëª© ì˜ì—­ ìˆ¨ê¸°ê³  ìŠ¤í”¼ë„ˆ í‘œì‹œ
	  itemList.classList.add('d-none');
	  const spinner = itemList.previousElementSibling;
	  if (spinner) spinner.classList.remove('d-none');

	  // ì„¤ë¬¸ í•­ëª© ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° í‘œì‹œ
	  fetchSurveyDetail(surveyId, items => renderVoteView(surveyId, items));
	});

	
	
	
	
	// ì„¤ë¬¸ ì‚­ì œ
	
	// ì„¤ë¬¸ ì‚­ì œìš© ë³€ìˆ˜
	let pendingDeleteSurveyId = null;

	// ì‚­ì œí•  ì„¤ë¬¸ ID ì„¤ì • ë° ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
	function deleteSurvey(surveyId) {
	    pendingDeleteSurveyId = surveyId;
	    const confirmDeleteModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmDeleteModal'));
	    confirmDeleteModal.show();
	}

	// í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì‚­ì œ í™•ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
	document.addEventListener('DOMContentLoaded', function () {
	    const confirmBtn = document.getElementById('confirmDeleteBtn');

	    confirmBtn.addEventListener('click', function () {
	        if (pendingDeleteSurveyId === null) return; // ì‚­ì œí•  ì„¤ë¬¸ IDê°€ ì—†ëŠ” ê²½ìš° ì¤‘ë‹¨

	        // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
	        const confirmDeleteModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmDeleteModal'));
	        confirmDeleteModal.hide();

	        // ì‚­ì œ ìš”ì²­
	        fetch('/survey/delete?id=' + pendingDeleteSurveyId, {
	            method: 'POST',
	            headers: {
	                'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
	            }
	        })
	        .then(res => res.json())
	        .then(result => {
	            const toastEl = document.getElementById('deleteToast');
	            const toastMessage = document.getElementById('deleteToastMessage');
	            const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 1000 }); // 1ì´ˆ í›„ ìë™ ë‹«í˜

	            if (result.success) {
	                // ì‚­ì œ ì„±ê³µ ì‹œ í† ìŠ¤íŠ¸
	                toastEl.classList.remove('bg-danger');
	                toastEl.classList.add('bg-primary');
	                toastMessage.textContent = result.message || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';

	                toast.show();

	                // í† ìŠ¤íŠ¸ ë³´ì—¬ì¤€ ë’¤ 1ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨
	                setTimeout(() => {
	                    location.reload();
	                }, 1000);
	                
	            } else {
	                // ì‚­ì œ ì‹¤íŒ¨ ì‹œ í† ìŠ¤íŠ¸
	                toastEl.classList.remove('bg-primary');
	                toastEl.classList.add('bg-danger');
	                toastMessage.textContent = result.message || 'ì‚­ì œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

	                toast.show();
	            }
	        })
	        .catch(error => {
	            console.error('ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

	            const toastEl = document.getElementById('deleteToast');
	            const toastMessage = document.getElementById('deleteToastMessage');
	            const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 2000 }); // 2ì´ˆ í›„ ìë™ ë‹«í˜

	            // ì˜¤ë¥˜ ë°œìƒ ì‹œ í† ìŠ¤íŠ¸
	            toastEl.classList.remove('bg-primary');
	            toastEl.classList.add('bg-danger');
	            toastMessage.textContent = 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

	            toast.show();
	        });
	    });
	});

	
	
	
	</script>



	<!-- ì„¤ë¬¸ ìƒì„± ë‹«ê¸° í™•ì¸ì°½ -->
	<div class="modal fade" id="confirmCloseModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-sm">
			<div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
				<div class="modal-header border-0">
					<h5 class="modal-title text-dark">ì •ë§ ë‹«ì„ê¹Œìš”?</h5>
				</div>
				<div class="modal-body text-center">
					<p class="mb-0 text-body">
						ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?
					</p>
				</div>
				<div class="modal-footer justify-content-center border-0">
					<button type="button" class="btn btn-phoenix-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
					<button type="button" class="btn btn-danger" id="confirmCloseBtn">í™•ì¸</button>
				</div>
			</div>
		</div>
	</div>



	<!-- ìœ íš¨ì„± ê²€ì‚¬ í™•ì¸ì°½ -->
	<div class="modal fade" id="validationModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-sm">
			<div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
				<div class="modal-header border-0">
					<h5 class="modal-title text-dark" id="validationModalTitle"></h5>
				</div>
				<div class="modal-body text-center">
					<p class="mb-0 text-body" id="validationModalMessage"></p>
				</div>
				<div class="modal-footer justify-content-center border-0">
					<button type="button" class="btn btn-phoenix-secondary bg-primary text-white" data-bs-dismiss="modal">í™•ì¸</button>
				</div>
			</div>
		</div>
	</div>



	<!-- íˆ¬í‘œ ê¶Œí•œ í™•ì¸ì°½ -->
	<div class="modal fade" id="voteAuthorityModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-sm">
			<div class="modal-content bg-body-secondary text-body rounded-3 shadow-lg border border-secondary-light">
				<div class="modal-header border-0">
					<h5 class="modal-title text-dark" id="voteAuthorityModalTitle"></h5>
				</div>
				<div class="modal-body text-center">
					<p class="mb-0 text-body" id="voteAuthorityModalMessage">íˆ¬í‘œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>
				</div>
				<div class="modal-footer justify-content-center border-0">
					<button type="button" class="btn btn-phoenix-secondary me-1 mb-1" data-bs-dismiss="modal">í™•ì¸</button>
				</div>
			</div>
		</div>
	</div>



	<!-- ì„¤ë¬¸ ì‚­ì œ í™•ì¸ì°½ -->
	<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-sm">
			<div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
				<div class="modal-header border-0">
					<h5 class="modal-title text-dark">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h5>
				</div>
				<div class="modal-body text-center">
					<p class="mb-0 text-body">
						ì„¤ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì‚­ì œ í›„ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.
					</p>
				</div>
				<div class="modal-footer justify-content-center border-0">
					<button type="button" class="btn btn-phoenix-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
					<button type="button" class="btn btn-danger" id="confirmDeleteBtn">ì‚­ì œ</button>
				</div>
			</div>
		</div>
	</div>



	<!-- ì‚­ì œ ê²°ê³¼ í† ìŠ¤íŠ¸ -->
	<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100">
		<div id="deleteToast" class="toast fade align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="d-flex">
				<div class="toast-body" id="deleteToastMessage">ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
			</div>
		</div>
	</div>

</th:block>
</html>