<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{include/layout}">
<head>
  <title>ì „ì²´ ì¼ì •</title>

<style>
.fc-event-main::after {
  display: none !important;
}
</style>

</head>
<body>
  <main class="main" id="top" layout:fragment="content">
    <div class="row g-0 mb-4 align-items-center">
      <div class="col-5 col-md-6">
        <h4 class="mb-0 text-body-emphasis fw-bold fs-md-6">ì „ì²´ ì¼ì •</h4>
      </div>
    </div>

		<div class="calendar-outline mt-6 mb-9" id="appCalendar"></div>
    
    <button class="btn btn-primary" type="button" data-bs-toggle="modal"
			data-bs-target="#tooltipModal" style="display: none;"
			id="modalButton"></button>

		<!-- ëª¨ë‹¬ ì°½ -->
		<div class="modal fade" id="tooltipModal" tabindex="-1"
			aria-labelledby="tooltipModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content border border-translucent">
					<div class="modal-header px-card border-0 position-relative">
						<h5 class="mb-0 lh-sm text-body-highlight" id="tooltipModalLabel">ë¶€ì„œ ì¼ì •
							ìƒì„¸ì¡°íšŒ</h5>
						<button class="btn-close position-absolute top-0 end-0 mt-2 me-2"
							type="button" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body p-card py-0">
						<input type="hidden" name="calendar_no" value="">
						<div class="mb-3">
							<strong>íŒ€:</strong> <span id="eventTeam"></span>
						</div>
						<div class="mb-3">
							<strong>ì¼ì •:</strong> <span id="eventTitle"></span>
						</div>
						<div class="mb-3">
							<strong>ì‹œì‘ ì‹œê°„:</strong> <span id="eventDate"></span>
						</div>
						<div class="mb-3">
							<strong>ì¢…ë£Œ ì‹œê°„:</strong> <span id="eventEndDate"></span>
						</div>
						<div class="mb-3">
							<strong>ì¥ì†Œ:</strong> <span id="eventLocation"></span>
						</div>
						<div class="mb-3">
							<strong>ì„¤ëª…:</strong> <span id="eventDescription"></span>
						</div>
					</div>
					<div
						class="modal-footer d-flex justify-content-between align-items-center border-0" >
						<div class="d-flex">
							
						</div>
						<div>
							<button class="btn btn-primary px-4" type="button"
								data-bs-dismiss="modal">í™•ì¸</button>
						</div>
					</div>
				</div>
			</div>
		</div>
			

    <script th:inline="javascript">
      let employeePosition = /*[[${#authentication.principal.employee.employeePosition}]]*/ "";
    </script>



		<script>
		document.addEventListener('DOMContentLoaded', function () {
		    const calendarEl = document.getElementById('appCalendar'); 
		    let selectedCalendarNo = null;
			
		    
		    //WEEKVIEWëŠ” NO Monthviewë§Œ ë‚˜ì˜¤ê²Œ ì„¤ì •, í•œêµ­ì–´ , ì™¼ìª½ ìƒë‹¨ì— ì €ë²ˆë‹¬,ë‹¤ìŒë‹¬ë¡œ ê°€ëŠ” í™”ì‚´í‘œ, ê°€ìš´ë°ëŠ” ë…„ë„,ì›”
		    const calendar = new FullCalendar.Calendar(calendarEl, {
		      initialView: 'dayGridMonth',
		      locale: 'ko',
		      headerToolbar: {
		        left: 'prev,next today',
		        center: 'title',
		        right: ''
		      },
		      buttonText: {
		    	    today: 'ì˜¤ëŠ˜' 
		    	  },
		      dayMaxEventRows: true,
		      views: {
		        dayGridMonth: {
		          dayMaxEventRows: 3,
		          moreLinkText: "ë”ë³´ê¸°"		       
		          }
		      },
		      eventDisplay: 'block',
		      dayCellContent: function (info) {
		        return info.date.getDate();
		      },
		      
		      //ì¼ì • ë“±ë¡ì´ ì•ˆë˜ì–´ìˆëŠ” ë‚ ì„ í´ë¦­í•˜ë©´ ì¼ì •ì„ ë“±ë¡í• ìˆ˜ ìˆê²Œ í•˜ëŠ” event
		      dateClick: function (info) {
		    	  
		    	  if (employeePosition.trim() !== 'ê´€ë¦¬ì') {
		    		  return;
		    		}
		      
		        const dateStr = info.dateStr + "T09:00";
		        document.getElementById('calendarStartTime').value = dateStr;
		        document.getElementById('calendarEndTime').value = info.dateStr + "T18:00";

		        const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
		        addEventModal.show();
		      },
		      		    		        
		      //ë“±ë¡ëœ ì¼ì •ì„ í´ë¦­í•˜ë©´ ìƒì„¸ì¡°íšŒê°€ ë‚˜ì˜¤ëŠ” fullcalendarì˜ event
			eventClick: function (info) {
			  const calendarNo = info.event.extendedProps.calendar_no;
			  console.log("ì œë°œ ê°€ì ¸ì™€ !!!!!!!!! " + calendarNo);
			
			  // ë‚ ì§œ í¬ë§·íŒ… ì˜µì…˜
			  const options = {
			    year: 'numeric',
			    month: 'long',
			    day: 'numeric',
			    weekday: 'short',
			    hour: '2-digit',
			    minute: '2-digit',
			    hour12: true
			  };
			  
			  //ê´€ë¦¬ìë§Œ ìƒì„¸ì¡°íšŒì—ì„œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì´ ë³´ì¼ ìˆ˜ ìˆê²Œ ì„¤ì •
			
			
			  // 1. ì¼ì •, ì‹œê°„, ì¥ì†Œ, ì„¤ëª…ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
			  const title = info.event.title || '';
			  const start = info.event.start; // í•œ ë²ˆë§Œ ì„ ì–¸
			  const end = info.event.end || '';
			  const location = info.event.extendedProps.location || '';
			  const description = info.event.extendedProps.description || '';
			  const teamName = info.event.extendedProps.teamName || '';
			  document.getElementById('eventTeam').textContent = teamName;
			
			  // ë‚ ì§œ í¬ë§·íŒ…
			  const date = start ? new Intl.DateTimeFormat('ko-KR', options).format(start) : '';
			  const endDate = end ? new Intl.DateTimeFormat('ko-KR', options).format(end) : '';
			
			  // 2. ê°ê° í•­ëª©ì„ ì±„ìš°ê³ , ê°’ì´ ì—†ìœ¼ë©´ í•´ë‹¹ í•­ëª©ì„ ìˆ¨ê¹ë‹ˆë‹¤
			  const eventTitleElement = document.getElementById('eventTitle');
			  if (eventTitleElement) {
			    if (title) {
			      eventTitleElement.textContent = title;
			    } else {
			      eventTitleElement.parentElement.style.display = 'none'; // ì œëª© ìˆ¨ê¸°ê¸°
			    }
			  }
			  
			  const teamElement = document.getElementById('eventTeam');
			  if (teamElement) {
			    const teamName = info.event.extendedProps.teamName || '';
			    if (teamName) {
			      teamElement.textContent = teamName;
			    } else {
			      teamElement.parentElement.style.display = 'none'; // íŒ€ ìˆ¨ê¸°ê¸°
			    }
			  }
			
			  const eventDateElement = document.getElementById('eventDate');
			  if (eventDateElement) {
			    if (date) {
			      eventDateElement.textContent = date;
			    } else {
			      eventDateElement.parentElement.style.display = 'none'; // ì‹œì‘ ì‹œê°„ ìˆ¨ê¸°ê¸°
			    }
			  }
			
			  const eventEndDateElement = document.getElementById('eventEndDate');
			  if (eventEndDateElement) {
			    if (endDate) {
			      eventEndDateElement.textContent = endDate;
			    } else {
			      eventEndDateElement.parentElement.style.display = 'none'; // ì¢…ë£Œ ì‹œê°„ ìˆ¨ê¸°ê¸°
			    }
			  }
			
			  const eventLocationElement = document.getElementById('eventLocation');
			  if (eventLocationElement) {
			    if (location) {
			      eventLocationElement.textContent = location;
			    } else {
			      eventLocationElement.parentElement.style.display = 'none'; // ì¥ì†Œ ìˆ¨ê¸°ê¸°
			    }
			  }
			
			  const eventDescriptionElement = document.getElementById('eventDescription');
			  if (eventDescriptionElement) {
			    if (description) {
			      eventDescriptionElement.textContent = description;
			    } else {
			      eventDescriptionElement.parentElement.style.display = 'none'; // ì„¤ëª… ìˆ¨ê¸°ê¸°
			    }
			  }
					
		    selectedCalendarNo = calendarNo;
		
		    const modalButton = document.getElementById('modalButton');
		    if (modalButton) {
		        modalButton.click(); // ëª¨ë‹¬ ë²„íŠ¼ í´ë¦­í•˜ì—¬ ëª¨ë‹¬ ì—´ê¸°
		    } else {
		        console.error('modalButton not found');
		    }
		},

				
		      //ì¼ì •ì˜ ìƒ‰ìƒì„ ì •í•´ì£¼ëŠ” event, E001 -> ê°œì¸ ìº˜ë¦°ë”ëŠ” ì—°í•œ ì—°ë‘ìƒ‰ìœ¼ë¡œ ì§€ì •
		 	eventDidMount: function (info) {
			  const separator = info.event.extendedProps.separator || "";
			  const isHoliday = info.event.extendedProps?.type === 'holiday';
			   //console.log(" separator í™•ì¸:", separator);
			   const event = info.event;
			   const teamName = event.extendedProps.teamName || '';
			   const title = event.title;
			
			   // [íŒ€ëª…] ë¶™ì´ê¸°
			   if (teamName && title && !title.startsWith(`[${teamName}]`)) {
			    event.setProp("title", `[${teamName}] ${title}`);
			   }
			
			  if (isHoliday) {
			    const el = info.el;
			    el.style.setProperty("background-color", "#FFF8B3", "important");
			    el.style.setProperty("border", "1px solid #F5E79E", "important");
			    el.style.setProperty("color", "#4B4B4B", "important");
			    el.style.setProperty("pointer-events", "none", "important");
			    el.style.setProperty("opacity", "1", "important");
			    return;
			  }
			
			  let backgroundColor = "#DDDDDD";
			  let borderColor = "#CCCCCC";
			  let textColor = "#000000";
			
			  // íšŒì‚¬ ì¼ì •
			  if (separator.startsWith("A")) {
			    backgroundColor = "#F8D7DA";
			    borderColor = "#F5C6CB";
			    textColor = "#721C24";
			  }
			
			  // ë¶€ì„œ ì¼ì •
			  if (separator.startsWith("T")) {
			    backgroundColor = "#BDE0FE";  // ì›í•˜ëŠ” ë¶€ì„œ ìƒ‰
			    borderColor = "#7FBFFF";
			    textColor = "#003366";
			  }
			
			  const el = info.el;
			  el.style.setProperty("background-color", backgroundColor, "important");
			  el.style.setProperty("border", `1px solid ${borderColor}`, "important");
			  el.style.setProperty("color", textColor, "important");
			
			  // ì¶”ê°€ ìŠ¤íƒ€ì¼ ë³´ì™„ 
			  el.style.setProperty("border-radius", "8px", "important");
			  el.style.setProperty("padding", "4px 8px", "important");
			  el.style.setProperty("box-shadow", "0 2px 4px rgba(0, 0, 0, 0.1)", "important");
			  el.style.setProperty("font-weight", "500", "important");
			  el.style.setProperty("font-size", "14px", "important");
			
			  const eventMain = el.querySelector(".fc-event-main");
			  if (eventMain) {
			    eventMain.style.setProperty("background-color", backgroundColor, "important");
			    eventMain.style.setProperty("border-color", borderColor, "important");
			    eventMain.style.setProperty("color", textColor, "important");
			    eventMain.style.setProperty("border-radius", "8px", "important");
			  }
			}
		});

		    
		    //ë¶€ì„œì™€ íšŒì‚¬ ìº˜ë¦°ë”ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
		    //ê³µíœ´ì¼ë„ ì¶”ê°€
		    calendar.addEventSource({
		    	  url: '/calendar/list/all',
		    	  method: 'GET',
		    	  failure: () => console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'),
		    	});
		    	calendar.addEventSource({
		    		  events: function (fetchInfo, successCallback, failureCallback) {
		    			    console.log("âœ… ê³µíœ´ì¼ fetch í•¨ìˆ˜ ì‹¤í–‰ë¨");

		    		    const apiKey = 'AIzaSyCjXiu1ShbhE0XenBtciLx8ezU-mcZI0R0';
		    		    const calendarId = 'ko.south_korea%23holiday@group.v.calendar.google.com';
		    		    const timeMin = new Date(fetchInfo.start).toISOString();
		    		    const timeMax = new Date(fetchInfo.end).toISOString();
		    		    const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;

		    		    fetch(url)
		    		      .then(response => response.json())
		    		      .then(data => {
		    		        //console.log("ê³µíœ´ì¼ API ì‘ë‹µ í™•ì¸:", data); 
		    		        const holidays = data.items.map(item => ({
		    		          title: item.summary,
		    		          start: item.start.date,
		    		          allDay: true,
		    		          extendedProps: { type: 'holiday' }
		    		        }));
		    		        successCallback(holidays);
		    		      })
		    		      .catch(error => {
		    		        //console.error("ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ğŸ˜¢", error);
		    		        failureCallback(error);
		    		      });
		    		  }
		    		});

		 	
		

		
		    
		
		    
			
			calendar.render();
		
		})
  	
    	</script>
  </main>
</body>
</html>
