<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/include/layout}">
<head>
  <title>ë¶€ì„œ ìº˜ë¦°ë”</title>
</head>
<body>
  <main class="main" id="top" layout:fragment="content">
    <div class="row g-0 mb-4 align-items-center">
      <div class="col-5 col-md-6">
        <h4 class="mb-0 text-body-emphasis fw-bold fs-md-6">ë¶€ì„œì¼ì •</h4>
      </div>
    </div>


		<!-- ì†Œì† ì„ íƒœ ì…€ë ‰íŠ¸ ì°½-->
		<div class="mb-3">
			<select class="form-select form-select-sm" id="departmentSelect"
				onchange="changeDepartment(this.value)"
				style="width: 200px; font-size: 14px; padding: 6px 10px;">
				<option disabled selected>-- ì†Œì† ì„ íƒ --</option>
				<option th:each="dept : ${structureList}"
					th:value="${dept.separator_code}" th:text="${dept.separator_name}"
					th:selected="${dept.separator_code == selectedDepartment}"></option>
			</select>
		</div>

		<div class="mb-3 d-flex flex-wrap gap-2">
			<div
				style="background-color: #E0BBE4; padding: 5px 10px; border-radius: 5px; font-size: 13px;">ê¸°ìˆ ë¶€</div>
			<div
				style="background-color: #A2D2FF; padding: 5px 10px; border-radius: 5px; font-size: 13px;">ìš´ì˜ë¶€</div>
			<div
				style="background-color: #B5E48C; padding: 5px 10px; border-radius: 5px; font-size: 13px;">ì œí’ˆë¶€</div>
			<div
				style="background-color: #FF8C94; padding: 5px 10px; border-radius: 5px; font-size: 13px;">ì˜ì—…ë¶€</div>
		</div>

		<div class="calendar-outline mt-6 mb-9" id="appCalendar"></div>
    
    <button class="btn btn-primary" type="button" data-bs-toggle="modal"
			data-bs-target="#tooltipModal" style="display: none;"
			id="modalButton"></button>

		<!-- ëª¨ë‹¬ ì°½ -->
		<div class="modal fade" id="tooltipModal" tabindex="-1"
			aria-labelledby="tooltipModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content border border-translucent">
					<div class="modal-header px-card border-0 position-relative">
						<h5 class="mb-0 lh-sm text-body-highlight" id="tooltipModalLabel">ë¶€ì„œ ì¼ì •
							ìƒì„¸ì¡°íšŒ</h5>
						<button class="btn-close position-absolute top-0 end-0 mt-2 me-2"
							type="button" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body p-card py-0">
						<input type="hidden" name="calendar_no" value="">
						<div class="mb-3">
							<strong>íŒ€:</strong> <span id="eventTeam"></span>
						</div>
						<div class="mb-3">
							<strong>ì¼ì •:</strong> <span id="eventTitle"></span>
						</div>
						<div class="mb-3">
							<strong>ì‹œì‘ ì‹œê°„:</strong> <span id="eventDate"></span>
						</div>
						<div class="mb-3">
							<strong>ì¢…ë£Œ ì‹œê°„:</strong> <span id="eventEndDate"></span>
						</div>
						<div class="mb-3">
							<strong>ì¥ì†Œ:</strong> <span id="eventLocation"></span>
						</div>
						<div class="mb-3">
							<strong>ì„¤ëª…:</strong> <span id="eventDescription"></span>
						</div>
					</div>
					<div
						class="modal-footer d-flex justify-content-between align-items-center border-0">
						<div class="d-flex">
							<!-- ìˆ˜ì • ë²„íŠ¼ ì‚­ì œë¨ -->
							<button class="btn btn-outline-info me-1 mb-1" type="button"
								id="deleteEventBtn">ì‚­ì œ</button>
						</div>
						<div>
							<button class="btn btn-primary px-4" type="button"
								data-bs-dismiss="modal">í™•ì¸</button>
						</div>
					</div>
				</div>
			</div>
		</div>
			

    <script th:inline="javascript">
      let employeePosition = /*[[${#authentication.principal.employee.employeePosition}]]*/ "";
    </script>

	<script th:inline="javascript">
  	// ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ë¶€ì„œ ì½”ë“œ Thymeleafë¡œ ì‚½ì…
  	let selectedDepartment = /*[[${#authentication.principal.employee.structure.separatorCode}]]*/ "";
	</script>

		<script>
	    let calendar;
	    let holidaySource = null;
	    let departmentSource = null;
	
	    document.addEventListener('DOMContentLoaded', function () {
	      const calendarEl = document.getElementById('appCalendar');
	
	      calendar = new FullCalendar.Calendar(calendarEl, {
	        initialView: 'dayGridMonth',
	        locale: 'ko',
	        headerToolbar: {
	          left: 'prev,next today',
	          center: 'title',
	          right: ''
	        },
	        buttonText: { today: 'ì˜¤ëŠ˜' },
	        dayMaxEventRows: true,
	        views: {
	          dayGridMonth: { dayMaxEventRows: 3, moreLinkText: "ë”ë³´ê¸°" }
	        },
	        eventDisplay: 'block',
	        dayCellContent: function (info) {
	          return info.date.getDate();
	        },
	        dateClick: function (info) {
	          const dateStr = info.dateStr + "T09:00";
	          document.getElementById('calendarStartTime').value = dateStr;
	          document.getElementById('calendarEndTime').value = info.dateStr + "T18:00";
	          const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
	          addEventModal.show();
	        },
	        eventClick: function (info) {
				  const calendarNo = info.event.extendedProps.calendar_no;
				  console.log("ì œë°œ ê°€ì ¸ì™€ !!!!!!!!! " + calendarNo);
				
				  // ë‚ ì§œ í¬ë§·íŒ… ì˜µì…˜
				  const options = {
				    year: 'numeric',
				    month: 'long',
				    day: 'numeric',
				    weekday: 'short',
				    hour: '2-digit',
				    minute: '2-digit',
				    hour12: true
				  };
				  
				  //ê´€ë¦¬ìë§Œ ìƒì„¸ì¡°íšŒì—ì„œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì´ ë³´ì¼ ìˆ˜ ìˆê²Œ ì„¤ì •
				  if (employeePosition.trim() === 'ê´€ë¦¬ì') {
					    
					    document.getElementById('deleteEventBtn').style.display = 'inline-block';
					  } else {
					   
					    document.getElementById('deleteEventBtn').style.display = 'none';
					  }
				
				  // 1. ì¼ì •, ì‹œê°„, ì¥ì†Œ, ì„¤ëª…ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
				  const title = info.event.title || '';
				  const start = info.event.start; // í•œ ë²ˆë§Œ ì„ ì–¸
				  const end = info.event.end || '';
				  const location = info.event.extendedProps.location || '';
				  const description = info.event.extendedProps.description || '';
				  document.getElementById('eventTeam').textContent = info.event.extendedProps.teamName || '';
				
				  // ë‚ ì§œ í¬ë§·íŒ…
				  const date = start ? new Intl.DateTimeFormat('ko-KR', options).format(start) : '';
				  const endDate = end ? new Intl.DateTimeFormat('ko-KR', options).format(end) : '';
				
				  // 2. ê°ê° í•­ëª©ì„ ì±„ìš°ê³ , ê°’ì´ ì—†ìœ¼ë©´ í•´ë‹¹ í•­ëª©ì„ ìˆ¨ê¹ë‹ˆë‹¤
				  const eventTitleElement = document.getElementById('eventTitle');
				  if (eventTitleElement) {
				    if (title) {
				      eventTitleElement.textContent = title;
				    } else {
				      eventTitleElement.parentElement.style.display = 'none'; // ì œëª© ìˆ¨ê¸°ê¸°
				    }
				  }
				
				  const eventDateElement = document.getElementById('eventDate');
				  if (eventDateElement) {
				    if (date) {
				      eventDateElement.textContent = date;
				    } else {
				      eventDateElement.parentElement.style.display = 'none'; // ì‹œì‘ ì‹œê°„ ìˆ¨ê¸°ê¸°
				    }
				  }
				
				  const eventEndDateElement = document.getElementById('eventEndDate');
				  if (eventEndDateElement) {
				    if (endDate) {
				      eventEndDateElement.textContent = endDate;
				    } else {
				      eventEndDateElement.parentElement.style.display = 'none'; // ì¢…ë£Œ ì‹œê°„ ìˆ¨ê¸°ê¸°
				    }
				  }
				
				  const eventLocationElement = document.getElementById('eventLocation');
				  if (eventLocationElement) {
				    if (location) {
				      eventLocationElement.textContent = location;
				    } else {
				      eventLocationElement.parentElement.style.display = 'none'; // ì¥ì†Œ ìˆ¨ê¸°ê¸°
				    }
				  }
				
				  const eventDescriptionElement = document.getElementById('eventDescription');
				  if (eventDescriptionElement) {
				    if (description) {
				      eventDescriptionElement.textContent = description;
				    } else {
				      eventDescriptionElement.parentElement.style.display = 'none'; // ì„¤ëª… ìˆ¨ê¸°ê¸°
				    }
				  }
						
			    selectedCalendarNo = calendarNo;
			
			    const modalButton = document.getElementById('modalButton');
			    if (modalButton) {
			        modalButton.click(); // ëª¨ë‹¬ ë²„íŠ¼ í´ë¦­í•˜ì—¬ ëª¨ë‹¬ ì—´ê¸°
			    } else {
			        console.error('modalButton not found');
			    }
			},
	        eventDidMount: function (info) {		 		
			 		  const el = info.el;
			 		  const separator = info.event.extendedProps.separator || "";
			 		  const type = info.event.extendedProps.type;
	
			 		  // ê³µíœ´ì¼ì¼ ê²½ìš° ìŠ¤íƒ€ì¼ ì ìš©
			 		  if (type === "holiday") {
			 		    el.style.setProperty("background-color", "#FFF8B3", "important"); // ì—°ë…¸ë‘
			 		    el.style.setProperty("border", "1px solid #F5E79E", "important");
			 		    el.style.setProperty("color", "#4B4B4B", "important");
			 		    el.style.setProperty("pointer-events", "none", "important"); // í´ë¦­ ë§‰ê¸°
			 		    el.style.setProperty("opacity", "1", "important");
			 		    return;
			 		  }
	
			 		  //  íŒ€/ë¶€ì„œ ìƒ‰ìƒ ë§¤í•‘
			 		  const departmentColorMap = {
			 				  "D001": "#E0BBE4", // ì—°ë³´ë¼
			 				  "D002": "#A2D2FF", // ì‹œì›í•œ ì—°í•˜ëŠ˜ íŒŒë‘
			 				  "D003": "#B5E48C", // ë¶€ë“œëŸ¬ìš´ ì—°ë‘
			 				  "D004": "#FF8C94"  // ë¶€ë“œëŸ¬ìš´ ë¡œì¦ˆ í•‘í¬
			 		  };
	
			 		  const teamToDepartmentMap = {
			 		    "T001": "D001", "T002": "D002", "T003": "D002", "T004": "D002",
			 		    "T005": "D003", "T006": "D003", "T007": "D004", "T008": "D004"
			 		  };
	
			 		  // ê¸°ì¡´ switch-case ìš°ì„  ì ìš©
			 		  let backgroundColor, borderColor, textColor;
	
			 		  switch (separator) {
			 		    case "E001":
			 		      backgroundColor = "#C1F0E3";
			 		      borderColor = "#A3E4A0";
			 		      textColor = "#1A3C1A";
			 		      break;
			 		    case "A001":
			 		      backgroundColor = "#F8D7DA";
			 		      borderColor = "#F5C6CB";
			 		      textColor = "#721C24";
			 		      break;
			 		    default:
			 		      // íŒ€ì— ë”°ë¥¸ ë¶€ì„œ ìƒ‰ìƒ ì ìš©
			 		      const deptCode = teamToDepartmentMap[separator] || null;
			 		      const deptColor = departmentColorMap[deptCode] || "#CCCCCC";
	
			 		      backgroundColor = deptColor;
			 		      borderColor = deptColor;
			 		      textColor = "#000000";
			 		      break;
			 		  }
	
			 		  el.style.setProperty("background-color", backgroundColor, "important");
			 		  el.style.setProperty("border-color", borderColor, "important");
			 		  el.style.setProperty("color", textColor, "important");
			  }
			 	
	      });
	
	      // ê³µíœ´ì¼ sourceëŠ” ì²˜ìŒì—ë§Œ í•œ ë²ˆ ì¶”ê°€
	      holidaySource = calendar.addEventSource({
	        events: function (fetchInfo, successCallback, failureCallback) {
	          const apiKey = 'AIzaSyCjXiu1ShbhE0XenBtciLx8ezU-mcZI0R0';
	          const calendarId = 'ko.south_korea%23holiday@group.v.calendar.google.com';
	          const timeMin = new Date(fetchInfo.start).toISOString();
	          const timeMax = new Date(fetchInfo.end).toISOString();
	          const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
	
	          fetch(url)
	            .then(response => response.json())
	            .then(data => {
	              const holidays = data.items.map(item => ({
	                title: item.summary,
	                start: item.start.date,
	                allDay: true,
	                extendedProps: { type: 'holiday' }
	              }));
	              successCallback(holidays);
	            })
	            .catch(error => {
	              console.error("ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error);
	              failureCallback(error);
	            });
	        }
	      
	      });
	      
			document.getElementById('deleteEventBtn').addEventListener('click',function(){
				const calendarNo = selectedCalendarNo;
				console.log(calendarNo);
				const perMission = confirm('í•´ë‹¹ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
				//console.log(perMission);
				if(!perMission){
					return;
				}else{
					fetch('/departmentcalendar/delete/'+calendarNo,{
						method: 'post',
						headers: {
				            'header': document.querySelector('meta[name="_csrf_header"]').content,
				            'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				        }
					})
					.then(response => response.json())
					.then(data => {
						alert(data.res_msg);
						if(data.res_code == 200) location.reload();
					})
				}
			});
	
	      calendar.render();
	
	      const selectedDepartment = document.getElementById('departmentSelect')?.value;
	      if (selectedDepartment) {
	        changeDepartment(selectedDepartment);
	      }
	    });
	
	    window.changeDepartment = function (departmentCode) {
	      console.log("ì„ íƒëœ ë¶€ì„œ ì½”ë“œ: ", departmentCode);
	
	      // ê¸°ì¡´ ë¶€ì„œ ì¼ì •ë§Œ ì œê±°
	      if (departmentSource) {
	        departmentSource.remove();
	      }
	
	      // ìƒˆë¡œ ì„ íƒëœ ë¶€ì„œ ì¼ì • ì¶”ê°€
	      departmentSource = calendar.addEventSource({
	    	  events: function (fetchInfo, successCallback, failureCallback) {
	    	    fetch('/departmentcalendar/list/' + departmentCode)
	    	      .then(response => {
	    	        if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨!");
	    	        return response.json();
	    	      })
	    	      .then(events => {
	    	        const updatedEvents = events.map(event => {
	    	          return {
	    	            ...event,
	    	            title: (event.teamName ? `[${event.teamName}] ` : '') + (event.title || '')
	    	          };
	    	        });
	    	        successCallback(updatedEvents);
	    	      })
	    	      .catch(error => {
	    	        console.error("ë¶€ì„œ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ğŸ˜¢", error);
	    	        failureCallback(error);
	    	      });
	    	  }
	    	});
	    };

      
    </script>
  </main>
</body>
</html>
