<!DOCTYPE html>
<html lang="ko-KR" dir="ltr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title>근태 상세</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .profile-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
    }
    .profile-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .row > [class^="col"] {
      display: flex;
    }
    .card {
      flex: 1 1 auto;
    }

  </style>
</head>
<body>
<main class="main" id="top" layout:fragment="content">
  <div class="mb-9">
  	<!-- 현재 페이지의 회원 정보 -->
  	<input type="hidden" id="employeeNo" th:value="${employee.employeeNo}"/>
    
    <div class="d-flex justify-content-between align-items-center mb-2 position-relative"
        th:if="${isAdmin}">
      <span class="fw-bold fs-7">근태 / 회원 정보 수정</span>

    </div>

    <!-- 카드 그룹: 프로필 + 근태요약 / 주소록 + 근무시간 -->
    <div class="row g-3">
      <!-- 1행: 프로필 + 근태 요약 -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-body d-flex align-items-center">
			<!-- 관리자일 때 -->
			<div class="profile-wrapper me-3" >
			  <img id="profileImage" class="rounded-circle" th:src="@{${profileImageUrl}}" alt="프로필">
			</div>
			

            <div class="text-start">
              <div class="fw-bold fs-7" th:text="${employee.employeeName}">이름</div>
              <div class="text-body-secondary" th:text="${employee.employeePosition}">직급</div>
            </div>
          </div>
          <div class="card-footer border-top border-dashed pt-3">
   			<div class="d-flex align-items-center mb-2" th:if="${isAdmin}">
				<!--  수정 버튼 -->
				<button class="btn btn-link position-absolute top-0 end-0 mt-2 me-2 p-0" id="editAnnualLeaveBtn"
				        data-bs-toggle="modal" data-bs-target="#editInfoModal">
					<svg class="svg-inline--fa fa-pen fs-9 ms-2 text-body-quaternary" aria-hidden="true"
					     focusable="false" data-prefix="fas" data-icon="pen" role="img"
					     xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
						<path fill="currentColor"
					        d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"></path>
					</svg>
				</button>
			</div> 
            <div class="d-flex justify-content-around">
              <div>
                <div class="fw-bold fs-8 text-center">총 연차</div>
                <div class="fs-7 text-body-secondary text-center" th:text="${annualLeave.annual_leave_total}">12</div>
              </div>
              <div>
                <div class="fw-bold fs-8 text-center">사용 연차</div>
                <div class="fs-7 text-body-secondary text-center" th:text="${annualLeave.annual_leave_used}">2</div>
              </div>
              <div>
                <div class="fw-bold fs-8 text-center">잔여 연차</div>
                <div class="fs-7 text-body-primary text-center" th:text="${annualLeave.annual_leave_remain}">10</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <div class="fw-bold fs-8 mb-3 text-secondary">이번 달 근태 요약</div>
            <div class="row text-center">
              <div class="col text-center d-flex flex-column align-items-center">
                <div class="fw-semibold mb-2">출근일수</div>
                <div class="text-primary fw-bold" th:text="${summaryData.checkinDays} + '일'">O일</div>
              </div>
              <div class="col text-center d-flex flex-column align-items-center">
                <div class="fw-semibold">지각</div>
                <div class="text-danger fw-bold" th:text="${summaryData.lateCount} + '회'">OO회</div>
              </div>
              <div class="col text-center d-flex flex-column align-items-center">
                <div class="fw-semibold">조퇴</div>
                <div class="text-warning fw-bold" th:text="${summaryData.earlyLeaveCount} + '회'">OO회</div>
              </div>
              <div class="col text-center d-flex flex-column align-items-center">
                <div class="fw-semibold">평균 출근</div>
                <div class="text-success fw-bold" th:text="${summaryData.averageCheckInTime}">00:00</div>
              </div>
              <div class="col text-center d-flex flex-column align-items-center">
                <div class="fw-semibold">출근률</div>
                <div class="text-info fw-bold" th:text="${summaryData.attendanceRate}">00%</div>
              </div>
            </div>
            <div class="mini-chart-wrapper mt-4">
              <canvas id="miniAttendanceChart" height="47"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 2행: 주소록 + 근무시간 차트 -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-body fs-9">
			<div class="d-flex align-items-center mb-2" th:if="${isAdmin}">
				<!--  수정 버튼 -->
<!-- 				<button class="btn btn-link position-absolute top-0 end-0 mt-2 me-2 p-0" id="editDirectoryBtn"
				        data-bs-toggle="modal" data-bs-target="#editInfoModal">
					<svg class="svg-inline--fa fa-pen fs-9 ms-2 text-body-quaternary" aria-hidden="true"
					     focusable="false" data-prefix="fas" data-icon="pen" role="img"
					     xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
						<path fill="currentColor"
					        d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"></path>
					</svg>
				</button> -->
			</div>          
            <h5 class="text-body-secondary">사번</h5>
            <p class="text-body-secondary" th:text="${employee.employeeId}">사번</p>

			<h5 class="text-body-secondary">소속</h5>
			<p class="text-body-secondary" 
			   th:text="${(departmentName != null ? departmentName : '-') + ' / ' + (teamName != null ? teamName : '-')}">
			   부서 / 팀
			</p>           
            
            <div class="mb-3">
              <h5 class="text-body-secondary">Email</h5>
              <a href="mailto:email@email.com" id="emailValue" th:text="${directory != null and directory.directory_email != null ? directory.directory_email : '-'}">email@email.com</a>
            </div>
            
            <h5 class="text-body-secondary">연락처</h5>
            <p class="text-body-secondary" id="phoneValue" th:text="${directory != null and directory.directory_phone != null ? directory.directory_phone : '-'}">010-0000-0000</p>
 			
 			<h5 class="text-body-secondary">주소</h5>
			<p class="text-body-secondary" id="addressValue"
			   th:text="${directory != null and directory.directory_zipcode != null and directory.directory_address != null 
			             ? '(' + directory.directory_zipcode + ') ' + directory.directory_address 
			             : '-'}">
			  (00000) 주소정보
			</p>
          
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card p-3">
          <div class="card-title d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold fs-8 text-secondary">근무시간 통합 차트</span>
            <p class="text-muted mb-0">이번 달 총 근무시간: <strong class="text-primary" th:text="${totalWorkTime}">000시간 00분</strong></p>
          </div>
          <canvas id="workTimeMixedChart" height="260"></canvas>
        </div>
      </div>
    </div>
  </div>       

<hr><!-- 상단/하단 구분선 -->
	
<!-- 근태 현황 목록 테이블 -->     
<div id="attendanceTable" data-list='{"valueNames":["no","date","checkin","checkout","late","early"],"page":10,"pagination":true}'>
  <!-- 상단: 날짜 선택 + 검색창 -->
  <div class="d-flex justify-content-between align-items-center mb-3 px-3 gap-2 flex-wrap">
     <div class="row g-2 mb-4">
		<div class="d-flex justify-content-start align-items-center mb-2">
			<!-- <i class="fas fa-user-tie text-secondary me-2"></i> -->
			<span class="fw-bold fs-7">근태 현황</span>
		</div>
	</div>
        <!-- 검색창 -->
    <div class="flex-grow-1 d-flex justify-content-center">
      <div class="search-box w-50">
        <form class="position-relative">
          <input class="form-control form-control-sm search-input search" type="search" placeholder="검색어를 입력하세요." aria-label="Search">
          <svg style="height:40%;" class="svg-inline--fa fa-magnifying-glass search-box-icon" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="magnifying-glass" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"></path>
          </svg>
        </form>
      </div>
    </div>
    <!-- 날짜 선택 -->
    <div>
    <form th:action="@{/admin/employeeInfoView}" method="get" id="monthSelectForm" th:if="${monthList.size() > 0}">
          <input type="hidden" name="employeeNo" th:value="${employee.employeeNo}"/>
	      <select class="form-select form-select-sm" data-list-filter="data-list-filter" 
	      	name="month" id="month" onchange="this.form.submit()">
	        <option th:each="month : ${monthList}"
	            th:value="${month}" th:text="${month}" 
	        	th:selected="${month == selectedMonth}"></option>
	      </select>
      </form>
    </div>

  </div>

  <!-- 테이블 -->
	<div class="table-responsive">
	    <table class="table table-striped table-sm fs-9 mb-0 text-center">
			<thead class="text-center align-middle">
				<tr class="table-light">
					<th class="sort" data-sort="no" style="width:5%;">번호</th>
					<th class="sort" data-sort="date" style="width:25%;">근무일</th>
					<th class="sort" data-sort="checkin" style="width:25%;">출근 시간</th>
					<th class="sort" data-sort="checkout" style="width:25%;">퇴근 시간</th>
					<th class ="sort" data-sort="late" style="width:10%">지각</th>
					<th class ="sort" data-sort="early" style="width:10%">조퇴</th>
					<th class="text-end-pe-0" th:if="${isAdmin}"></th>
				</tr>
			</thead>
			<tbody class="list align-middle">
				<tr th:if ="${!#lists.isEmpty(attendanceList)}"
					th:each="attendance, attendanceStatus : ${attendanceList}">
				  <td class="no" th:text="${attendanceStatus.count}">1</td>
				  <td class="date" th:text="${#temporals.format(attendance.attendance_check_in_time, 'yyyy.MM.dd')}">연도.월.일</td>
				  <td class="checkin" th:text="${#temporals.format(attendance.attendance_check_in_time, 'HH:mm:ss')}">출근 시간</td>
				  <td class="checkout" th:text="${#temporals.format(attendance.attendance_check_out_time, 'HH:mm:ss')}">퇴근 시간</td>
				  <td class="late" th:text="${attendance.attendance_late_yn == 'Y' ? '지각' : '-'}">지각</td>
				  <td class="early" th:text="${attendance.attendance_early_leave_yn == 'Y' ? '조퇴' : '-'}">조퇴</td>
				  <td class="text-end pe-0" th:if="${isAdmin}">
					<div class="btn-reveal-trigger position-static">
						<button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs-10" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
						  <i class="fas fa-ellipsis fs-10"></i>
						</button>
						<div class="dropdown-menu dropdown-menu-end py-2">
						  <a class="dropdown-item edit-attendance-btn"  href="#!"
						  th:attr="data-attendance-no=${attendance.attendance_no}"
						  	data-bs-toggle="modal" data-bs-target="#editAttendanceModal">
						  	수정
						  	</a>
<!-- 						  <div class="dropdown-divider"></div>
						  <a class="dropdown-item text-danger" href="#!">삭제</a> -->
						</div>
					</div>
				 </td>
				  
				</tr>
				<tr th:if="${#lists.isEmpty(attendanceList)}">
				    <td colspan="5" class="text-center"> 근태 정보가 없습니다.</td>
				</tr>
			</tbody>
	    </table>
	</div>

  <!-- 페이징 -->
	<div class="row justify-content-center py-2 fs-9">
	    <div class="col-auto d-flex">
	      <button class="page-link disabled" data-list-pagination="prev" disabled>
	        <i class="fas fa-chevron-left"></i>
	      </button>
	      <ul class="mb-0 pagination">
	        <li class="active"><button class="page" type="button" data-i="1">1</button></li>
	      </ul>
	      <button class="page-link disabled" data-list-pagination="next" disabled>
	        <i class="fas fa-chevron-right"></i>
	      </button>
	    </div>
	</div>
</div><!-- 근태현황 목록 테이블 끝 -->


<!-- 근태 정보 수정 모달 -->
<div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-labelledby="editAttendanceModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
	  <div class="modal-content border border-secondary">
	    <form id="editAttendanceForm" autocomplete="off" name="editAttendanceForm">
	
	      <!-- 헤더 -->
	      <div class="modal-header bg-light">
	        <h5 class="modal-title" id="editAttendanceModalLagel">근태 정보 수정</h5>
	        <button class="btn-close btn-close-secondary" type="button" aria-label="Close"></button>
	      </div>
	
	      <!-- 바디 -->
	      <div class="modal-body px-4 py-2">
			<input type="hidden" id="employeeNo" name="employeeNo" th:value="${employee.employeeNo}"/>
			<input type="hidden" id="attendanceNo" name="attendance_no"/>
			<!-- 출근일시 + 지각 -->
			<div class="mb-3">
			  <label for="editCheckInTime" class="form-label fw-semibold">출근일시</label>
			  <div class="d-flex align-items-center">
			    <input type="datetime-local" class="form-control" id="editCheckInTime"
			           name="attendance_check_in_time" style="width: 70%;" step="1">
			    <span id="lateStatus" class="text-danger small fw-semibold ms-7" style="margin-left: 8px;">지각여부</span>
			  </div>
			</div>
			
			<!-- 퇴근일시 + 조퇴 -->
			<div class="mb-3">
			  <label for="editCheckOutTime" class="form-label fw-semibold">퇴근일시</label>
			  <div class="d-flex align-items-center">
			    <input type="datetime-local" class="form-control" id="editCheckOutTime"
			           name="attendance_check_out_time" style="width: 70%;" step="1">
			    <span id="earlyLeaveStatus" class="text-danger small fw-semibold ms-7" style="margin-left: 8px;">조퇴여부</span>
			  </div>
			</div>
	
	      </div>
	
	      <!-- 푸터 -->
	      <div class="modal-footer px-4 py-3 border-0 d-flex justify-content-end">
	        <button type="button" class="btn btn-light me-2" id="cancelEditBtn">취소</button>
	        <button type="button" class="btn btn-primary" id="editSubmitBtn">수정하기</button>
	      </div>
	    </form>
	  </div>
	</div>
</div>

<!-- confirm Modal -->
<div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
      <div class="modal-header border-0">
        <h5 class="modal-title text-dark" id="confirmSaveModalLabel">수정 확인</h5>
       <!--  <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="Close"></button> -->
      </div>
      <div class="modal-body text-center">
        <p class="mb-0 text-body" id="confirmSaveModalMessage">
          <!-- 상황별 메시지가 여기에 들어감 -->
          수정 하시겠습니까?
        </p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-phoenix-secondary" id="cancelSaveBtn" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="confirmSaveBtn">확인</button>
      </div>
    </div>
  </div>
</div>

<!-- Alert Modal (닫기 경고용) -->
<div class="modal fade" id="unsavedAlertModal" tabindex="-1" aria-labelledby="unsavedAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
      <div class="modal-header border-0">
        <h5 class="modal-title text-dark" id="unsavedAlertModalLabel">창닫기</h5>
       <!--  <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="Close"></button> -->
      </div>
      <div class="modal-body text-center">
        <p class="mb-0 text-body">
          작성 중인 회원 수정 정보가 사라집니다.<br>정말 닫으시겠습니까?
        </p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-phoenix-secondary" id="stayModalBtn" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-danger" id="confirmCloseBtn">확인</button>
      </div>
    </div>
  </div>
</div>

<!-- 퇴근시간 유효성 경고 모달 -->
<!-- <div class="modal fade" id="invalidCheckOutModal" tabindex="-1" aria-labelledby="invalidCheckOutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border border-secondary">
      <div class="modal-header bg-light text-white">
        <h5 class="modal-title" id="invalidCheckOutModalLabel">입력 오류</h5>
        <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        퇴근 시간은 출근 시간보다 늦어야 합니다.<br>
        다시 선택해 주세요.
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div> -->
<div class="modal fade" id="invalidCheckOutModal" tabindex="-1" aria-labelledby="invalidCheckOutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
      <div class="modal-header border-0">
        <h5 class="modal-title text-dark" id="invalidCheckOutModalLabel">입력 오류</h5>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0 text-body">
          퇴근 시간은 출근 시간보다 늦어야 합니다.<br>다시 선택해 주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div>
<!-- 알림 모달 (성공/실패 공통) -->
<!-- <div class="modal fade" id="alertMessageModal" tabindex="-1" aria-labelledby="alertMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border border-secondary">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="alertMessageModalLabel">알림</h5>
        <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body" id="alertMessageContent">
        서버 응답 메시지가 들어갈 자리
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div> -->
<div class="modal fade" id="alertMessageModal" tabindex="-1" aria-labelledby="alertMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-light text-body rounded-3 shadow-lg border border-secondary-light">
      <div class="modal-header border-0">
        <h5 class="modal-title text-dark" id="alertMessageModalLabel">알림</h5>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0 text-body" id="alertMessageContent">
          <!-- 서버 응답 메시지가 들어갈 자리 -->
        </p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {

	// 상단에 현재 날짜 표시
/* 	function updateCurrentTime() {
		const now = new Date();
		const year = now.getFullYear();
		const month = String(now.getMonth() + 1).padStart(2, '0');
		const date = String(now.getDate()).padStart(2, '0');
		document.getElementById('currentTime').innerText = `${year}.${month}.${date}`;
	}
	updateCurrentTime(); */

	//서버 응답 메시지를 모달에 표시하고 확인 시 콜백 실행
	function showAlertModal(message, callback) {
	  // 메시지를 알림 모달 본문에 삽입
	  document.getElementById('alertMessageContent').textContent = message;

	  // 알림 모달 인스턴스 생성 또는 가져오기
	  const alertModal = new bootstrap.Modal(document.getElementById('alertMessageModal'));
	  alertModal.show();

	  // 확인 버튼 클릭 시 실행할 콜백 등록
	  const confirmBtn = document.querySelector('#alertMessageModal .btn-primary');

	  // 한 번만 실행되도록 리스너 등록
	  const handler = () => {
	    if (callback) callback(); // 예: location.reload()
	    confirmBtn.removeEventListener('click', handler); // 중복 방지
	  };

	  confirmBtn.addEventListener('click', handler);
	}
	
	// 차트 데이터를 받아서 각 차트를 렌더링하는 함수
	async function renderCharts() {
		
		const employeeNo = document.getElementById('employeeNo').value;
		console.log(employeeNo); // 디버깅용 콘솔 출력
		// 1. API 호출
		const response = await fetch(`/admin/employeeChartData?employeeNo=${employeeNo}`);
		const data = await response.json();
		console.log(data); // 디버깅용 콘솔 출력
		console.log(data.checkinDays,data.lateCount,data.earlyLeaveCount); // 디버깅용 콘솔 출력

		/* --------------- 근태 요약 차트 (Bar Chart) ----------------- */
		const miniCtx = document.getElementById('miniAttendanceChart').getContext('2d');
		console.log(miniCtx); // 디버깅용 콘솔 출력
		new Chart(miniCtx, {
			type: 'bar',
			data: {
				labels: ['출근일수', '지각', '조퇴'],
				datasets: [{
					label: '횟수',
					data: [
						data.checkinDays || 0,
						data.lateCount || 0,
						data.earlyLeaveCount || 0
					],
					backgroundColor: [
						'rgba(13, 110, 253, 0.7)',   // 출근: 파랑
						'rgba(220, 53, 69, 0.7)',    // 지각: 빨강
						'rgba(255, 193, 7, 0.7)'     // 조퇴: 노랑
					]
				}]
			},
			options: {
				plugins: {
					legend: { display: false }
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: { stepSize: 1 }
					}
				}
			}
		});

		/* --------------- 근무시간 통합 차트 (Mixed: Line + Bar) ----------------- */
		const mixedCtx = document.getElementById('workTimeMixedChart').getContext('2d');
		const workTimePerDay = data.workTimePerDay || {};
		const weekdayAvg = data.weekdayAvg || {};

		// (1) 날짜별 근무시간 차트용 데이터 변환
		const dailyLabels = Object.keys(workTimePerDay).map(dateStr => {
			const [year, month, day] = dateStr.split('-');
			return `${month}/${day}`;
		});
		const dailyData = Object.values(workTimePerDay);

		// (2) 요일별 평균 근무시간 변환 및 정렬
		const dayMap = {
			'MONDAY': '월', 'TUESDAY': '화', 'WEDNESDAY': '수',
			'THURSDAY': '목', 'FRIDAY': '금'
		};
		const weekdayOrder = ['월', '화', '수', '목', '금'];
		const weekdayData = weekdayOrder.map(kor => {
			const eng = Object.keys(dayMap).find(key => dayMap[key] === kor);
			return weekdayAvg[eng] ?? null;
		});

		// (3) 차트 생성
		new Chart(mixedCtx, {
			type: 'bar',
			data: {
				labels: [...dailyLabels, ...weekdayOrder],
				datasets: [
					{
						type: 'line',
						label: '일별 근무시간',
						data: [...dailyData, ...new Array(weekdayOrder.length).fill(null)],
						borderColor: '#0d6efd',
						backgroundColor: '#0d6efd55',
						yAxisID: 'y',
						tension: 0.3,
						spanGaps: true
					},
					{
						type: 'bar',
						label: '요일별 평균 근무시간',
						data: [...new Array(dailyLabels.length).fill(null), ...weekdayData],
						backgroundColor: 'rgba(255, 99, 132, 0.6)',
						yAxisID: 'y1'
					}
				]
			},
			options: {
				responsive: true,
				plugins: {
					tooltip: {
						callbacks: {
							label: function (context) {
								const label = context.dataset.label;
								const val = context.raw;
								return label + ': ' + (val !== null ? val.toFixed(2) + '시간' : '');
							}
						}
					},
					legend: { position: 'top' }
				},
				scales: {
					y: {
						type: 'linear',
						position: 'left',
						title: { display: true, text: '일별 근무시간' },
						beginAtZero: true,
						suggestedMax: 10
					},
					y1: {
						type: 'linear',
						position: 'right',
						title: { display: true, text: '요일별 평균' },
						grid: { drawOnChartArea: false },
						beginAtZero: true,
						suggestedMax: 10
					}
				}
			}
		});
	}
	renderCharts();

	// 수정 버튼 클릭 시 모달 열기 및 데이터 채우기


  const editModal = document.getElementById('editAttendanceModal');
  const bsEditModal = bootstrap.Modal.getOrCreateInstance(editModal); // 모달 인스턴스 가져오기 or 생성
  const alertModal = new bootstrap.Modal(document.getElementById('unsavedAlertModal')); // 닫기 확인용 모달
  const invalidModal = new bootstrap.Modal(document.getElementById('invalidCheckOutModal')); // 시간 유효성 확인 모달

  const checkInInput = document.getElementById('editCheckInTime');
  const checkOutInput = document.getElementById('editCheckOutTime');

  // 원래 값을 저장하여 모달 닫기 전 비교용으로 사용
  let originalData = {
    checkInTime: '',
    checkOutTime: ''
  };

  // 수정 버튼 클릭 시 해당 attendanceNo 기반으로 데이터 fetch
  document.querySelectorAll('.edit-attendance-btn').forEach(button => {
    button.addEventListener('click', () => {
      const attendanceNo = button.getAttribute('data-attendance-no');

      document.getElementById('attendanceNo').value = attendanceNo; // attendanceNo input에 값 세팅
      
      fetch(`/admin/attendanceDetail?attendanceNo=${attendanceNo}`)
        .then(res => res.json())
        .then(data => {
          // 날짜+시간 값을 input[type="datetime-local"]에 맞춰 세팅
          const checkIn = data.attendance_check_in_time?.replace(' ', 'T') || '';
          const checkOut = data.attendance_check_out_time?.replace(' ', 'T') || '';

          // input 값 세팅
          checkInInput.value = checkIn;
          checkOutInput.value = checkOut;

          // originalData 설정 (나중에 비교 용도)
          originalData.checkInTime = checkIn;
          originalData.checkOutTime = checkOut;

          // 상태 표시 텍스트 설정
          document.getElementById('lateStatus').textContent = data.attendance_late_yn === 'Y' ? '지각' : '';
          document.getElementById('earlyLeaveStatus').textContent = data.attendance_early_leave_yn === 'Y' ? '조퇴' : '';
        });
    });
  });

  // 퇴근시간이 출근시간보다 이전이면 오류 모달 표시
  checkOutInput.addEventListener('change', () => {
    const inTime = checkInInput.value;
    const outTime = checkOutInput.value;

    if (inTime && outTime && new Date(outTime) < new Date(inTime)) {
      // 유효하지 않은 경우 경고 모달 표시, 입력값 초기화 
      invalidModal.show();
      checkOutInput.value = ''; // 퇴근시간 초기화
    }
  });

  // 닫기 또는 취소 시 변경 여부 확인
  const closeBtns = [
    editModal.querySelector('.btn-close'), // 모달 상단의 X버튼
   document.getElementById('cancelEditBtn') // 푸터의 취소 버튼
  ];

  closeBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault(); // 기본 닫기 방지
      // 초 단위를 제거해서 datetime 값을 비교하기 위한 헬퍼 함수
      // datetime-local input의 값은 'yyyy-MM-ddTHH:mm' 형식이며, 일부 상황에서 초(:ss)까지 붙는 경우가 있음
      // substring(0, 16)을 사용하면 'yyyy-MM-ddTHH:mm'까지만 잘라서 비교할 수 있음
      const trimSeconds = (datetimeStr) => datetimeStr.length >= 16 ? datetimeStr.substring(0, 16) : datetimeStr;
      // 현재 입력된 출근 시간과 퇴근 시간을 input에서 가져와 초 단위를 제거한 문자열로 변환
      const nowIn = trimSeconds(checkInInput.value);
      const nowOut = trimSeconds(checkOutInput.value);
      
      const originalIn = trimSeconds(originalData.checkInTime);
      const originalOut = trimSeconds(originalData.checkOutTime);     
     // 초 단위 차이(예: 09:00:00 vs 09:00)로 인해 false positives를 방지
    const isModified = (nowIn !== originalIn || nowOut !== originalOut);

      if (isModified) {
    	  // e.preventDefault(); // 기본 동작 방지
    	// 변경 내역이 있을 경우 경고 모달 표시  
        alertModal.show();
        // 현재 editModal에 prevent-close 클래스를 추가하여 닫기 방지
        editModal.classList.add('prevent-close');
      } else {
    	// 변경 없으면 모달 닫기
        bsEditModal.hide();
      }
    });
  });

  // 경고 모달 "예" → 닫기 실행
  document.getElementById('confirmCloseBtn').addEventListener('click', () => {
    alertModal.hide();
    bsEditModal.hide();
    editModal.classList.remove('prevent-close');
  });

  // 경고 모달 "아니오" → 수정 모달 유지
  document.getElementById('stayModalBtn').addEventListener('click', () => {
    alertModal.hide();
    // 닫혔을 경우에 대비해 prevent-close 클래스를 제거하고 다시 열기
    if (editModal.classList.contains('prevent-close')) {
      bsEditModal.show();
      editModal.classList.remove('prevent-close');
    }
  });

	// 수정 모달의 수정하기 버튼 클릭 -> confirm모달 열기
	const editSubmitBtn = document.getElementById('editSubmitBtn');
	const confirmModalEl = document.getElementById('confirmSaveModal');
	const confirmModal = bootstrap.Modal.getOrCreateInstance(confirmModalEl);
	editSubmitBtn.addEventListener('click', function (e) {
		e.preventDefault(); // 기본 동작 방지
		// 모달 열기
		confirmModal.show();
	});

	// confirm모달 취소 버튼 클릭 시 confirm 모달만 닫기
	document.getElementById('cancelSaveBtn').addEventListener('click', function () {
	  confirmModal.hide();
	  bsEditModal.hide(); // 수정 모달도 함께 닫기
	});
	// confirm모달 확인 버튼 클릭 -> fetch요청
	// 수정하기 버튼 클릭 시 폼 제출
		document.getElementById('confirmSaveBtn').addEventListener('click',function(e){
			 console.log("수정 버튼 클릭됨");
			 e.preventDefault();
			// confirm 모달 닫기
			confirmModal.hide();
			
			
			const form = document.getElementById('editAttendanceForm');
			const payload = new FormData(form);
			console.log("폼 데이터:", [...payload.entries()]);
			fetch('/admin/attendanceUpdate',{
				method: 'POST',
				headers:{
				      'header': document.querySelector('meta[name="_csrf_header"]').content,
				      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content			
				},
				body: payload
			})
			.then(response => response.json())
			.then(data => {
				
				console.log("=== 서버 응답 ===");
				  console.log(data);
				// 알림 메세지 모달에 서버응답(res_msg) 출력
				showAlertModal(data.res_msg, function(){
					if(data.res_code == 200){
						const employeeNo = document.getElementById('employeeNo').value;
						location.reload(); // 페이지 새로고침
						 console.log("페이지 리로드됨");
					}
				});
			})
			.catch(error => {
				console.error('Error:', error);
				showAlertModal("정보 수정 중 오류가 발생했습니다.");
			});
		});
});
</script>                         

</main>
</body>
</html>